<!DOCTYPE html>
<html lang="es">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   Título de tu Página - GAD
  </title>
  <script src="https://cdn.tailwindcss.com">
  </script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
  <style>
   body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            overflow-y: auto;
        }
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            text-align: center;
        }
        .gad-logo-header {
            width: 160px; /* Tamaño del logo del index.html */
            height: 160px; /* Tamaño del logo del index.html */
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .main-header {
            background-color: #1d4ed8; /* Color de fondo del index */
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.5rem 0;
        }
        .gad-logo-header img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .main-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1;
            width: 100%;
            padding: 0px;
            box-sizing: border-box;
        }

        /* Estilos del pie de página */
        footer {
            text-align: center;
            width: 100%;
            padding: 1.5rem 0;
            background-color: #e5e7eb;
        }
        
        /* Estilos de los botones de navegación */
        .navigation-buttons-row {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 1rem 0;
            margin-top: 0.75rem;
            gap: 0.75rem;
        }
        .navigation-button {
            padding: 0.5rem 0.5rem;
            font-size: 1rem;
            flex-grow: 0;
        }
        .yellow-button {
            background-color: #facc15;
            color: #333;
            font-weight: bold;
            padding: 10px 15px;
            border-radius: 8px;
            text-decoration: none;
            transition: background-color 0.2s;
            text-align: center;
        }
        .yellow-button:hover {
            background-color: #eab308;
        }
  </style>
 </head>
 <body class="bg-gray-100">
  <header class="main-header">
   <div class="gad-logo-header">
    <img alt="Logo GAD" class="w-full h-full object-cover block" src="logogad.png"/>
   </div>
  </header>
  <main>
   <div class="p-6 bg-white rounded-lg shadow-md mt-4 w-full max-w-2xl text-center">
    <h1 class="text-black text-center mt-6 text-xl font-bold px-4">
     Buscador de Enlaces por País
    </h1>
    <div class="w-11/12 max-w-md mx-auto mt-4" id="countrySearchContainer">
     <p class="text-center mt-2 px-4 mb-2">
      Introduce el nombre de un país para encontrar sus enlaces.
     </p>
     <select class="block mx-auto mt-4 p-2 text-base w-full border border-gray-300 rounded-lg" id="paises" onchange="buscar(this.value)">
      <option value="">
       -- Seleccionar país --
      </option>
     </select>
    </div>
    <div class="mt-6 p-4 bg-white shadow rounded-lg w-11/12 max-w-md mx-auto text-left" id="linkList" style="display:none;">
     <h2 class="text-xl font-bold mb-2 text-center" id="resultsTitle">
     </h2>
     <div id="linksContainer">
     </div>
     <button class="block mx-auto mt-4 w-full bg-red-500 text-white font-bold py-3 rounded-md hover:bg-red-600 transition" onclick="volverAtras()">
      ← Volver
     </button>
    </div>
    <div class="bg-white shadow-md rounded-lg p-6 mt-4 text-center w-11/12 max-w-md mx-auto">
     <h3 class="text-lg font-semibold mb-4">
      Añadir nuevos enlaces
     </h3>
     <button class="w-full bg-green-600 text-white py-2 rounded-md shadow hover:bg-green-700" id="toggleFormBtn" onclick="toggleFormulario()">
      Introduzca nuevo enlace
     </button>
     <div class="mt-4 form-container" id="formularioEnlace">
      <div class="mb-4 text-left">
       <label class="block text-sm font-bold text-gray-700 mb-1" for="nuevoPais">
        País:
       </label>
       <input class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="nuevoPais" placeholder="Ej: ALEMANIA" type="text"/>
      </div>
      <div class="mb-4 text-left">
       <label class="block text-sm font-bold text-gray-700 mb-1" for="nuevaDescripcion">
        Descripción:
       </label>
       <input class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="nuevaDescripcion" placeholder="Ej: Verificación de ITV" type="text"/>
      </div>
      <div class="mb-4 text-left">
       <label class="block text-sm font-bold text-gray-700 mb-1" for="nuevaUrl">
        URL:
       </label>
       <input class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" id="nuevaUrl" placeholder="Ej: https://ejemplo.com" type="url"/>
      </div>
      <button class="w-full bg-blue-600 text-white py-2 rounded-md shadow hover:bg-blue-700" onclick="guardarNuevoEnlace()">
       Guardar
      </button>
     </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js">
    </script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js">
    </script>
    <script>
     const firebaseConfig = {
            apiKey: "AIzaSyCbrIC_qmnXN0YFTVjNGR-j_Zpq_6V_glA",
            authDomain: "gad-alicante-f0d56.firebaseapp.com",
            databaseURL: "https://gad-alicante-f0d56-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gad-alicante-f0d56",
            storageBucket: "gad-alicante-f0d56.firebasestorage.app",
            messagingSenderId: "453863147861",
            appId: "1:453863147861:web:50be7eb436bbee6ec4c7dc"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const enlacesRef = database.ref('enlaces_osint');

        const paisesSelect = document.getElementById('paises');
        const linkList = document.getElementById('linkList');
        const resultsTitle = document.getElementById('resultsTitle');
        const linksContainer = document.getElementById('linksContainer');
        const defaultLinkStatus = 'activo';

        let enlacesData = {};

        enlacesRef.on('value', (snapshot) => {
            enlacesData = snapshot.val() || {};
            const paises = Object.keys(enlacesData).sort();
            paisesSelect.innerHTML = '<option value="">-- Seleccionar país --</option>';
            paises.forEach(pais => {
                const option = document.createElement('option');
                option.value = pais;
                option.textContent = pais;
                paisesSelect.appendChild(option);
            });
        });

        window.buscar = function(pais) {
            linksContainer.innerHTML = '';
            if (!pais) {
                linkList.style.display = 'none';
                return;
            }

            linkList.style.display = 'block';
            let results = enlacesData[pais];
            let title = `Enlaces de ${pais}`;
            resultsTitle.textContent = title;

            if (results) {
                Object.entries(results).forEach(([key, link]) => {
                    const linkItem = document.createElement('div');
                    linkItem.classList.add('bg-white', 'p-4', 'shadow-md', 'rounded-lg', 'mb-4', 'relative');
                    
                    const linkAnchor = document.createElement('a');
                    linkAnchor.href = link.url;
                    linkAnchor.target = "_blank";
                    linkAnchor.rel = "noreferrer";
                    linkAnchor.classList.add('block', 'mb-2');
                    
                    const linkTitle = document.createElement('h3');
                    linkTitle.classList.add('font-bold');
                    linkTitle.textContent = link.nombre;
                    
                    const linkDescription = document.createElement('p');
                    linkDescription.classList.add('text-sm', 'text-gray-600');
                    linkDescription.textContent = link.descripcion;

                    linkAnchor.appendChild(linkTitle);
                    linkAnchor.appendChild(linkDescription);

                    if (link.status === 'caido') {
                        linkAnchor.classList.add('text-red-600');
                    } else {
                        linkAnchor.classList.add('text-blue-600');
                    }
                    
                    linkItem.appendChild(linkAnchor);

                    const statusContainer = document.createElement('div');
                    statusContainer.classList.add('flex', 'flex-col', 'sm:flex-row', 'items-center', 'justify-center', 'space-y-2', 'sm:space-y-0', 'sm:space-x-4', 'mt-2');

                    const statusSpan = document.createElement('span');
                    statusSpan.classList.add('font-bold', 'text-center');
                    
                    const corregirButton = document.createElement('button');
                    corregirButton.classList.add('text-white', 'font-bold', 'py-1', 'px-2', 'rounded-md', 'transition', 'cursor-pointer');

                    const deleteButton = document.createElement('button');
                    deleteButton.classList.add('bg-yellow-400', 'text-red-600', 'font-bold', 'py-1', 'px-2', 'rounded-md', 'transition');
                    deleteButton.textContent = 'ELIMINAR';
                    deleteButton.onclick = () => eliminarEnlace(pais, key);

                    if (link.status === 'caido') {
                        statusSpan.textContent = 'Estado: Link Inactivo';
                        statusSpan.classList.add('text-red-600');
                        corregirButton.textContent = 'Activar Link';
                        corregirButton.classList.add('bg-green-600', 'hover:bg-green-700');
                        corregirButton.onclick = () => toggleLinkStatus(pais, key, 'activo');
                        
                        const corregirEnlaceBtn = document.createElement('button');
                        corregirEnlaceBtn.textContent = 'Corregir Enlace';
                        corregirEnlaceBtn.classList.add('bg-gray-500', 'hover:bg-gray-600', 'text-white', 'font-bold', 'py-1', 'px-2', 'rounded-md', 'transition', 'ml-2');
                        corregirEnlaceBtn.onclick = () => toggleEditForm(linkItem, true);

                        statusContainer.appendChild(statusSpan);
                        statusContainer.appendChild(corregirButton);
                        statusContainer.appendChild(corregirEnlaceBtn);
                        statusContainer.appendChild(deleteButton);
                    } else {
                        statusSpan.textContent = 'Estado: Activo';
                        statusSpan.classList.add('text-green-600');
                        corregirButton.textContent = 'CORREGIR';
                        corregirButton.classList.add('bg-red-500', 'hover:bg-red-600');
                        corregirButton.onclick = () => toggleLinkStatus(pais, key, 'caido');
                        
                        statusContainer.appendChild(statusSpan);
                        statusContainer.appendChild(corregirButton);
                        statusContainer.appendChild(deleteButton);
                    }

                    linkItem.appendChild(statusContainer);

                    const editFormContainer = document.createElement('div');
                    editFormContainer.classList.add('mt-4', 'form-container');
                    
                    editFormContainer.innerHTML = `
                        <div class="mb-2 text-left">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Corregir Nombre:</label>
                            <input type="text" value="${link.nombre}" class="edit-nombre w-full border border-gray-300 rounded-lg px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="mb-2 text-left">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Corregir URL:</label>
                            <input type="url" value="${link.url}" class="edit-url w-full border border-gray-300 rounded-lg px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="mb-2 text-left">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Corregir Descripción:</label>
                            <input type="text" value="${link.descripcion}" class="edit-descripcion w-full border border-gray-300 rounded-lg px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button onclick="saveEditedLink('${pais}', '${key}')" class="w-full bg-blue-600 text-white py-2 rounded-md shadow hover:bg-blue-700">
                            Guardar Corrección
                        </button>
                    `;
                    linkItem.appendChild(editFormContainer);
                    linksContainer.appendChild(linkItem);
                });
            } else {
                linksContainer.innerHTML = `<p class="text-center text-gray-500">No se encontraron enlaces para la búsqueda.</p>`;
            }
        };

        window.toggleLinkStatus = function(pais, key, status) {
            enlacesRef.child(pais).child(key).update({ status: status })
                .then(() => {
                    console.log(`Estado de link actualizado a ${status} en Firebase.`);
                    buscar(pais);
                })
                .catch(error => {
                    console.error("Error al actualizar el estado:", error);
                });
        };

        window.eliminarEnlace = function(pais, key) {
            if (confirm("¿Estás seguro de que quieres eliminar este enlace? Esta acción es permanente.")) {
                enlacesRef.child(pais).child(key).remove()
                    .then(() => {
                        alert("Enlace eliminado con éxito.");
                        console.log("Enlace eliminado de Firebase.");
                        buscar(pais);
                    })
                    .catch(error => {
                        console.error("Error al eliminar el enlace:", error);
                        alert("Hubo un error al eliminar el enlace.");
                    });
            }
        };

        window.toggleEditForm = function(linkItem, show) {
            const formContainer = linkItem.querySelector('.form-container');
            if (show) {
                formContainer.style.display = 'block';
                formContainer.classList.add('active');
            } else {
                formContainer.style.display = 'none';
                formContainer.classList.remove('active');
            }
        };
        
        window.saveEditedLink = function(pais, key) {
            const linkElement = document.querySelector(`[onclick="saveEditedLink('${pais}', '${key}')"]`).closest('.bg-white');
            const nuevoNombre = linkElement.querySelector('.edit-nombre').value.trim();
            const nuevaUrl = linkElement.querySelector('.edit-url').value.trim();
            const nuevaDescripcion = linkElement.querySelector('.edit-descripcion').value.trim();
            
            if (!nuevoNombre || !nuevaUrl || !nuevaDescripcion) {
                alert("Por favor, rellena todos los campos del formulario de corrección.");
                return;
            }

            const updatedLink = {
                nombre: nuevoNombre,
                url: nuevaUrl,
                descripcion: nuevaDescripcion,
                status: defaultLinkStatus
            };
            
            enlacesRef.child(pais).child(key).update(updatedLink)
                .then(() => {
                    console.log("Enlace corregido y guardado con éxito.");
                    buscar(pais);
                })
                .catch(error => {
                    console.error("Error al guardar la corrección:", error);
                });
        };

        window.volverAtras = function() {
            linkList.style.display = 'none';
            paisesSelect.value = '';
        };

        window.toggleFormulario = function() {
            const formulario = document.getElementById('formularioEnlace');
            const toggleBtn = document.getElementById('toggleFormBtn');
            formulario.classList.toggle('active');
            if (formulario.classList.contains('active')) {
                formulario.style.display = 'block';
                toggleBtn.textContent = 'Ocultar formulario';
            } else {
                formulario.style.display = 'none';
                toggleBtn.textContent = 'Introduzca nuevo enlace';
            }
        };

        window.guardarNuevoEnlace = function() {
            const pais = document.getElementById('nuevoPais').value.trim().toUpperCase();
            const descripcion = document.getElementById('nuevaDescripcion').value.trim();
            const url = document.getElementById('nuevaUrl').value.trim();

            if (!pais || !descripcion || !url) {
                alert("Por favor, rellena todos los campos.");
                return;
            }

            const nuevoEnlace = {
                nombre: descripcion, 
                url: url,
                descripcion: descripcion,
                status: defaultLinkStatus
            };

            const paisRef = enlacesRef.child(pais);
            
            paisRef.push(nuevoEnlace)
                .then(() => {
                    alert("¡Enlace guardado con éxito!");
                    document.getElementById('nuevoPais').value = '';
                    document.getElementById('nuevaDescripcion').value = '';
                    document.getElementById('nuevaUrl').value = '';
                    toggleFormulario();
                })
                .catch(error => {
                    console.error("Error al guardar el enlace:", error);
                    alert("Hubo un error al guardar el enlace.");
                });
        };
    </script>
   </div>
   <div class="navigation-buttons-row">
    <a class="yellow-button navigation-button w-40" href="index.html">
     Menú Principal
    </a>
    <button class="yellow-button navigation-button w-40" onclick="window.history.back()">
     Atrás
    </button>
   </div>
  </main>
  <footer class="mt-auto text-center py-6 bg-gray-200">
   <div class="flex flex-col items-center">
    <hr class="border-t border-gray-400 w-11/12 max-w-md mx-auto mb-4"/>
    <p class="font-bold">
     GRUPO DE ANÁLISIS DOCUMENTAL
    </p>
    <p class="font-bold">
     POLICÍA LOCAL DE ALICANTE
    </p>
    <p>
     © GAD - Todos los derechos reservados
    </p>
   </div>
  </footer>
 </body>
</html>
