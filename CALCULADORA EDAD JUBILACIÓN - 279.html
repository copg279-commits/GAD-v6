<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Jubilación Policía Local - Personalizada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }
        .countdown-box {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="gradient-header text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                
                <!-- Title & Logo -->
                <div class="flex items-center gap-4">
                    <div class="bg-white/10 p-2 rounded-full">
                        <i class="fa-solid fa-shield-halved text-3xl md:text-4xl text-yellow-400"></i>
                    </div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold leading-tight">Calculadora Jubilación <br class="md:hidden">Policía Local</h1>
                        <p class="text-blue-100 text-xs md:text-sm opacity-90">Personalizada: Objetivo 2031</p>
                    </div>
                </div>

                <!-- NEW: Countdown Widget (Visible en la zona azul) -->
                <div id="headerCountdown" class="hidden countdown-box rounded-xl p-3 flex flex-row md:flex-col items-center justify-between md:justify-center gap-4 md:gap-1 min-w-[160px] animate-fade-in">
                    <div class="text-left md:text-center">
                        <span class="text-[10px] md:text-xs text-blue-100 uppercase tracking-wider font-bold block">Tiempo Restante</span>
                        <span class="text-[10px] text-blue-200 block md:hidden">para jubilación</span>
                    </div>
                    <div class="text-right md:text-center">
                        <div class="text-3xl md:text-4xl font-bold text-yellow-400 leading-none tabular-nums" id="daysRemainingDisplay">---</div>
                        <span class="text-xs text-white font-medium">días</span>
                    </div>
                </div>

            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8">
        
        <div class="grid md:grid-cols-2 gap-8">
            
            <!-- Form Section -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100 h-fit">
                <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
                    <i class="fa-solid fa-user-pen text-blue-600"></i> Tus Datos (Precargados)
                </h2>

                <form id="calcForm" class="space-y-5">
                    
                    <!-- Fecha Nacimiento -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Nacimiento</label>
                        <input type="date" id="dob" required value="1971-12-04"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition font-medium text-gray-800">
                    </div>

                    <!-- Fecha Ingreso -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Ingreso en Policía Local</label>
                        <input type="date" id="entryDate" required value="1994-03-03"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition font-medium text-gray-800">
                    </div>

                    <!-- Cotización Previa -->
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 relative overflow-hidden">
                        <div class="absolute right-0 top-0 p-2 opacity-10">
                             <i class="fa-solid fa-briefcase text-6xl text-blue-800"></i>
                        </div>
                        <h3 class="text-sm font-semibold text-blue-800 mb-3 border-b border-blue-200 pb-2 relative z-10">Cotización Previa</h3>
                        <div class="relative z-10">
                            <label class="block text-sm font-medium text-blue-700 mb-1">Días Totales Cotizados</label>
                            <input type="number" id="prevTotalDays" value="589" min="0" 
                                class="w-full px-3 py-2 border border-blue-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-lg font-mono font-bold text-blue-900">
                            <p class="text-xs text-blue-600 mt-1">Días previos indicados (sin mili).</p>
                        </div>
                    </div>

                    <!-- Service Mili -->
                    <div class="flex items-center gap-3 bg-gray-50 p-3 rounded-lg border border-gray-200 opacity-75">
                        <input type="checkbox" id="mili" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                        <label for="mili" class="text-sm text-gray-600 select-none cursor-pointer">
                            Sumar 1 año de Servicio Militar
                            <span class="block text-xs text-gray-400">(Opcional: solo si faltase carencia)</span>
                        </label>
                    </div>

                    <button type="submit" id="submitBtn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 flex justify-center items-center gap-2">
                        <i class="fa-solid fa-rotate"></i> Recalcular
                    </button>
                </form>
            </div>

            <!-- Results Section -->
            <div id="resultCard" class="hidden bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden relative transition-all duration-500 ease-out transform translate-y-4 opacity-0">
                <div class="bg-gray-800 text-white p-4 flex justify-between items-center">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fa-solid fa-calendar-check"></i> Tu Estimación
                    </h2>
                    <span class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300">Oficial</span>
                </div>
                
                <div class="p-6 space-y-6">
                    
                    <!-- Main Result -->
                    <div class="text-center bg-gradient-to-br from-blue-50 to-white p-6 rounded-xl border border-blue-200 shadow-sm relative">
                        <div class="absolute top-0 right-0 p-2">
                             <span id="targetYearBadge" class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">2031</span>
                        </div>
                        <p class="text-xs text-blue-600 font-bold uppercase tracking-wide mb-1">Fecha Objetivo de Jubilación</p>
                        <p id="resDate" class="text-4xl md:text-5xl font-extrabold text-gray-900 tracking-tight my-2">--/--/----</p>
                        <p id="resAge" class="text-lg text-gray-600 font-medium">-- años y -- meses</p>
                    </div>

                    <!-- Details Grid -->
                    <div class="grid grid-cols-1 gap-3 text-sm">
                        <!-- Progress Bar Logic Visualization -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-end mb-1">
                                <span class="text-xs font-semibold text-gray-500">PROGRESO TIEMPO EFECTIVO</span>
                                <span class="text-xs font-bold text-gray-800"><span id="resEffectiveTime">--</span> / 38.5 años</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                                <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-[10px] text-gray-500 leading-tight">
                                Necesitas llegar a <strong>38.5 años efectivos</strong> para que tu edad base baje de 67 a 65 años.
                                <br>En ese momento exacto, aplicamos tu bonificación.
                            </p>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                             <div class="p-3 bg-green-50 rounded-lg border border-green-100">
                                <span class="block text-green-700 text-xs font-bold uppercase">Bonificación</span>
                                <span id="resBonification" class="font-bold text-green-700 text-xl">--</span>
                                <span class="text-xs text-green-600">años ganados</span>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                <span class="block text-gray-500 text-xs font-bold uppercase">Anticipo Max.</span>
                                <span id="resMaxAnticipation" class="font-bold text-gray-800 text-xl">--</span>
                                <span class="text-xs text-gray-500">años</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State (Hidden quickly) -->
            <div id="placeholderState" class="flex flex-col items-center justify-center text-center p-10 h-full text-gray-400">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4 text-blue-200"></i>
                <p class="text-sm">Calculando tu fecha...</p>
            </div>

        </div>
    </main>

    <script>
        // --- LOGIC AND CONSTANTS ---

        function addMonths(date, months) {
            const d = new Date(date);
            d.setMonth(d.getMonth() + months);
            return d;
        }

        function diffYears(dt1, dt2) {
            let diff = (dt2.getTime() - dt1.getTime()) / (1000 * 60 * 60 * 24 * 365.25);
            return diff;
        }

        function getOrdinaryRetirementParams(year) {
            // Normativa 2027+
            return { requiredYears: 38.5, maxAgeYears: 67, maxAgeMonths: 0 };
        }

        function getRequiredYearsFor6YearAnticipation(year) {
            return 37.0; // Para 2027+
        }

        function performCalculation() {
            // 1. Get Inputs
            const dobInput = document.getElementById('dob').value;
            const entryInput = document.getElementById('entryDate').value;
            
            if(!dobInput || !entryInput) return;

            const dob = new Date(dobInput);
            const entryDate = new Date(entryInput);
            
            const prevTotalDays = parseInt(document.getElementById('prevTotalDays').value) || 0;
            const mili = document.getElementById('mili').checked ? 1 : 0;

            const prevEffectiveYears = prevTotalDays / 365.25;

            // 2. Iteration Strategy
            let checkDate = new Date(); // Start looking from today
            // If today is before 58, start at 58. If passed, start today.
            let minAgeDate = new Date(dob);
            minAgeDate.setFullYear(minAgeDate.getFullYear() + 58);
            
            if (checkDate < minAgeDate) checkDate = minAgeDate;
            
            const maxCheckDate = new Date(dob);
            maxCheckDate.setFullYear(maxCheckDate.getFullYear() + 70);

            let found = false;
            let finalData = {};

            while (checkDate < maxCheckDate && !found) {
                
                let yearsAsPolice = 0;
                if (checkDate > entryDate) {
                    yearsAsPolice = diffYears(entryDate, checkDate);
                }
                
                const bonificationYears = yearsAsPolice * 0.20;
                const effectiveWorkedYears = prevEffectiveYears + yearsAsPolice;
                const totalForAnticipationRule = effectiveWorkedYears + mili + bonificationYears;

                // E. Determine Ordinary Retirement Age 
                const checkYear = checkDate.getFullYear();
                const params = getOrdinaryRetirementParams(checkYear); // Always 2027+ logic for your case

                let ordinaryAgeYears = 65;
                let ordinaryAgeMonths = 0;

                if (effectiveWorkedYears < params.requiredYears) {
                    ordinaryAgeYears = params.maxAgeYears; // 67
                    ordinaryAgeMonths = params.maxAgeMonths;
                } else {
                    ordinaryAgeYears = 65;
                }

                // F. Target Date
                const ordinaryRetirementDate = new Date(dob);
                ordinaryRetirementDate.setFullYear(ordinaryRetirementDate.getFullYear() + ordinaryAgeYears);
                ordinaryRetirementDate.setMonth(ordinaryRetirementDate.getMonth() + ordinaryAgeMonths);

                // G. Check 6-Year Anticipation Rule
                const canAnticipate6 = (totalForAnticipationRule >= 37.0);
                
                // H. Calculate Possible Date (Ordinary - Bonif)
                // BUT capped at Ordinary - MaxAnticipation
                const bonificationAuthMS = bonificationYears * 365.25 * 24 * 60 * 60 * 1000;
                let possibleRetirementDate = new Date(ordinaryRetirementDate.getTime() - bonificationAuthMS);

                const maxAnticYears = canAnticipate6 ? 6 : 5;
                const minAgeLimitDate = new Date(ordinaryRetirementDate);
                minAgeLimitDate.setFullYear(minAgeLimitDate.getFullYear() - maxAnticYears); 

                // The strict rule: You can retire at "Ordinary - Bonification", 
                // BUT never earlier than "Ordinary - 6 (or 5)".
                // AND never earlier than the current checkDate (time flows forward).
                
                let validDate = possibleRetirementDate;
                if (validDate < minAgeLimitDate) validDate = minAgeLimitDate;

                // If our simulation date (checkDate) has reached this valid retirement moment
                if (checkDate >= validDate) {
                    found = true;
                    finalData = {
                        date: checkDate,
                        ageDecimal: diffYears(dob, checkDate),
                        effectiveWorkedYears: effectiveWorkedYears,
                        totalForRule: totalForAnticipationRule,
                        ordinaryParams: { y: ordinaryAgeYears, m: ordinaryAgeMonths },
                        reqEffective: params.requiredYears,
                        can6: canAnticipate6,
                        bonificationYears: bonificationYears
                    };
                }

                checkDate = addMonths(checkDate, 1);
            }

            // 3. Render
            if (found) {
                const resultsDiv = document.getElementById('resultCard');
                resultsDiv.classList.remove('hidden');
                document.getElementById('placeholderState').classList.add('hidden');
                
                // Animation trigger
                setTimeout(() => {
                    resultsDiv.classList.remove('translate-y-4', 'opacity-0');
                }, 50);

                const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                document.getElementById('resDate').innerText = finalData.date.toLocaleDateString('es-ES', options);

                const years = Math.floor(finalData.ageDecimal);
                const months = Math.floor((finalData.ageDecimal - years) * 12);
                document.getElementById('resAge').innerText = `${years} años y ${months} meses`;

                document.getElementById('resEffectiveTime').innerText = finalData.effectiveWorkedYears.toFixed(2);
                document.getElementById('resBonification').innerText = finalData.bonificationYears.toFixed(2);
                document.getElementById('resMaxAnticipation').innerText = finalData.can6 ? "6" : "5";

                // Progress Bar
                const progressPct = Math.min(100, (finalData.effectiveWorkedYears / 38.5) * 100);
                document.getElementById('progressBar').style.width = `${progressPct}%`;
                if(progressPct >= 100) {
                     document.getElementById('progressBar').classList.add('bg-green-500');
                     document.getElementById('progressBar').classList.remove('bg-blue-600');
                }

                // --- HEADER COUNTDOWN UPDATE ---
                const today = new Date();
                const diffTime = finalData.date - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                document.getElementById('daysRemainingDisplay').innerText = diffDays > 0 ? diffDays : "0";
                document.getElementById('headerCountdown').classList.remove('hidden');
            }
        }

        document.getElementById('calcForm').addEventListener('submit', function(e) {
            e.preventDefault();
            performCalculation();
        });

        // AUTO-RUN ON LOAD
        window.addEventListener('load', () => {
            performCalculation();
        });

    </script>
</body>
</html>