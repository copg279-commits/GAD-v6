<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario de Documentos - GAD</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ESTILOS DE LA CABECERA SIMULADA (Ahora Panel de Título) */
        .title-panel-blue {
            background-color: #3b82f6; /* Azul solicitado */
            display: flex;
            justify-content: space-between; /* Para separar el título y el logo */
            align-items: center;
            padding: 20px; 
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
        }
        .title-panel-blue h1 {
            color: white; 
            margin: 0;
            padding: 0;
            font-size: 1.8em;
            display: flex;
            align-items: center;
        }
        .title-panel-blue .header-logo-container {
            width: 80px; /* Tamaño del logo ajustado */
            height: 80px;
        }
        .title-panel-blue .header-logo-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* ESTILOS DEL PIE DE PÁGINA */
        footer {
            background-color: #e0e0e0; 
            text-align: center;
            padding: 20px;
            width: 100%;
            margin-top: auto; 
        }
        footer p {
            margin: 5px 0;
            font-size: 1em; 
            color: #333;
            font-weight: bold;
        }
        
        /* [ ESTILOS BASE Y PANELES - DISEÑO INTEGRADO ] */
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: #f8f9fa; 
            margin: 0; 
            color: #333;
            line-height: 1.6;
            display: flex; 
            flex-direction: column; 
            min-height: 100vh; 
        }
        
        main {
            flex: 1; 
            padding: 15px; 
            display: flex;
            justify-content: center;
            width: 100%; 
        }

        .app-container { 
            max-width: 1300px; 
            width: 100%; 
            margin: 0 auto; 
            display: grid; 
            grid-template-columns: 1fr;
            gap: 20px; 
        }
        .panel {
            background: #ffffff;
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); 
            border: 1px solid #e0e0e0; 
        }
        h1, h2, h3 { 
            color: #2c3e50; 
            padding-bottom: 10px; 
            margin-top: 0; 
            font-weight: 700;
        }
        /* El H1 ahora está en el panel azul */
        h2 { font-size: 1.5em; }
        h3 { font-size: 1.2em; }
        
        /* Controles y Botones (Mantenidos) */
        button { 
            border: none; 
            padding: 10px 15px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: 700; 
            transition: all 0.2s ease-in-out; 
            margin-right: 8px; 
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: white; 
        }
        button i { font-size: 1em; } 
        .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-primary:hover { box-shadow: 0 4px 10px rgba(41, 128, 185, 0.4); }
        .btn-delete { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .btn-delete:hover { box-shadow: 0 4px 10px rgba(192, 57, 43, 0.4); }
        .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .btn-success:hover { box-shadow: 0 4px 10px rgba(39, 174, 96, 0.4); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .btn-warning:hover { box-shadow: 0 4px 10px rgba(230, 126, 34, 0.4); }

        /* Estilos de Botones de Modo de Inventario (Mantenidos) */
        .mode-selection-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            gap: 15px;
        }

        #mode-personas-btn { background: #3498db; }
        #mode-vehiculos-btn { background: #e67e22; }

        /* Estilo para el modo activo */
        #mode-personas-btn.active, #mode-vehiculos-btn.active { 
            background: #27ae60; 
            box-shadow: 0 4px 10px rgba(39, 174, 96, 0.4); 
            border: 2px solid white;
        }

        /* Estilos generales de inputs y selects (Mantenidos) */
        input[type="text"], input[type="number"], input[type="url"], select {
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 8px 12px;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-shadow: inset 0 1px 2px rgba(0,0,0,.075);
            font-size: 0.95em;
            width: 100%; 
            box-sizing: border-box;
        }
        
        /* BÚSQUEDA Y CONTROLES - Estructura mejorada (Mantenidos) */
        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap; 
            gap: 15px; 
        }

        /* Estilos de botones de categoría (Mantenidos) */
        .filter-buttons button { 
            margin-left: 8px; 
        }
        .btn-cat-2400 { background: #e0f2f7; color: #0288d1; border: 1px solid #b3e5fc; }
        .btn-cat-600 { background: #e8f5e9; color: #388e3c; border: 1px solid #c8e6c9; }
        .btn-cat-fisico { background: #fff8e1; color: #fbc02d; border: 1px solid #ffe082; }
        .btn-cat-todos { background: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; }

        .btn-cat-2400.active { background: #03a9f4; color: white; box-shadow: 0 4px 10px rgba(3, 169, 244, 0.4); }
        .btn-cat-600.active { background: #4caf50; color: white; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4); }
        .btn-cat-fisico.active { background: #ffc107; color: white; box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4); }
        .btn-cat-todos.active { background: #f44336; color: white; box-shadow: 0 4px 10px rgba(244, 67, 54, 0.4); }
        
        /* Estilos para el campo obligatorio (Mantenidos) */
        .required-label {
            color: #e74c3c; 
            font-weight: bold;
        }

        /* [ ESTRUCTURA DE CONTROLES DE BÚSQUEDA - Ajustada para Subtipo USA ] */
        .search-controls {
            display: grid;
            /* Añadimos un minmax para el nuevo campo de Subtipo */
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 15px;
            padding: 15px 0;
            align-items: flex-start;
            border-top: 1px solid #e0e0e0;
            padding-top: 20px;
        }

        .search-controls label {
            font-size: 0.85em; 
            font-weight: bold; 
            color: #555;
            margin-bottom: 5px;
            display: block;
        }
        
        .search-controls .align-bottom {
            align-self: flex-end; 
        }

        @media (min-width: 1200px) {
            /* Se ajusta para tener espacio para el nuevo campo en pantallas grandes */
            .search-controls {
                grid-template-columns: 1.5fr 1.5fr 1fr 1fr 1fr 1fr 150px; 
            }
        }

        /* LISTADO HORIZONTAL (TABLA) - Mantenidos */
        .results-container {
            overflow-x: auto; 
            padding-bottom: 10px;
            max-width: 100%;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fdfdfd;
        }
        .results-header, .doc-row {
            /* Definición de columnas para la tabla: Nombre, País, Tipo, Fecha, Categoría, Enlace, Acciones */
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1.5fr 150px; 
            display: grid;
            gap: 15px;
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            min-width: 1000px; 
        }
        .results-header {
            font-weight: bold;
            background: #e9f2f7; 
            border-bottom: 2px solid #3498db;
            border-radius: 8px 8px 0 0;
            position: sticky; 
            top: 0;
            z-index: 10;
            color: #2c3e50;
        }
        .doc-row:nth-child(even) {
            background: #f9f9f9; 
        }
        .doc-row:hover {
            background: #eef4f9;
        }
        .doc-row div {
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis; 
            align-self: center;
        }
        .doc-actions {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
            min-width: 120px; 
        }
        
        /* Estilo específico para el icono de enlace (Mantenidos) */
        .link-icon-container {
            text-align: center;
        }
        .link-icon {
            color: #2ecc71; 
            font-size: 1.2em;
            cursor: pointer;
            text-decoration: none;
            transition: color 0.2s;
            padding: 5px; 
            display: inline-block;
        }
        .link-icon:hover {
            color: #27ae60;
        }
        .link-icon-disabled {
            color: #b0b0b0; 
            cursor: default;
        }
        
        /* [ ESTILOS DEL MODAL MEJORADO - Mantenidos ] */
        .modal {
            position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(3px); 
        }
        .modal-content {
            background-color: #fefefe; 
            padding: 35px; 
            border-radius: 12px; 
            width: 95%; 
            max-width: 600px; 
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.25); 
            animation: fadeInScale 0.3s ease-out; 
            position: relative;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modern-alert {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            background-color: #f0f4f7;
            border: 1px solid #dcdcdc;
            color: #555;
        }
        .modern-alert-error {
            background-color: #fef2f2;
            border-color: #f44336;
        }
        .link-preview {
            background-color: #f0f4f7;
            padding: 8px;
            border-radius: 5px;
            margin-top: 5px;
            font-size: 0.9em;
            color: #7f8c8d;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            pointer-events: none; 
        }
        label {
             display: block; 
             margin-top: 15px; 
             margin-bottom: 5px; 
             font-weight: bold; 
             color: #2c3e50;
        }
        /* Estilo para categoría fija (deshabilitada) */
        .category-fixed-input {
            background-color: #f5f5f5;
            color: #7f8c8d;
            cursor: not-allowed;
            font-weight: bold;
        }

    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>

<body>
    <main>
        <div class="app-container">
            
            <div class="title-panel-blue">
                <h1><i class="fas fa-archive"></i> Inventario de Documentos - GAD</h1>
                <div class="header-logo-container">
                    <img src="logogad.png" alt="Logo GAD"> 
                </div>
            </div>

            <div class="panel">
                <div class="search-header">
                    <h2>🔍 Búsqueda de Documentos (Unificada)</h2>
                    
                    <div class="mode-selection-container">
                        <h4 style="color: #3498db;"><i class="fas fa-database"></i> Modo:</h4>
                        <button id="mode-personas-btn" class="btn-primary active" onclick="setInventoryMode('documentos 600 dpi')" style="width: 150px;"><i class="fas fa-user"></i> PERSONAS</button>
                        <button id="mode-vehiculos-btn" class="btn-warning" onclick="setInventoryMode('vehiculos 600 dpi')" style="width: 150px;"><i class="fas fa-car"></i> VEHÍCULOS</button>
                    </div>
                    <div class="filter-buttons">
                        <button id="filter-2400-btn" class="btn-cat-2400" onclick="setCategoryFilter('ESCANER 2400')">ESCANER 2400</button>
                        <button id="filter-600-btn" class="btn-cat-600" onclick="setCategoryFilter('ESCANER 600')">ESCANER 600</button>
                        <button id="filter-fisico-btn" class="btn-cat-fisico" onclick="setCategoryFilter('FÍSICO')">FÍSICO</button>
                        <button id="filter-todos-btn" class="btn-cat-todos active" onclick="setCategoryFilter('')">TODOS</button>
                    </div>
                </div>
                
                <div class="search-controls">
                    
                    <div>
                        <label>PAÍS (<span class="required-label">OBLIGATORIO</span>):</label>
                        <input list="datalist-countries" type="text" id="search-country" placeholder="Selecciona o añade un país" 
                                onchange="handleCountryChange(this.value); this.value = this.value.toUpperCase()" onfocus="this.value=''" required>
                        <datalist id="datalist-countries"></datalist>
                    </div>

                    <div id="state-region-container" style="display: none;">
                        <label>ESTADO/REGIÓN (Solo USA):</label>
                        <input list="datalist-states" type="text" id="search-state-region" placeholder="Ej: ALASKA, ILLINOIS" onchange="this.value = this.value.toUpperCase()">
                        <datalist id="datalist-states"></datalist>
                    </div>

                    
                    <div>
                        <label>BUSCAR POR NOMBRE:</label>
                        <input type="text" id="search-name-partial" placeholder="Nombre completo o parte">
                    </div>

                    <div>
                        <label>BUSCAR POR TIPO:</label>
                        <input list="datalist-types" type="text" id="search-type" placeholder="Ej: PNC, PSP" onchange="this.value = this.value.toUpperCase()">
                        <datalist id="datalist-types"></datalist>
                    </div>

                    <div>
                        <label>AÑO:</label>
                        <input type="number" id="search-year" placeholder="Año (AAAA)" min="1900" max="3000">
                    </div>
                    
                    <div>
                        <label>MES:</label>
                        <select id="search-month">
                            <option value="">TODOS</option>
                        </select>
                    </div>

                    <div class="align-bottom">
                        <button id="clear-search-btn" class="btn-delete" style="width: 100%;"><i class="fas fa-eraser"></i> Limpiar Filtros</button>
                    </div>
                </div>
                <h3 style="margin-top: 30px;">Resultados <span id="document-count" style="font-size: 0.9em; font-weight: normal; color: #3498db;">(Cargando conteo...)</span></h3>
                
                <div class="results-container">
                    <div id="results-header" class="results-header" style="display: none;">
                        <div>NOMBRE</div>
                        <div>PAÍS</div>
                        <div>TIPO</div>
                        <div>FECHA (AAAA-MM-DD)</div>
                        <div>CATEGORÍA</div>
                        <div style="text-align: center;">ENLACE</div>
                        <div style="text-align: right;">ACCIONES</div>
                    </div>
                    <div id="search-results">
                        <div class="modern-alert">
                            <i class="fas fa-filter fa-2x"></i>
                            <h4 style="color: #3498db; margin-top: 10px;">Búsqueda Restringida</h4>
                            <p>Por favor, introduce el **PAÍS** (<span class="required-label">OBLIGATORIO</span>) para iniciar la búsqueda en el inventario unificado.</p>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </main>
    
    <footer>
        <p>GRUPO DE ANÁLISIS DOCUMENTAL</p>
        <p>POLICÍA LOCAL DE ALICANTE</p>
        <p>© GAD - Todos los derechos reservados</p>
    </footer>
    
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-edit"></i> Editar Documento</h2>
            <form id="edit-document-form">
                <input type="hidden" id="edit-doc-key"> 
                
                <label for="edit-doc-country"><i class="fas fa-globe"></i> País:</label>
                <input list="datalist-countries" type="text" id="edit-doc-country" placeholder="Ej: ESPAÑA" required onchange="this.value = this.value.toUpperCase()">
                
                <div id="edit-state-region-container" style="display: none;">
                    <label for="edit-doc-subtipo"><i class="fas fa-map-marker-alt"></i> Estado/Región (Solo USA):</label>
                    <input list="datalist-states" type="text" id="edit-doc-subtipo" placeholder="Ej: ALASKA" onchange="this.value = this.value.toUpperCase()">
                </div>
                
                <label for="edit-doc-type"><i class="fas fa-tag"></i> Tipo de Documento:</label>
                <input list="datalist-types" type="text" id="edit-doc-type" placeholder="Ej: PSP" required onchange="this.value = this.value.toUpperCase()">
                
                <label for="edit-doc-name"><i class="fas fa-signature"></i> Nombre Documento:</label>
                <input type="text" id="edit-doc-name" placeholder="Título o referencia del documento" required oninput="extractDateFromName('edit-doc-name', 'edit-doc-date-display')">
                <p id="edit-doc-date-display" style="font-size: 0.9em; color: #5dade2; margin-top: 5px;">Fecha extraída: Pendiente...</p>
                <input type="hidden" id="edit-doc-fecha-hidden"> 
                
                <label for="edit-doc-category"><i class="fas fa-archive"></i> Categoría (Fija):</label>
                <select id="edit-doc-category" required disabled class="category-fixed-input" title="La categoría está fija a ESCANER 600 para estos nodos.">
                    <option value="ESCANER 600" selected>ESCANER 600</option>
                    <option value="FÍSICO">FÍSICO</option>
                    <option value="ESCANER 2400">ESCANER 2400</option>
                </select>

                <label for="edit-doc-link"><i class="fas fa-link"></i> Enlace (URL):</label>
                <input type="url" id="edit-doc-link" placeholder="https://..." oninput="updateLinkPreview('edit-doc-link', 'edit-link-preview')">
                <div id="edit-link-preview" class="link-preview">Enlace URL introducido (sin miniatura).</div>
            </form>

            <div style="margin-top: 30px; text-align: right;">
                <button class="btn-primary" onclick="updateDocument()"><i class="fas fa-save"></i> Guardar Cambios</button>
                <button class="btn-delete" onclick="document.getElementById('edit-modal').style.display='none'"><i class="fas fa-times"></i> Cancelar</button>
            </div>
        </div>
    </div>


    <script>
        // **********************************************
        //      ✅ [ CONFIGURACIÓN DE FIREBASE ] 
        // **********************************************
        const firebaseConfig = {
            apiKey: "AIzaSyA6EDUJ2dG50DphB-dF6GLi3P2IlW8lDl4", 
            authDomain: "gad-alicante-v3.firebaseapp.com",
            databaseURL: "https://gad-alicante-v3-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gad-alicante-v3",
            storageBucket: "gad-alicante-v3.firebasestorage.app",
            messagingSenderId: "906986258369",
            appId: "1:906986258369:web:21a7ea29a33b5f395e3940"
        };
        
        let app = null;
        let database = null;

        try {
            app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("✅ Firebase inicializado correctamente.");
        } catch (error) {
            console.error("❌ ERROR CRÍTICO DE FIREBASE:", error.message);
            alert("❌ Error al inicializar Firebase. Revisa tus credenciales.");
        }
        
        // RUTAS ACTUALIZADAS (Según solicitud del usuario)
        const DOCS_REF = 'documentos 600 dpi/'; 
        const VEHICLES_REF = 'vehiculos 600 dpi/'; 
        
        const searchCountryInput = document.getElementById('search-country');
        const searchTypeInput = document.getElementById('search-type');
        const searchYearInput = document.getElementById('search-year');
        const searchMonthSelect = document.getElementById('search-month');
        const searchNamePartialInput = document.getElementById('search-name-partial'); 
        const searchStateRegionInput = document.getElementById('search-state-region'); // Nuevo input de Subtipo
        const stateRegionContainer = document.getElementById('state-region-container'); // Nuevo contenedor de Subtipo
        
        const searchResultsDiv = document.getElementById('search-results');
        const resultsHeader = document.getElementById('results-header');
        const documentCountSpan = document.getElementById('document-count'); 
        
        let currentCategoryFilter = ''; 
        let currentInventoryMode = DOCS_REF; 
        const FIXED_CATEGORY = 'ESCANER 600'; 

        // Constantes de Datos
        const MONTHS = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        // Modificado: Se elimina "EEUU USA" y se mantiene "USA" y "ESTADOS UNIDOS"
        const EUROPEAN_COUNTRIES = [
            "ALEMANIA", "AUSTRIA", "BÉLGICA", "BULGARIA", "CHIPRE", "CROACIA", "DINAMARCA", 
            "ESLOVAQUIA", "ESLOVENIA", "ESPAÑA", "ESTONIA", "FINLANDIA", "FRANCIA", "GRECIA", 
            "HUNGRÍA", "IRLANDA", "ITALIA", "LETONIA", "LITUANIA", "LUXEMBURGO", "MALTA", 
            "PAÍSES BAJOS", "POLONIA", "PORTUGAL", "REPÚBLICA CHECA", "RUMANÍA", "SUECIA", 
            "ESTADOS UNIDOS", "USA", "OTROS" // Se mantienen las variantes USA
        ];
        const PREDEFINED_DOC_TYPES = ["PSP", "CI", "PNC", "PIC", "VEHICULOS", "GENERAL", "CERTIFICADOS"]; 
        let FULL_DOCUMENT_LIST = []; 
        let ALL_DOCUMENTS = []; 
        let UNIQUE_STATES_REGIONS = new Set(); // Conjunto para almacenar estados de USA
        
        // **********************************************
        //           [ LÓGICA DE DATALISTS Y SUBTIPOS ]
        // **********************************************
        
        function populateDatalist(id, items) {
            const datalist = document.getElementById(id);
            if (!datalist) return; 
            
            datalist.innerHTML = '';
            
            const uniqueItems = Array.from(new Set(items.map(item => item.toUpperCase()))).sort();

            uniqueItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                datalist.appendChild(option);
            });
        }
        
        function loadDynamicDatalists() {
            // Países: Default + Existentes
            const existingCountries = new Set(FULL_DOCUMENT_LIST.map(doc => doc.data.Pais).filter(p => p && p !== 'N/A' && p !== 'EEUU USA'));
            const allCountries = [...EUROPEAN_COUNTRIES, ...Array.from(existingCountries)];
            // Limpieza específica de USA
            const finalCountries = Array.from(new Set(allCountries.filter(c => c !== 'EEUU USA'))); 
            populateDatalist('datalist-countries', finalCountries);

            // Tipos: Default + Tipos extraídos
            const existingTypes = new Set(FULL_DOCUMENT_LIST.map(doc => doc.data.TipoDocumento).filter(t => t && t !== 'N/A' && t !== 'GENERAL'));
            const allTypes = [...PREDEFINED_DOC_TYPES, ...Array.from(existingTypes)];
            const uniqueAllTypes = Array.from(new Set(allTypes));
            populateDatalist('datalist-types', uniqueAllTypes);
            
            // Estados/Regiones de USA (Subtipos)
            populateDatalist('datalist-states', Array.from(UNIQUE_STATES_REGIONS));
        }

        /**
         * Maneja el cambio en el campo de País para mostrar/ocultar el campo de Estado/Región.
         */
        window.handleCountryChange = function(countryValue) {
            const country = countryValue.trim().toUpperCase();
            
            // Países que activan el campo de Subtipo/Estado
            const specialCountries = ['USA', 'ESTADOS UNIDOS'];
            
            if (specialCountries.includes(country)) {
                stateRegionContainer.style.display = 'block';
            } else {
                stateRegionContainer.style.display = 'none';
                searchStateRegionInput.value = ''; // Limpiar el campo si el país cambia
            }
            
            filterDocuments(); // Vuelve a filtrar al cambiar el país
        }
        
        // **********************************************
        //               [ GESTIÓN DE MODOS ]
        // **********************************************
        
        window.setInventoryMode = function(mode) {
            const btnPersonas = document.getElementById('mode-personas-btn');
            const btnVehiculos = document.getElementById('mode-vehiculos-btn');
            btnPersonas.classList.remove('active');
            btnVehiculos.classList.remove('active');
            
            currentInventoryMode = mode + '/'; 

            if (mode.includes('vehiculos')) {
                btnVehiculos.classList.add('active');
            } else {
                btnPersonas.classList.add('active');
            }
            
            // Re-evaluar el campo de país
            handleCountryChange(searchCountryInput.value); 
            filterDocuments();
        }

        // *****************************************************************
        // 🚨 FUNCIÓN CLAVE DE LECTURA UNIFICADA Y LÓGICA DE INFERENCIA 🚨
        // *****************************************************************
        
        function loadAllDocuments() {
            if (!database) {
                loadDynamicDatalists();
                searchResultsDiv.innerHTML = `<div class="modern-alert modern-alert-error"><i class="fas fa-exclamation-circle fa-2x"></i><h4 style="color: #e74c3c; margin-top: 10px;">Modo Desconectado</h4><p>No se pudo conectar a la base de datos.</p></div>`;
                updateDocumentCount([]); 
                return;
            }
            
            documentCountSpan.textContent = `(Cargando todo el inventario: Documentos y Vehículos... Por favor, espere.)`;
            FULL_DOCUMENT_LIST = [];
            UNIQUE_STATES_REGIONS.clear();

            const fetchAndProcessNode = (refPath) => {
                return database.ref(refPath).once('value').then(snapshot => {
                    const nestedData = snapshot.val(); 
                    const documents = [];
                    
                    if (!nestedData) return documents;

                    // Itera sobre las claves de primer nivel (ej: ALBANIA_CI, USA_PNC)
                    for (const combinedKey in nestedData) {
                        if (nestedData.hasOwnProperty(combinedKey)) {
                            const innerDocuments = nestedData[combinedKey]; 

                            let inferredCountryFromKey = 'N/A';
                            let inferredTypeFromKey = 'N/A';
                            
                            const lastUnderscoreIndex = combinedKey.lastIndexOf('_'); 
                            if (lastUnderscoreIndex !== -1) {
                                inferredCountryFromKey = combinedKey.substring(0, lastUnderscoreIndex).toUpperCase();
                                inferredTypeFromKey = combinedKey.substring(lastUnderscoreIndex + 1).toUpperCase();
                            } else {
                                inferredCountryFromKey = combinedKey.toUpperCase(); 
                                inferredTypeFromKey = 'GENERAL';
                            }

                            
                            let documentsToProcess = {};
                            let currentInferredType = inferredTypeFromKey;
                            let currentSubnode = null; 

                            // ******************************************************
                            // ✅ LÓGICA CLAVE DE MANEJO DE SUBNODOS (Subtipos/Estados)
                            // ******************************************************

                            // Si el nodo de primer nivel tiene subnodos (como USA_PNC con subnodos de estado)
                            if (inferredCountryFromKey === 'USA' || inferredCountryFromKey === 'ESTADOS UNIDOS') {
                                
                                // Itera sobre los subnodos (ej: ALASKA, ILLINOIS)
                                for (const subNodeKey in innerDocuments) {
                                    if (innerDocuments.hasOwnProperty(subNodeKey)) {
                                        
                                        documentsToProcess = innerDocuments[subNodeKey]; // Aquí están los documentos
                                        currentSubnode = subNodeKey.toUpperCase();
                                        UNIQUE_STATES_REGIONS.add(currentSubnode); // Guarda el subnodo para el datalist

                                        for (const docKey in documentsToProcess) {
                                            if (documentsToProcess.hasOwnProperty(docKey)) {
                                                const data = documentsToProcess[docKey]; 
                                                const doc = processDocument(refPath, combinedKey, currentSubnode, docKey, data, inferredCountryFromKey, currentInferredType);
                                                documents.push(doc);
                                            }
                                        }
                                    }
                                }

                            } else {
                                // Lógica normal para nodos sin subnodos especiales (GENERAL)
                                if (innerDocuments && innerDocuments.GENERAL) {
                                    documentsToProcess = innerDocuments.GENERAL;
                                } else {
                                    documentsToProcess = innerDocuments;
                                }

                                for (const docKey in documentsToProcess) {
                                    if (documentsToProcess.hasOwnProperty(docKey)) {
                                        const data = documentsToProcess[docKey]; 
                                        const doc = processDocument(refPath, combinedKey, null, docKey, data, inferredCountryFromKey, currentInferredType);
                                        documents.push(doc);
                                    }
                                }
                            }
                        }
                    }
                    return documents;
                });
            };
            
            /**
             * Función auxiliar para procesar y normalizar los datos de un documento.
             */
            function processDocument(refPath, combinedKey, subnode, docKey, data, inferredCountry, inferredType) {
                const doc = { 
                    key: refPath + combinedKey + (subnode ? `/${subnode}/` : (data.GENERAL ? '/GENERAL/' : '/')) + docKey, 
                    data: data,
                };
                
                // 1. NORMALIZACIÓN DEL NOMBRE
                let baseName = data.NombreArchivo || data.NombreDocumento || docKey;
                doc.data.NombreDocumento = baseName.replace(/\.(JPG|JPEG|PNG|PDF|DOCX|XLSX)$/i, '').replace(/_/g, ' ').trim();
                
                // 2. PAÍS (prioriza el que ya tenga, sino el inferido de la clave)
                let finalCountry = (data.Pais && data.Pais !== 'N/A' && data.Pais !== 'EEUU USA') ? data.Pais.toUpperCase() : inferredCountry;
                // Normaliza "ESTADOS UNIDOS" a "USA" internamente para simplificar el filtrado si lo desea.
                doc.data.Pais = (finalCountry === 'ESTADOS UNIDOS') ? 'USA' : finalCountry; 
                
                // 3. SUBTIPO DE DOCUMENTO (Usado para USA/Estados)
                doc.data.SubtipoDocumento = subnode || (data.SubtipoDocumento && data.SubtipoDocumento !== 'General' ? data.SubtipoDocumento.toUpperCase() : 'N/A');

                // 4. TIPO DE DOCUMENTO
                let finalType = (data.TipoDocumento && data.TipoDocumento !== 'N/A' && data.TipoDocumento !== 'GENERAL') 
                    ? data.TipoDocumento.toUpperCase() 
                    : inferredType; 

                if (finalType === 'GENERAL' || finalType === 'N/A' || finalType === inferredCountry) {
                    const typeFromName = extractTypeFromName(doc.data.NombreDocumento);
                    if (typeFromName !== 'GENERAL' && typeFromName.length > 1) { 
                        finalType = typeFromName;
                    }
                }
                doc.data.TipoDocumento = finalType;

                // 5. FECHA (Extraer del NombreDocumento)
                doc.data.Fecha = extractDateFromName('dummy-input', 'dummy-display', doc.data.NombreDocumento) || 'N/A';
                
                // 6. CATEGORÍA FIJA 
                doc.data.Categoria = FIXED_CATEGORY; 
                
                // 7. Enlace
                doc.data.Enlace = data.Enlace || 'N/A';

                return doc;
            }

            // Ejecuta la carga en paralelo y procesa los resultados
            Promise.all([
                fetchAndProcessNode(DOCS_REF),
                fetchAndProcessNode(VEHICLES_REF)
            ]).then(([docList, vehicleList]) => {
                FULL_DOCUMENT_LIST = [...docList, ...vehicleList];
                
                console.log(`✅ Documentos cargados. Total: ${FULL_DOCUMENT_LIST.length} (Docs: ${docList.length}, Veh: ${vehicleList.length})`);
                
                loadDynamicDatalists();
                setCategoryFilter(currentCategoryFilter); 
                
            }).catch(errorObject => {
                console.error("❌ Error al leer de Firebase:", errorObject.code, errorObject.message);
                document.getElementById('search-results').innerHTML = `
                    <div class="modern-alert modern-alert-error">
                        <i class="fas fa-exclamation-circle fa-2x"></i>
                        <h4 style="color: #e74c3c; margin-top: 10px;">Error de Conexión o Permisos</h4>
                        <p>No se pudo leer la base de datos. Por favor, revisa las **Reglas de Seguridad** o el **Nombre del Nodo**.</p>
                    </div>
                 `;
                 updateDocumentCount([]);
            });
        }
        
        // **********************************************
        //               [ FUNCIONES DE LÓGICA Y CRUD ]
        // **********************************************
        
        // Mantener las funciones extractDateFromName y extractTypeFromName (se omiten para brevedad, pero están presentes en el código completo)
        
        window.extractDateFromName = function(nameInputId, dateDisplayId, nameString = null) {
            const name = (nameString !== null ? nameString : document.getElementById(nameInputId).value.trim()).toUpperCase();
            const display = document.getElementById(dateDisplayId);

            // Busca patrones de fecha
            const dateMatch = name.match(/(\d{4}[-/]\d{2}[-/]\d{2})|(\d{4}\d{2}\d{2})|(\d{4}(?:\s|-|\.|$))/);
            
            let normalizedDate = null;
            let displayValue = 'Pendiente...';
            
            if (dateMatch) {
                let dateStr = dateMatch[0]; 

                if (dateMatch[1]) { // AAAA-MM-DD o AAAA/MM/DD
                    normalizedDate = dateMatch[1].replace(/(\d{4})\D(\d{2})\D(\d{2})/, '$1-$2-$3'); 
                    displayValue = `Fecha extraída: ${normalizedDate}`;
                } else if (dateMatch[2]) { // AAAAMMDD
                    normalizedDate = dateMatch[2].substring(0, 4) + '-' + dateMatch[2].substring(4, 6) + '-' + dateMatch[2].substring(6, 8);
                    displayValue = `Fecha extraída: ${normalizedDate}`;
                } else if (dateMatch[3]) { // Solo año AAAA
                    normalizedDate = dateMatch[3].substring(0, 4) + '-01-01'; 
                    displayValue = `Fecha extraída (Año): ${normalizedDate.substring(0,4)}`;
                }
            }

            if (display && nameString === null) {
                display.textContent = displayValue;
                display.style.color = normalizedDate ? '#27ae60' : '#e74c3c';
            }
            
            if (nameInputId.includes('edit-doc') && nameString === null) {
                document.getElementById('edit-doc-fecha-hidden').value = normalizedDate || '';
            }
            
            return normalizedDate;
        }

        window.extractTypeFromName = function(name) {
            if (!name) return 'GENERAL';
            name = name.toUpperCase().trim();
            
            name = name.replace(/\.(JPG|JPEG|PNG|PDF|DOCX|XLSX)$/, '').trim();

            const yearMatch = name.match(/(\d{4})/);
            let potentialTypePart = name;

            if (yearMatch) {
                potentialTypePart = name.substring(0, yearMatch.index).trim();
            }
            
            const words = potentialTypePart.split(/[^a-zA-Z0-9]+/).filter(w => w.length > 0);
            
            if (words.length > 0) {
                const lastWord = words[words.length - 1];
                if (lastWord.length > 1 && lastWord.length <= 6 && !/\d/.test(lastWord)) { 
                    return lastWord;
                }
            }
            
            return 'GENERAL';
        }

        function updateDocumentCount(currentResults) {
            const totalDocs = FULL_DOCUMENT_LIST.length;
            
            let countText = '';
            
            const totalCategoryDocs = currentCategoryFilter 
                ? FULL_DOCUMENT_LIST.filter(doc => (doc.data.Categoria || FIXED_CATEGORY) === currentCategoryFilter).length
                : totalDocs;
                
            if (currentResults.length > 0) {
                const categoryInfo = currentCategoryFilter ? `(Cat: ${totalCategoryDocs})` : '';
                countText = `(${currentResults.length} de ${totalCategoryDocs} encontrados)`;
            } else if (totalDocs === 0) {
                 countText = `(0 documentos en el inventario)`;
            } else if (searchCountryInput.value.trim()) {
                countText = `(0 resultados. Total en Categoría: ${totalCategoryDocs})`;
            } else {
                if (currentCategoryFilter) {
                    countText = `(Total Inventario: ${totalDocs} | Categoría ${currentCategoryFilter}: ${totalCategoryDocs})`;
                } else {
                    countText = `(${totalDocs} documentos totales en el inventario unificado)`;
                }
            }
            
            documentCountSpan.textContent = countText;
        }
        
        window.setCategoryFilter = function(category) {
            currentCategoryFilter = category;
            
            document.querySelectorAll('.filter-buttons button').forEach(btn => btn.classList.remove('active'));

            if (category === 'ESCANER 2400') {
                document.getElementById('filter-2400-btn').classList.add('active');
            } else if (category === 'ESCANER 600') {
                document.getElementById('filter-600-btn').classList.add('active');
            } else if (category === 'FÍSICO') {
                document.getElementById('filter-fisico-btn').classList.add('active');
            } else {
                document.getElementById('filter-todos-btn').classList.add('active');
            }
            
            ALL_DOCUMENTS = FULL_DOCUMENT_LIST.filter(doc => {
                const docCategory = doc.data.Categoria || FIXED_CATEGORY; 
                return !category || docCategory === category;
            });

            filterDocuments();
        }

        function renderDocRow(key, data) {
            const row = document.createElement('div');
            row.classList.add('doc-row');
            
            const linkUrl = data.Enlace && data.Enlace !== 'N/A' ? data.Enlace : '#';
            const linkTarget = data.Enlace && data.Enlace !== 'N/A' ? '_blank' : '';
            const linkIsAvailable = data.Enlace && data.Enlace !== 'N/A';
            
            const displayDate = data.Fecha && data.Fecha.length >= 7 ? data.Fecha : 'N/A'; 
            const displayCategory = data.Categoria || FIXED_CATEGORY; 
            
            const linkIconHtml = linkIsAvailable
                ? `<a href="${linkUrl}" target="${linkTarget}" class="link-icon" title="Ver archivo"><i class="fas fa-eye"></i></a>`
                : `<i class="fas fa-eye link-icon-disabled" title="Enlace no disponible"></i>`;

            // Muestra el subtipo/estado en la columna de PAÍS si es USA
            let displayCountry = data.Pais;
            if (data.Pais === 'USA' && data.SubtipoDocumento && data.SubtipoDocumento !== 'N/A') {
                displayCountry = `${data.Pais} (${data.SubtipoDocumento})`;
            }

            // Estructura solicitada: NOMBRE | PAÍS | TIPO | FECHA | CATEGORÍA | ENLACE (Icono) | ACCIONES
            row.innerHTML = `
                <div>${data.NombreDocumento || 'S/N'}</div>
                <div>${displayCountry}</div> 
                <div>${data.TipoDocumento}</div>
                <div>${displayDate}</div>
                <div>${displayCategory}</div>
                <div class="link-icon-container">${linkIconHtml}</div>
                <div class="doc-actions">
                    <button class="btn-warning" onclick="openEditModal('${key}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-delete" onclick="deleteDocument('${key}', '${data.NombreDocumento || 'este documento'}')"><i class="fas fa-trash"></i></button>
                </div>
            `;
            return row;
        }

        function filterDocuments() {
            const countryQ = searchCountryInput.value.trim().toUpperCase();
            const typeQ = searchTypeInput.value.trim().toUpperCase();
            const yearQ = searchYearInput.value.trim();
            const monthQ = searchMonthSelect.value;
            const namePartialQ = searchNamePartialInput.value.trim().toUpperCase(); 
            const stateRegionQ = searchStateRegionInput.value.trim().toUpperCase(); // Nuevo filtro de estado/región
            
            searchResultsDiv.innerHTML = '';
            resultsHeader.style.display = 'none'; 
            
            if (!countryQ) {
                searchResultsDiv.innerHTML = `
                    <div class="modern-alert">
                        <i class="fas fa-filter fa-2x"></i>
                        <h4 style="color: #3498db; margin-top: 10px;">Búsqueda Restringida</h4>
                        <p>Por favor, introduce el **PAÍS** (<span class="required-label">OBLIGATORIO</span>) para iniciar la búsqueda en el inventario unificado.</p>
                    </div>
                `;
                updateDocumentCount([]); 
                return;
            }

            let matchFound = false;

            const filtered = ALL_DOCUMENTS.filter(doc => {
                const data = doc.data;
                
                const docFecha = data.Fecha || ''; 
                const docYear = docFecha.substring(0, 4);
                const docMonth = docFecha.substring(5, 7);
                const docName = data.NombreDocumento ? data.NombreDocumento.toUpperCase() : '';
                const docType = data.TipoDocumento ? data.TipoDocumento.toUpperCase() : 'GENERAL'; 
                const docPais = data.Pais ? data.Pais.toUpperCase() : 'N/A'; 
                const docSubtipo = data.SubtipoDocumento ? data.SubtipoDocumento.toUpperCase() : 'N/A'; // Nuevo dato

                // Filtro por MODO
                const isVehiculo = doc.key.startsWith(VEHICLES_REF);

                if (currentInventoryMode === VEHICLES_REF) {
                    if (!isVehiculo) return false;
                } else if (currentInventoryMode === DOCS_REF) {
                    if (isVehiculo) return false;
                }

                // 1. FILTRO PAÍS (Obligatorio y principal)
                // Se normaliza 'ESTADOS UNIDOS' a 'USA'
                const normalizedCountryQ = countryQ === 'ESTADOS UNIDOS' ? 'USA' : countryQ;
                if (docPais.indexOf(normalizedCountryQ) === -1) return false;

                // 2. FILTRO ESTADO/REGIÓN (Solo si el país es USA)
                const isUSACountry = (countryQ === 'USA' || countryQ === 'ESTADOS UNIDOS');
                if (isUSACountry && stateRegionQ) {
                    if (docSubtipo.indexOf(stateRegionQ) === -1) return false;
                }

                // 3. FILTROS OPCIONALES
                if (typeQ && docType.indexOf(typeQ) === -1) return false; 
                if (yearQ && docYear.indexOf(yearQ) === -1) return false;
                if (monthQ && docMonth !== monthQ) return false;
                if (namePartialQ && docName.indexOf(namePartialQ) === -1) return false;
                
                return true;
            });
            
            if (filtered.length > 0) {
                resultsHeader.style.display = 'grid'; 
                
                filtered.sort((a, b) => a.data.NombreDocumento.localeCompare(b.data.NombreDocumento));
                
                filtered.forEach(doc => {
                    searchResultsDiv.appendChild(renderDocRow(doc.key, doc.data));
                });
                matchFound = true;
            }

            if (!matchFound) {
                 searchResultsDiv.innerHTML = `
                    <div class="modern-alert modern-alert-error">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <h4 style="color: #e67e22; margin-top: 10px;">Sin Resultados</h4>
                        <p>No se encontraron documentos que coincidan con los filtros aplicados en el modo activo.</p>
                    </div>
                 `;
            }
            
            updateDocumentCount(filtered); 
        }
        
        function clearSearch() {
            searchCountryInput.value = '';
            searchTypeInput.value = '';
            searchYearInput.value = '';
            searchMonthSelect.value = '';
            searchNamePartialInput.value = ''; 
            searchStateRegionInput.value = ''; 
            
            handleCountryChange(''); // Oculta el campo de estado
            
            currentCategoryFilter = ''; 
            document.querySelectorAll('.filter-buttons button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter-todos-btn').classList.add('active');
            
            setCategoryFilter(currentCategoryFilter);
        }
        
        window.openEditModal = function(fullKey) {
             if (!database) return alert("❌ No hay conexión a Firebase. No se puede editar.");
             
            const doc = FULL_DOCUMENT_LIST.find(d => d.key === fullKey);
            if (!doc) return alert("Error: Documento no encontrado.");
            
            const data = doc.data;
            const editModal = document.getElementById('edit-modal');
            const editStateContainer = document.getElementById('edit-state-region-container');
            const editSubtipoInput = document.getElementById('edit-doc-subtipo');
            
            document.getElementById('edit-doc-key').value = fullKey;
            document.getElementById('edit-doc-country').value = data.Pais;
            document.getElementById('edit-doc-type').value = data.TipoDocumento;
            document.getElementById('edit-doc-name').value = data.NombreDocumento;
            document.getElementById('edit-doc-category').value = FIXED_CATEGORY; 
            document.getElementById('edit-doc-link').value = data.Enlace === 'N/A' ? '' : data.Enlace;
            
            extractDateFromName('edit-doc-name', 'edit-doc-date-display', data.NombreDocumento); 
            updateLinkPreview('edit-doc-link', 'edit-link-preview');

            // Lógica para mostrar/ocultar Subtipo en el Modal
            if (data.Pais === 'USA' || data.Pais === 'ESTADOS UNIDOS') {
                editStateContainer.style.display = 'block';
                editSubtipoInput.value = data.SubtipoDocumento === 'N/A' ? '' : data.SubtipoDocumento;
            } else {
                editStateContainer.style.display = 'none';
                editSubtipoInput.value = '';
            }

            editModal.style.display = 'flex';
        }

        window.updateDocument = async function() {
            if (!database) {
                 alert("❌ No hay conexión a Firebase. No se puede actualizar el documento.");
                 return;
            }
             
            const fullKey = document.getElementById('edit-doc-key').value; 
            const pais = document.getElementById('edit-doc-country').value.trim().toUpperCase();
            const tipo = document.getElementById('edit-doc-type').value.trim().toUpperCase();
            const nombre = document.getElementById('edit-doc-name').value.trim();
            const subtipo = document.getElementById('edit-doc-subtipo').value.trim().toUpperCase() || 'N/A'; // Nuevo dato
            const categoria = FIXED_CATEGORY; 
            const enlace = document.getElementById('edit-doc-link').value.trim();

            const fechaCompleta = extractDateFromName('edit-doc-name', 'edit-doc-date-display');

            if (!pais || !tipo || !nombre) {
                alert("⚠️ Por favor, rellena País, Tipo y Nombre del Documento.");
                return;
            }
            if (!fechaCompleta) {
                 alert("⚠️ No se pudo extraer la fecha del nombre. Por favor, revisa el nombre.");
                 return;
            }
            
            const updatedData = {
                Pais: (pais === 'ESTADOS UNIDOS') ? 'USA' : pais,
                TipoDocumento: tipo,
                NombreDocumento: nombre,
                SubtipoDocumento: subtipo, // Se añade el Subtipo
                Fecha: fechaCompleta, 
                Categoria: categoria, 
                Enlace: enlace || 'N/A',
                Timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            try {
                // Hay que manejar la posibilidad de que se cambie el país o el subtipo, lo que implica mover el nodo
                // **Nota:** Para simplificar el código sin reestructurar la BBDD, solo actualizamos los valores.
                // Si la estructura del nodo debe cambiar (ej: de ESPAÑA_PSP a USA_PNC/ALASKA), se requeriría más lógica de mover/eliminar/crear.
                // Asumo que solo se actualizan los campos dentro del nodo existente por ahora.
                await database.ref(fullKey).update(updatedData); 
                alert("✅ Documento actualizado correctamente!");
                document.getElementById('edit-modal').style.display = 'none';
                loadAllDocuments(); 
            } catch (error) {
                alert("❌ Error al actualizar el documento: " + error.message);
            }
        }
        
        window.deleteDocument = async function(fullKey, name) {
            if (!database) {
                 alert("❌ No hay conexión a Firebase. No se puede eliminar el documento.");
                 return;
            }
             
            if (confirm(`¿Estás seguro de que quieres eliminar DEFINITIVAMENTE el documento "${name}"? Esta acción no se puede deshacer.`)) {
                try {
                    await database.ref(fullKey).remove();
                    loadAllDocuments(); 
                    alert(`✅ Documento "${name}" eliminado.`);
                } catch (error) {
                     alert("❌ Error al eliminar el documento: " + error.message);
                }
            }
        }
        
        // **********************************************
        //               [ INICIALIZACIÓN ]
        // **********************************************

        function enableDatalistDropdown(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('focus', function() {
                    this.dispatchEvent(new KeyboardEvent('keydown', { key: 'ArrowDown', keyCode: 40, bubbles: true }));
                });
            }
        }

        function populateSelectors() {
            const monthSelectors = [document.getElementById('search-month')];
            MONTHS.forEach((month, index) => {
                const value = (index + 1).toString().padStart(2, '0');
                monthSelectors.forEach((selector) => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = month;
                    selector.appendChild(option);
                });
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            
            populateSelectors(); 
            
            populateDatalist('datalist-countries', EUROPEAN_COUNTRIES);
            populateDatalist('datalist-types', PREDEFINED_DOC_TYPES);
            
            setInventoryMode('documentos 600 dpi'); 
            loadAllDocuments(); 
            
            enableDatalistDropdown('search-country');
            enableDatalistDropdown('search-type');
            enableDatalistDropdown('search-state-region'); // Nuevo datalist para Estados
            
            // Eventos de cierre de modales
            document.getElementById('edit-modal').addEventListener('click', (event) => {
                if (event.target === document.getElementById('edit-modal')) { 
                    document.getElementById('edit-modal').style.display = "none";
                }
            });
            
            // Eventos de Búsqueda (Input en vivo)
            // searchCountryInput ya tiene handleCountryChange en el onchange.
            searchTypeInput.addEventListener('input', filterDocuments);
            searchYearInput.addEventListener('input', filterDocuments);
            searchMonthSelect.addEventListener('change', filterDocuments);
            searchNamePartialInput.addEventListener('input', filterDocuments); 
            searchStateRegionInput.addEventListener('input', filterDocuments); // Nuevo evento de filtro
            document.getElementById('clear-search-btn').addEventListener('click', clearSearch);
            
        });
    </script>
</body>
</html>