/**
 * Este archivo contiene la l√≥gica para sincronizar los metadatos de los archivos
 * de una carpeta espec√≠fica de Google Drive directamente con Firebase Realtime Database.
 * * * MEJORAS APLICADAS (Para la sincronizaci√≥n de Drive):
 * 1. La clave 'ID_ARCHIVO_DRIVE' ha sido incluida (esencial para Drive).
 * 2. La clave 'Categoria' se guarda como "ESCANER 600" (igual que en el script original).
 * 3. El nodo de destino en Firebase es '/vehiculos' (solicitado).
 * 4. Los campos 'Pais' y 'TipoDocumento' se infieren con valores por defecto ya que no provienen de una Hoja.
 */

// =========================================================================
// CONFIGURACI√ìN DE FIREBASE Y DRIVE
// =========================================================================
const FIREBASE_URL = "https://gad-alicante-v3-default-rtdb.europe-west1.firebasedatabase.app"; 
const FIREBASE_SECRET = "mxfkSXOgQIySNWYfl6bg7buBCA4Jeph36mVNheTp"; 

// üí° Nuevo nodo solicitado por el usuario
const FIREBASE_NODE = "vehiculos"; 

// üí° ID de la carpeta de Google Drive a buscar
const DRIVE_FOLDER_ID = "1T8TgWuqYuvrqBhk1QBV3J6kRt02dR_fv"; 
// =========================================================================


/**
 * Crea el men√∫ '‚öôÔ∏è INVENTARIO VEH√çCULOS' en la Hoja al abrirla.
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  // El nombre del men√∫ es una ETIQUETA.
  ui.createMenu('‚öôÔ∏è INVENTARIO VEH√çCULOS') 
      .addItem('Sincronizar Archivos Drive con Firebase', 'syncDriveFilesToFirebase')
      .addToUi();
}


/**
 * Funci√≥n principal que lee los archivos de la carpeta de Drive y 
 * los env√≠a al nodo '/vehiculos' de Firebase.
 */
function syncDriveFilesToFirebase() {
    
    // Asignaci√≥n de categor√≠a fija solicitada
    const categoriaFija = "ESCANER 600";
    
    // Valores por defecto ya que no hay Hoja de C√°lculo para obtenerlos
    const paisPorDefecto = "ESPA√ëA_DRIVE";
    const tipoDocumentoPorDefecto = "DOCUMENTO_VEHICULO"; 
    
    const firebasePayload = {};
    let recordCount = 0;
    
    try {
        // 1. Obtener la carpeta de Google Drive
        const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
        // 2. Obtener un iterador para todos los archivos dentro de la carpeta
        const files = folder.getFiles(); 
        
        while (files.hasNext()) {
            const file = files.next();
            
            // Obtener y formatear la fecha de creaci√≥n del archivo (AAAA-MM)
            let dateKey = 'N/A';
            try {
                const dateObject = file.getDateCreated();
                const fullDateString = Utilities.formatDate(dateObject, "GMT", "yyyy-MM-dd"); 
                dateKey = fullDateString.substring(0, 7); 
            } catch(e) {
                dateKey = 'N/A';
            }
            
            const recordKey = file.getId(); // Usar el ID del archivo como clave √∫nica
            
            firebasePayload[recordKey] = {
                Pais: paisPorDefecto,
                TipoDocumento: tipoDocumentoPorDefecto,
                NombreDocumento: file.getName(),
                Fecha: dateKey,
                Categoria: categoriaFija, 
                Enlace: file.getUrl(),
                ID_ARCHIVO_DRIVE: file.getId(), // üí° Incluido nuevamente
                Timestamp: new Date().getTime() 
            };
            recordCount++;
        }

        // 3. Env√≠o a Firebase
        const url = `${FIREBASE_URL}/${FIREBASE_NODE}.json?auth=${FIREBASE_SECRET}`;
        const options = {
            method: "put", // 'put' para sobrescribir o crear el nodo con el nuevo JSON
            contentType: "application/json",
            payload: JSON.stringify(firebasePayload),
            muteHttpExceptions: true
        };

        const response = UrlFetchApp.fetch(url, options);
        const code = response.getResponseCode();
        
        if (code === 200) {
            Browser.msgBox(`‚úÖ √âXITO: ${recordCount} documentos de veh√≠culos sincronizados con Firebase en el nodo /${FIREBASE_NODE}.`);
        } else {
            const error = JSON.parse(response.getContentText());
            Browser.msgBox(`‚ùå ERROR (${code}): Fallo. Revise la clave. Mensaje: ${JSON.stringify(error)}`);
        }
        
    } catch(e) {
        // Manejar errores de conexi√≥n o de ID de carpeta inv√°lido
        Browser.msgBox(`‚ùå ERROR FATAL: No se pudo conectar o acceder a la carpeta de Drive. Mensaje: ${e.toString()}`);
    }
}