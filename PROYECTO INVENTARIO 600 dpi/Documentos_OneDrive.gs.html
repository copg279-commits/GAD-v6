/**
 * Este archivo contiene la lógica para sincronizar los datos de la Hoja de Cálculo
 * de Google directamente con Firebase Realtime Database.
 * * * CORRECCIÓN DE ERRORES:
 * 1. Incluye las constantes FIREBASE_URL y FIREBASE_SECRET.
 * 2. Implementa sanitizeKey() para evitar el error 400 de caracteres no válidos.
 * * * ESTRUCTURA FINAL:
 * /documentos/PAIS TIPODOCUMENTO/{documento_único}
 */

// =========================================================================
// CONFIGURACIÓN DE FIREBASE (¡Necesaria y global!)
// =========================================================================
const FIREBASE_URL = "https://gad-alicante-v3-default-rtdb.europe-west1.firebasedatabase.app"; 
const FIREBASE_SECRET = "mxfkSXOgQIySNWYfl6bg7buBCA4Jeph36mVnheTp"; 
// =========================================================================


/**
 * Elimina caracteres no válidos de Firebase de una clave: $ # [ ] / .
 * @param {string} key La cadena de texto a sanear.
 * @return {string} La clave saneada.
 */
function sanitizeKey(key) {
    // Elimina los caracteres prohibidos en las claves de Firebase
    return key.replace(/[\$\#\[\]\/\.]/g, '').trim(); 
}


/**
 * Crea el menú '⚙️ INVENTARIO FIREBASE' en la Hoja al abrirla.
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('⚙️ INVENTARIO FIREBASE') 
      .addItem('Sincronizar Datos con Firebase', 'syncSheetToFirebase')
      .addToUi();
}


/**
 * Función principal que lee las filas de la Hoja y las envía a Firebase.
 */
function syncSheetToFirebase() {
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    // Columnas B, C, D, E, F desde la fila 2.
    const range = sheet.getRange(2, 2, sheet.getLastRow() - 1, 5); 
    const data = range.getValues(); 
    
    const firebasePayload = {};
    let recordCount = 0;
    
    data.forEach((row, index) => {
        // Validación de filas antes de procesar
        if (row[0].toString().trim() === "" || row[3].toString().trim() === "") return;

        let dateKey = 'N/A';
        if (row[2]) {
            try {
                const dateObject = new Date(row[2]);
                const fullDateString = Utilities.formatDate(dateObject, "GMT", "yyyy-MM-dd"); 
                dateKey = fullDateString.substring(0, 7); 
            } catch(e) {
                dateKey = 'N/A';
            }
        }
        
        const categoriaFija = "ESCANER 600";
        
        // SANEAMIENTO APLICADO AQUÍ
        const pais = sanitizeKey(row[0].toString().toUpperCase());
        const tipoDocumento = sanitizeKey(row[3].toString().toUpperCase());

        // Si el saneamiento dejó alguna de las partes vacía, saltamos la fila
        if (pais === "" || tipoDocumento === "") return; 

        // -----------------------------------------------------------------
        // CONSTRUCCIÓN DE LA CLAVE COMBINADA EXPANDIBLE
        const combinedKey = `${pais} ${tipoDocumento}`;
        const uniqueDocKey = `doc_${index + 2}`; 
        
        // Inicializa la clave combinada como un OBJETO para que sea EXPANDIBLE
        if (!firebasePayload[combinedKey]) {
            firebasePayload[combinedKey] = {}; 
        }
        
        // Asigna el documento al sub-nodo único
        firebasePayload[combinedKey][uniqueDocKey] = {
            Pais: pais,
            TipoDocumento: tipoDocumento,
            NombreDocumento: row[1].toString().trim(),
            Fecha: dateKey,
            Categoria: categoriaFija, 
            Enlace: row[4].toString().trim() || 'N/A',
            Timestamp: new Date().getTime()
        };
        // -----------------------------------------------------------------
        
        recordCount++;
    });
    

    // Envío a Firebase (PUT sobrescribe TODO el nodo /documentos)
    const url = `${FIREBASE_URL}/documentos.json?auth=${FIREBASE_SECRET}`;
    const options = {
        method: "put", 
        contentType: "application/json",
        payload: JSON.stringify(firebasePayload),
        muteHttpExceptions: true
    };

    try {
        const response = UrlFetchApp.fetch(url, options);
        const code = response.getResponseCode();
        
        if (code === 200) {
            Browser.msgBox(`✅ ÉXITO: ${recordCount} documentos sincronizados con Firebase. Las claves combinadas son expansibles.`);
        } else {
            const error = JSON.parse(response.getContentText());
            Browser.msgBox(`❌ ERROR (${code}): Fallo. Revise la clave. Mensaje: ${JSON.stringify(error)}`);
        }
    } catch(e) {
        Browser.msgBox(`❌ ERROR FATAL: No se pudo conectar. Mensaje: ${e.toString()}`);
    }
}/**
 * Este archivo contiene la lógica para sincronizar los datos de la Hoja de Cálculo
 * de Google directamente con Firebase Realtime Database.
 * * * CORRECCIÓN DE ERRORES:
 * 1. Incluye las constantes FIREBASE_URL y FIREBASE_SECRET.
 * 2. Implementa sanitizeKey() para evitar el error 400 de caracteres no válidos.
 * * * ESTRUCTURA FINAL:
 * /documentos/PAIS TIPODOCUMENTO/{documento_único}
 */

// =========================================================================
// CONFIGURACIÓN DE FIREBASE (¡Necesaria y global!)
// =========================================================================
const FIREBASE_URL = "https://gad-alicante-v3-default-rtdb.europe-west1.firebasedatabase.app"; 
const FIREBASE_SECRET = "mxfkSXOgQIySNWYfl6bg7buBCA4Jeph36mVnheTp"; 
// =========================================================================


/**
 * Elimina caracteres no válidos de Firebase de una clave: $ # [ ] / .
 * @param {string} key La cadena de texto a sanear.
 * @return {string} La clave saneada.
 */
function sanitizeKey(key) {
    // Elimina los caracteres prohibidos en las claves de Firebase
    return key.replace(/[\$\#\[\]\/\.]/g, '').trim(); 
}


/**
 * Crea el menú '⚙️ INVENTARIO FIREBASE' en la Hoja al abrirla.
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('⚙️ INVENTARIO FIREBASE') 
      .addItem('Sincronizar Datos con Firebase', 'syncSheetToFirebase')
      .addToUi();
}


/**
 * Función principal que lee las filas de la Hoja y las envía a Firebase.
 */
function syncSheetToFirebase() {
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    // Columnas B, C, D, E, F desde la fila 2.
    const range = sheet.getRange(2, 2, sheet.getLastRow() - 1, 5); 
    const data = range.getValues(); 
    
    const firebasePayload = {};
    let recordCount = 0;
    
    data.forEach((row, index) => {
        // Validación de filas antes de procesar
        if (row[0].toString().trim() === "" || row[3].toString().trim() === "") return;

        let dateKey = 'N/A';
        if (row[2]) {
            try {
                const dateObject = new Date(row[2]);
                const fullDateString = Utilities.formatDate(dateObject, "GMT", "yyyy-MM-dd"); 
                dateKey = fullDateString.substring(0, 7); 
            } catch(e) {
                dateKey = 'N/A';
            }
        }
        
        const categoriaFija = "ESCANER 600";
        
        // SANEAMIENTO APLICADO AQUÍ
        const pais = sanitizeKey(row[0].toString().toUpperCase());
        const tipoDocumento = sanitizeKey(row[3].toString().toUpperCase());

        // Si el saneamiento dejó alguna de las partes vacía, saltamos la fila
        if (pais === "" || tipoDocumento === "") return; 

        // -----------------------------------------------------------------
        // CONSTRUCCIÓN DE LA CLAVE COMBINADA EXPANDIBLE
        const combinedKey = `${pais} ${tipoDocumento}`;
        const uniqueDocKey = `doc_${index + 2}`; 
        
        // Inicializa la clave combinada como un OBJETO para que sea EXPANDIBLE
        if (!firebasePayload[combinedKey]) {
            firebasePayload[combinedKey] = {}; 
        }
        
        // Asigna el documento al sub-nodo único
        firebasePayload[combinedKey][uniqueDocKey] = {
            Pais: pais,
            TipoDocumento: tipoDocumento,
            NombreDocumento: row[1].toString().trim(),
            Fecha: dateKey,
            Categoria: categoriaFija, 
            Enlace: row[4].toString().trim() || 'N/A',
            Timestamp: new Date().getTime()
        };
        // -----------------------------------------------------------------
        
        recordCount++;
    });
    

    // Envío a Firebase (PUT sobrescribe TODO el nodo /documentos)
    const url = `${FIREBASE_URL}/documentos.json?auth=${FIREBASE_SECRET}`;
    const options = {
        method: "put", 
        contentType: "application/json",
        payload: JSON.stringify(firebasePayload),
        muteHttpExceptions: true
    };

    try {
        const response = UrlFetchApp.fetch(url, options);
        const code = response.getResponseCode();
        
        if (code === 200) {
            Browser.msgBox(`✅ ÉXITO: ${recordCount} documentos sincronizados con Firebase. Las claves combinadas son expansibles.`);
        } else {
            const error = JSON.parse(response.getContentText());
            Browser.msgBox(`❌ ERROR (${code}): Fallo. Revise la clave. Mensaje: ${JSON.stringify(error)}`);
        }
    } catch(e) {
        Browser.msgBox(`❌ ERROR FATAL: No se pudo conectar. Mensaje: ${e.toString()}`);
    }
}