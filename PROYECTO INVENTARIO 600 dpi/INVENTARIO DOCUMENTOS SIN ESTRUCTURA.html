<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario de Documentos - GAD</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* [ ESTILOS BASE Y PANELES - DISE√ëO INTEGRADO ] */
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: #f8f9fa; 
            margin: 0; 
            padding: 15px; 
            color: #333;
            line-height: 1.6;
        }
        .app-container { 
            max-width: 1300px; 
            margin: 0 auto; 
            display: grid; 
            grid-template-columns: 1fr;
            gap: 20px; 
        }
        .panel {
            background: #ffffff;
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); 
            border: 1px solid #e0e0e0; 
        }
        h1, h2, h3 { 
            color: #2c3e50; 
            padding-bottom: 10px; 
            margin-top: 0; 
            font-weight: 700;
        }
        h1 { font-size: 1.8em; }
        h2 { font-size: 1.5em; }
        h3 { font-size: 1.2em; }
        
        /* Controles y Botones */
        button { 
            border: none; 
            padding: 10px 15px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: 700; 
            transition: all 0.2s ease-in-out; 
            margin-right: 8px; 
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        button i { font-size: 1em; } 
        .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .btn-primary:hover { box-shadow: 0 4px 10px rgba(41, 128, 185, 0.4); }
        .btn-delete { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .btn-delete:hover { box-shadow: 0 4px 10px rgba(192, 57, 43, 0.4); }
        .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; }
        .btn-success:hover { box-shadow: 0 4px 10px rgba(39, 174, 96, 0.4); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .btn-warning:hover { box-shadow: 0 4px 10px rgba(230, 126, 34, 0.4); }

        /* Estilos generales de inputs y selects */
        input[type="text"], input[type="number"], input[type="url"], select {
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 8px 12px;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-shadow: inset 0 1px 2px rgba(0,0,0,.075);
            font-size: 0.95em;
            width: 100%; /* Asegurar que ocupen el 100% de su contenedor */
            box-sizing: border-box;
        }
        
        /* B√öSQUEDA Y CONTROLES - Estructura mejorada */
        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap; 
            gap: 15px; 
        }
        
        /* Colores de los botones de categor√≠a */
        .btn-cat-2400 { background: #e0f2f7; color: #0288d1; border: 1px solid #b3e5fc; }
        .btn-cat-600 { background: #e8f5e9; color: #388e3c; border: 1px solid #c8e6c9; }
        .btn-cat-fisico { background: #fff8e1; color: #fbc02d; border: 1px solid #ffe082; }
        .btn-cat-todos { background: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; }

        .btn-cat-2400.active { background: #03a9f4; color: white; box-shadow: 0 4px 10px rgba(3, 169, 244, 0.4); }
        .btn-cat-600.active { background: #4caf50; color: white; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4); }
        .btn-cat-fisico.active { background: #ffc107; color: white; box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4); }
        .btn-cat-todos.active { background: #f44336; color: white; box-shadow: 0 4px 10px rgba(244, 67, 54, 0.4); }
        
        /* Estilos para el campo obligatorio (ROJO) */
        .required-label {
            color: #e74c3c; 
            font-weight: bold;
        }

        /* Modificaci√≥n de la cuadr√≠cula de b√∫squeda para la disposici√≥n vertical sugerida */
        .search-controls {
            display: grid;
            grid-template-columns: 1fr; /* Una sola columna principal para la estructura vertical */
            gap: 20px; /* M√°s espacio entre secciones */
            padding: 15px 0;
            align-items: flex-start;
        }

        /* Estilo para los grupos de campos */
        .search-group {
            border: 1px solid #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            background: #fcfcfc;
        }

        .search-group h4 {
            margin-top: 0;
            color: #3498db;
            border-bottom: 1px dashed #dcdcdc;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        /* Campos dentro del grupo */
        .search-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Adaptable dentro del grupo */
            gap: 15px;
        }
        
        .search-controls label {
            font-size: 0.85em; 
            font-weight: bold; 
            color: #555;
            margin-bottom: 5px;
            display: block;
        }

        /* Asegurar que el bot√≥n de limpiar filtros se alinea correctamente */
        .search-controls .align-bottom {
            align-self: flex-end;
        }

        /* Media Query para una mejor vista en desktop (3 columnas) */
        @media (min-width: 900px) {
            .search-controls {
                /* Pa√≠s (Col 1), Opciones de B√∫squeda (Col 2), Bot√≥n (Col 3) */
                grid-template-columns: 1fr 1fr 150px; 
            }
            .search-group.country-group {
                grid-column: 1 / 2;
            }
            .search-group.optional-search {
                grid-column: 2 / 3;
            }
            .search-controls .align-bottom {
                grid-column: 3 / 4;
            }
        }


        /* LISTADO HORIZONTAL (TABLA) */
        .results-container {
            overflow-x: auto; 
            padding-bottom: 10px;
            max-width: 100%;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fdfdfd;
        }
        .results-header, .doc-row {
            display: grid;
            /* 7 COLUMNAS: Nombre | Pa√≠s | Tipo | Fecha | Categor√≠a | Enlace | Acciones (Botones) */
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1.5fr 150px; 
            gap: 15px;
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            min-width: 1000px; 
        }
        .results-header {
            font-weight: bold;
            background: #e9f2f7; 
            border-bottom: 2px solid #3498db;
            border-radius: 8px 8px 0 0;
            position: sticky; 
            top: 0;
            z-index: 10;
            color: #2c3e50;
        }
        .doc-row:nth-child(even) {
            background: #f9f9f9; 
        }
        .doc-row:hover {
            background: #eef4f9;
        }
        .doc-row div {
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis; 
            align-self: center;
        }
        .doc-actions {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
            min-width: 120px; 
        }
        
        /* [ ESTILOS DEL MODAL MEJORADO - DISE√ëO PROFESIONAL ] */
        .modal {
            position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(3px); 
        }
        .modal-content {
            background-color: #fefefe; 
            padding: 35px; 
            border-radius: 12px; 
            width: 95%; 
            max-width: 600px; 
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.25); 
            animation: fadeInScale 0.3s ease-out; 
            position: relative;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        /* ... (El resto de estilos de modales y alertas se mantienen) ... */
        .modern-alert {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            background-color: #f0f4f7;
            border: 1px solid #dcdcdc;
            color: #555;
        }
        .modern-alert-error {
            background-color: #fef2f2;
            border-color: #f44336;
        }
        .link-preview {
            background-color: #f0f4f7;
            padding: 8px;
            border-radius: 5px;
            margin-top: 5px;
            font-size: 0.9em;
            color: #7f8c8d;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            pointer-events: none; /* Deshabilita el click en el div */
        }
        label {
             display: block; 
             margin-top: 15px; 
             margin-bottom: 5px; 
             font-weight: bold; 
             color: #2c3e50;
        }

    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>

<body>
    <div class="app-container">
        <div class="panel" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <h1><i class="fas fa-archive"></i> Inventario de Documentos - GAD</h1>
            <button id="open-modal-btn" class="btn-success" style="padding: 12px 25px;"><i class="fas fa-plus-circle"></i> A√ëADIR NUEVO DOCUMENTO</button>
        </div>

        <div class="panel">
            <div class="search-header">
                <h2>üîç B√∫squeda de Documentos</h2>
                <div class="filter-buttons">
                    <button id="filter-2400-btn" class="btn-cat-2400" onclick="setCategoryFilter('ESCANER 2400')">ESCANER 2400</button>
                    <button id="filter-600-btn" class="btn-cat-600" onclick="setCategoryFilter('ESCANER 600')">ESCANER 600</button>
                    <button id="filter-fisico-btn" class="btn-cat-fisico" onclick="setCategoryFilter('F√çSICO')">F√çSICO</button>
                    <button id="filter-todos-btn" class="btn-cat-todos active" onclick="setCategoryFilter('')">TODOS</button>
                </div>
            </div>
            
            <div class="search-controls">
                <div class="search-group country-group">
                    <h4><i class="fas fa-globe"></i> 1. Pa√≠s (<span class="required-label">OBLIGATORIO</span>)</h4>
                    <div class="search-fields">
                        <div>
                            <label>PA√çS:</label>
                            <input list="datalist-countries" type="text" id="search-country" placeholder="Selecciona o a√±ade un pa√≠s" onchange="this.value = this.value.toUpperCase()" required>
                            <datalist id="datalist-countries"></datalist>
                        </div>
                    </div>
                </div>
                
                <div class="search-group optional-search">
                    <h4><i class="fas fa-search"></i> 2. Opciones de B√∫squeda (Elige **NOMBRE** O **TIPO** y **A√ëO**)</h4>
                    <div style="display: grid; gap: 15px;">
                        <div class="search-fields">
                             <div>
                                <label>BUSQUE POR NOMBRE DEL DOCUMENTO:</label>
                                <input type="text" id="search-name-partial" placeholder="Escribe el nombre completo o parte">
                            </div>
                        </div>
                        
                        <div style="text-align: center; color: #7f8c8d; font-weight: bold; padding: 5px 0; border-top: 1px dashed #dcdcdc;">O</div>
                        
                        <div class="search-fields">
                            <div>
                                <label>BUSQUE POR TIPO DE DOCUMENTO:</label>
                                <input list="datalist-types" type="text" id="search-type" placeholder="Ej: PNC, PSP" onchange="this.value = this.value.toUpperCase()">
                                <datalist id="datalist-types"></datalist>
                            </div>
                            <div>
                                <label>Y A√ëO:</label>
                                <input type="number" id="search-year" placeholder="A√±o (AAAA)" min="1900" max="3000">
                            </div>
                            <div style="grid-column: span 2; max-width: 50%;">
                                <label>Y MES (Opcional):</label>
                                <select id="search-month">
                                    <option value="">TODOS</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="align-bottom">
                    <button id="clear-search-btn" class="btn-delete" style="width: 100%;"><i class="fas fa-eraser"></i> Limpiar Filtros</button>
                </div>
            </div>

            <h3 style="margin-top: 30px;">Resultados <span id="document-count" style="font-size: 0.9em; font-weight: normal; color: #3498db;">(Cargando conteo...)</span></h3>
            
            <div class="results-container">
                <div id="results-header" class="results-header" style="display: none;">
                    <div>NOMBRE</div>
                    <div>PA√çS</div>
                    <div>TIPO</div>
                    <div>FECHA (AAAA-MM-DD)</div>
                    <div>CATEGOR√çA</div>
                    <div>ENLACE</div>
                    <div style="text-align: right;">ACCIONES</div>
                </div>
                <div id="search-results">
                    <div class="modern-alert">
                        <i class="fas fa-filter fa-2x"></i>
                        <h4 style="color: #3498db; margin-top: 10px;">B√∫squeda Restringida</h4>
                        <p>Por favor, introduce el **PA√çS** (Obligatorio) y al menos el **TIPO**, **A√ëO** o **NOMBRE** del documento para iniciar la b√∫squeda.</p>
                    </div>
                </div>
            </div>
        </div>
        
        </div>
    
    <div id="document-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-file-invoice"></i> Ingresar Nuevo Documento</h2>
            <form id="document-form">
                
                <label for="doc-country"><i class="fas fa-globe"></i> 1¬∫ Pa√≠s:</label>
                <input list="datalist-countries" type="text" id="doc-country" placeholder="Ej: ESPA√ëA" required onchange="this.value = this.value.toUpperCase()">
                
                <label for="doc-type"><i class="fas fa-tag"></i> 2¬∫ Tipo de Documento:</label>
                <input list="datalist-types" type="text" id="doc-type" placeholder="Ej: PSP" required onchange="this.value = this.value.toUpperCase()">
                
                <label for="doc-name"><i class="fas fa-signature"></i> 3¬∫ Nombre Documento: (*)</label>
                <input type="text" id="doc-name" placeholder="T√≠tulo o referencia del documento (Ej: PNC 2023-11-05 ANV.jpg)" required oninput="extractDateFromName('doc-name', 'doc-date-display')">
                <p id="doc-date-display" style="font-size: 0.9em; color: #5dade2; margin-top: 5px;">Fecha extra√≠da: Pendiente...</p>

                <label for="doc-category"><i class="fas fa-archive"></i> 4¬∫ Categor√≠a:</label>
                <select id="doc-category" required>
                    <option value="" disabled selected>Seleccione Categor√≠a</option>
                    <option value="F√çSICO">F√çSICO</option>
                    <option value="ESCANER 2400">ESCANER 2400</option>
                    <option value="ESCANER 600">ESCANER 600</option>
                </select>
                
                <label for="doc-link"><i class="fas fa-link"></i> 5¬∫ Enlace (URL):</label>
                <input type="url" id="doc-link" placeholder="https://..." oninput="updateLinkPreview('doc-link', 'link-preview')">
                <div id="link-preview" class="link-preview">Enlace URL introducido (sin miniatura).</div>
            </form>

            <div style="margin-top: 30px; text-align: right;">
                <button class="btn-primary" onclick="saveDocumentFromModal()"><i class="fas fa-save"></i> Guardar Documento</button>
                <button class="btn-delete" onclick="document.getElementById('document-modal').style.display='none'"><i class="fas fa-times"></i> Cancelar</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-edit"></i> Editar Documento</h2>
            <form id="edit-document-form">
                <input type="hidden" id="edit-doc-key">
                
                <label for="edit-doc-country"><i class="fas fa-globe"></i> 1¬∫ Pa√≠s:</label>
                <input list="datalist-countries" type="text" id="edit-doc-country" placeholder="Ej: ESPA√ëA" required onchange="this.value = this.value.toUpperCase()">
                
                <label for="edit-doc-type"><i class="fas fa-tag"></i> 2¬∫ Tipo de Documento:</label>
                <input list="datalist-types" type="text" id="edit-doc-type" placeholder="Ej: PSP" required onchange="this.value = this.value.toUpperCase()">
                
                <label for="edit-doc-name"><i class="fas fa-signature"></i> 3¬∫ Nombre Documento:</label>
                <input type="text" id="edit-doc-name" placeholder="T√≠tulo o referencia del documento" required oninput="extractDateFromName('edit-doc-name', 'edit-doc-date-display')">
                <p id="edit-doc-date-display" style="font-size: 0.9em; color: #5dade2; margin-top: 5px;">Fecha extra√≠da: Pendiente...</p>
                <input type="hidden" id="edit-doc-fecha-hidden"> 
                
                <label for="edit-doc-category"><i class="fas fa-archive"></i> 4¬∫ Categor√≠a:</label>
                <select id="edit-doc-category" required>
                    <option value="" disabled selected>Seleccione Categor√≠a</option>
                    <option value="F√çSICO">F√çSICO</option>
                    <option value="ESCANER 2400">ESCANER 2400</option>
                    <option value="ESCANER 600">ESCANER 600</option>
                </select>

                <label for="edit-doc-link"><i class="fas fa-link"></i> 5¬∫ Enlace (URL):</label>
                <input type="url" id="edit-doc-link" placeholder="https://..." oninput="updateLinkPreview('edit-doc-link', 'edit-link-preview')">
                <div id="edit-link-preview" class="link-preview">Enlace URL introducido (sin miniatura).</div>
            </form>

            <div style="margin-top: 30px; text-align: right;">
                <button class="btn-primary" onclick="updateDocument()"><i class="fas fa-save"></i> Guardar Cambios</button>
                <button class="btn-delete" onclick="document.getElementById('edit-modal').style.display='none'"><i class="fas fa-times"></i> Cancelar</button>
            </div>
        </div>
    </div>


    <script>
        // **********************************************
        //             [ CONFIGURACI√ìN Y VARIABLES GLOBALES ]
        // **********************************************
        const firebaseConfig = {
            apiKey: "AIzaSyA6EDUJ2dG50DphB-dF6GLi3P2IlW8lDl4",
            authDomain: "gad-alicante-v3.firebaseapp.com",
            databaseURL: "https://gad-alicante-v3-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gad-alicante-v3",
            storageBucket: "gad-alicante-v3.firebasestorage.app",
            messagingSenderId: "906986258369",
            appId: "1:906986258369:web:21a7ea29a33b5f395e3940"
        };
        
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const DOCS_REF = 'documentos/'; 
        const STRUCTURE_REF = 'estructura/'; 
        
        // Elementos principales de B√∫squeda
        const searchCountryInput = document.getElementById('search-country');
        const searchTypeInput = document.getElementById('search-type');
        const searchYearInput = document.getElementById('search-year');
        const searchMonthSelect = document.getElementById('search-month');
        const searchNamePartialInput = document.getElementById('search-name-partial'); 
        const searchResultsDiv = document.getElementById('search-results');
        const resultsHeader = document.getElementById('results-header');
        const documentCountSpan = document.getElementById('document-count'); 
        
        let currentCategoryFilter = ''; 

        // Elementos de Meses y Listas
        const MONTHS = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const EUROPEAN_COUNTRIES = [
            "ALEMANIA", "AUSTRIA", "B√âLGICA", "BULGARIA", "CHIPRE", "CROACIA", "DINAMARCA", 
            "ESLOVAQUIA", "ESLOVENIA", "ESPA√ëA", "ESTONIA", "FINLANDIA", "FRANCIA", "GRECIA", 
            "HUNGR√çA", "IRLANDA", "ITALIA", "LETONIA", "LITUANIA", "LUXEMBURGO", "MALTA", 
            "PA√çSES BAJOS", "POLONIA", "PORTUGAL", "REP√öBLICA CHECA", "RUMAN√çA", "SUECIA"
        ];
        // Tipos predefinidos, siguen siendo v√°lidos
        const PREDEFINED_DOC_TYPES = ["PSP", "CI", "PNC", "PIC", "VEHICULOS"];
        let FULL_DOCUMENT_LIST = []; 
        let ALL_DOCUMENTS = []; 


        // **********************************************
        //           [ L√ìGICA DE FECHAS Y DATALISTS ]
        // **********************************************
        
        /**
         * Intenta extraer una fecha AAAA-MM-DD del NombreDocumento.
         */
        window.extractDateFromName = function(nameInputId, dateDisplayId) {
            const name = document.getElementById(nameInputId).value.trim();
            const display = document.getElementById(dateDisplayId);

            const dateMatch = name.match(/(\d{4}[-/]\d{2}[-/]\d{2})|(\d{4}\d{2}\d{2})/);
            
            let normalizedDate = null;
            let displayValue = 'Pendiente...';
            
            if (dateMatch) {
                let dateStr = dateMatch[0]; 

                if (dateMatch[2]) {
                     dateStr = dateMatch[2].substring(0, 4) + '-' + dateMatch[2].substring(4, 6) + '-' + dateMatch[2].substring(6, 8);
                } else {
                     dateStr = dateStr.replace(/(\d{4})\D(\d{2})\D(\d{2})/, '$1-$2-$3'); 
                }
                
                normalizedDate = dateStr;
                displayValue = `Fecha extra√≠da: ${normalizedDate}`;
            }

            if (display) {
                display.textContent = displayValue;
                display.style.color = normalizedDate ? '#27ae60' : '#e74c3c';
            }
            
            if (nameInputId.includes('edit-doc')) {
                document.getElementById('edit-doc-fecha-hidden').value = normalizedDate || '';
            }
            
            return normalizedDate;
        }

        function correctDocumentDate(doc) {
            const currentFecha = doc.data.Fecha || '';
            const nombre = doc.data.NombreDocumento || '';
            
            const dateMatch = nombre.match(/(\d{4}[-/]\d{2}[-/]\d{2})|(\d{4}\d{2}\d{2})/);
            
            if (dateMatch) {
                let newFecha = dateMatch[0];

                if (dateMatch[2]) {
                     newFecha = dateMatch[2].substring(0, 4) + '-' + dateMatch[2].substring(4, 6) + '-' + dateMatch[2].substring(6, 8);
                } else {
                     newFecha = newFecha.replace(/(\d{4})\D(\d{2})\D(\d{2})/, '$1-$2-$3');
                }
                
                if (currentFecha.length < 10 || currentFecha !== newFecha) {
                    // Si se est√° corrigiendo una fecha, se actualiza en Firebase con la clave de ruta completa
                    database.ref(DOCS_REF + doc.key).update({ Fecha: newFecha })
                        .then(() => console.log(`Fecha corregida para ${doc.key}: ${currentFecha} -> ${newFecha}`))
                        .catch(err => console.error(`Error corrigiendo ${doc.key}`, err));
                        
                    doc.data.Fecha = newFecha;
                    return true;
                }
            } else if (currentFecha.length < 10 && currentFecha.length > 4) {
                 doc.data.Fecha = currentFecha.substring(0, 7);
            }
            
            return false;
        }
        
        // **********************************************
        //           [ L√ìGICA DE ESTRUCTURA Y DATALISTS ]
        // **********************************************
        
        function populateDatalist(id, items) {
            const datalist = document.getElementById(id);
            datalist.innerHTML = '';
            
            const uniqueItems = Array.from(new Set(items.map(item => item.toUpperCase()))).sort();

            uniqueItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                datalist.appendChild(option);
            });
        }
        
        function loadDynamicDatalists() {
            // Cargar pa√≠ses: Europa + Pa√≠ses existentes en documentos
            const existingCountries = new Set(FULL_DOCUMENT_LIST.map(doc => doc.data.Pais).filter(p => p));
            const allCountries = [...EUROPEAN_COUNTRIES, ...Array.from(existingCountries)];
            populateDatalist('datalist-countries', allCountries);

            // Cargar tipos: Solo Predefinidos + Tipos existentes en documentos
            const existingTypes = new Set(FULL_DOCUMENT_LIST.map(doc => doc.data.TipoDocumento).filter(t => t));
            const allTypes = [...PREDEFINED_DOC_TYPES, ...Array.from(existingTypes)];
            
            // Eliminamos duplicados
            const uniqueAllTypes = Array.from(new Set(allTypes));

            populateDatalist('datalist-types', uniqueAllTypes);
        }


        // **********************************************
        //           [ L√ìGICA DE B√öSQUEDA Y FILTRADO ]
        // **********************************************
        
        /**
         * Muestra el recuento de documentos.
         */
        function updateDocumentCount(documents) {
            const categoryQ = currentCategoryFilter; 
            const filteredDocs = categoryQ 
                ? documents.filter(doc => doc.data.Categoria === categoryQ)
                : documents;
            
            if (categoryQ === '') {
                documentCountSpan.textContent = `(${documents.length} documentos totales)`;
            } else {
                documentCountSpan.textContent = `(${filteredDocs.length} documentos)`;
            }
            
            if (searchResultsDiv.children.length > 0 && searchResultsDiv.firstElementChild.classList.contains('doc-row')) {
                documentCountSpan.textContent = `(${searchResultsDiv.children.length} documentos encontrados)`;
            }
        }
        
        // --- Filtro R√°pido por Categor√≠a ---
        window.setCategoryFilter = function(category) {
            currentCategoryFilter = category;
            
            document.querySelectorAll('.filter-buttons button').forEach(btn => {
                btn.classList.remove('active');
            });

            if (category === 'ESCANER 2400') {
                document.getElementById('filter-2400-btn').classList.add('active');
            } else if (category === 'ESCANER 600') {
                document.getElementById('filter-600-btn').classList.add('active');
            } else if (category === 'F√çSICO') {
                document.getElementById('filter-fisico-btn').classList.add('active');
            } else {
                document.getElementById('filter-todos-btn').classList.add('active');
            }
            
            ALL_DOCUMENTS = FULL_DOCUMENT_LIST.filter(doc => {
                const docCategory = doc.data.Categoria || '';
                return !category || docCategory === category;
            });

            filterDocuments();
            updateDocumentCount(FULL_DOCUMENT_LIST); 
        }


        function renderDocRow(key, data) {
            const row = document.createElement('div');
            row.classList.add('doc-row');
            
            const linkUrl = data.Enlace && data.Enlace !== 'N/A' ? data.Enlace : '#';
            const linkTarget = data.Enlace && data.Enlace !== 'N/A' ? '_blank' : '';
            const linkColor = data.Enlace && data.Enlace !== 'N/A' ? '#007bff' : '#7f8c8d'; 
            
            const displayDate = data.Fecha && data.Fecha.length >= 7 ? data.Fecha : 'N/A'; 

            row.innerHTML = `
                <div>${data.NombreDocumento || 'S/N'}</div>
                <div>${data.Pais}</div>
                <div>${data.TipoDocumento}</div>
                <div>${displayDate}</div>
                <div>${data.Categoria || 'N/A'}</div>
                <div><a href="${linkUrl}" target="${linkTarget}" style="color: ${linkColor}; text-decoration: none;">${data.Enlace && data.Enlace !== 'N/A' ? 'Ver Enlace' : 'N/A'}</a></div>
                <div class="doc-actions">
                    <button class="btn-warning" onclick="openEditModal('${key}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-delete" onclick="deleteDocument('${key}', '${data.NombreDocumento || 'este documento'}')"><i class="fas fa-trash"></i></button>
                </div>
            `;
            return row;
        }

        function filterDocuments() {
            // Valores de b√∫squeda
            const countryQ = searchCountryInput.value.trim().toUpperCase();
            const typeQ = searchTypeInput.value.trim().toUpperCase();
            const yearQ = searchYearInput.value.trim();
            const monthQ = searchMonthSelect.value;
            const namePartialQ = searchNamePartialInput.value.trim().toUpperCase(); 
            const categoryQ = currentCategoryFilter; 
            
            searchResultsDiv.innerHTML = '';
            resultsHeader.style.display = 'none'; 
            
            // Requisito OBLIGATORIO: Pa√≠s Y (Tipo O A√±o O Nombre Parcial)
            if (!countryQ || (!typeQ && !yearQ && !namePartialQ)) {
                searchResultsDiv.innerHTML = `
                    <div class="modern-alert">
                        <i class="fas fa-filter fa-2x"></i>
                        <h4 style="color: #3498db; margin-top: 10px;">B√∫squeda Restringida</h4>
                        <p>Por favor, introduce el **PA√çS** (<span class="required-label">OBLIGATORIO</span>) y al menos el **TIPO**, **A√ëO** o **NOMBRE** del documento para iniciar la b√∫squeda.</p>
                    </div>
                `;
                updateDocumentCount(FULL_DOCUMENT_LIST); 
                return;
            }

            let matchFound = false;

            const filtered = ALL_DOCUMENTS.filter(doc => {
                const data = doc.data;
                
                const docFecha = data.Fecha || '';
                const docYear = docFecha.substring(0, 4);
                const docMonth = docFecha.substring(5, 7);
                const docCategory = data.Categoria || '';
                const docName = data.NombreDocumento.toUpperCase() || '';

                // 1. FILTRO PA√çS (Obligatorio)
                if (countryQ && data.Pais.indexOf(countryQ) === -1) return false;

                // 2. FILTROS ESTRUCTURALES Y NOMBRE PARCIAL
                if (typeQ && data.TipoDocumento.indexOf(typeQ) === -1) return false;
                if (yearQ && docYear.indexOf(yearQ) === -1) return false;
                if (monthQ && docMonth !== monthQ) return false;
                // Si el nombre parcial est√° presente, debe coincidir
                if (namePartialQ && docName.indexOf(namePartialQ) === -1) return false;
                
                // 3. FILTRO DE CATEGOR√çA (se aplica en ALL_DOCUMENTS, pero se chequea por si acaso)
                if (categoryQ && docCategory !== categoryQ) return false;
                
                return true;
            });
            
            if (filtered.length > 0) {
                resultsHeader.style.display = 'grid'; 
                
                // Ordenar alfab√©ticamente por NombreDocumento
                filtered.sort((a, b) => a.data.NombreDocumento.localeCompare(b.data.NombreDocumento));
                
                filtered.forEach(doc => {
                    searchResultsDiv.appendChild(renderDocRow(doc.key, doc.data));
                });
                matchFound = true;
            }

            if (!matchFound) {
                 searchResultsDiv.innerHTML = `
                    <div class="modern-alert modern-alert-error">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <h4 style="color: #e67e22; margin-top: 10px;">Sin Resultados</h4>
                        <p>No se encontraron documentos que coincidan con los filtros aplicados.</p>
                    </div>
                 `;
            }
            
            documentCountSpan.textContent = `(${filtered.length} documentos encontrados)`;
        }
        
        function clearSearch() {
            searchCountryInput.value = '';
            searchTypeInput.value = '';
            searchYearInput.value = '';
            searchMonthSelect.value = '';
            searchNamePartialInput.value = ''; 
            setCategoryFilter(''); 
        }

        // *****************************************************************
        // ** CARGA INICIAL DE DOCUMENTOS (ADAPTADA A LA NUEVA ESTRUCTURA) **
        // *****************************************************************
        function loadAllDocuments() {
            database.ref(DOCS_REF).once('value', (snapshot) => {
                FULL_DOCUMENT_LIST = [];
                let datesCorrectedCount = 0;

                // Primer bucle: Itera sobre las claves combinadas (ej: ALEMANIA CI, FRANCIA PSP)
                snapshot.forEach((combinedKeySnapshot) => {
                    
                    // Segundo bucle: Itera sobre los documentos √∫nicos (ej: doc_100, doc_101)
                    combinedKeySnapshot.forEach((childSnapshot) => {
                        // La clave (key) ahora es la ruta completa para CRUD: PAIS TIPO/doc_N
                        const fullKeyPath = combinedKeySnapshot.key + '/' + childSnapshot.key;
                        
                        const doc = { 
                            key: fullKeyPath, 
                            data: childSnapshot.val() 
                        };
                        
                        if (correctDocumentDate(doc)) {
                            datesCorrectedCount++;
                        }
                        
                        FULL_DOCUMENT_LIST.push(doc);
                    });
                });
                
                if (datesCorrectedCount > 0) {
                     console.log(`Se corrigieron autom√°ticamente ${datesCorrectedCount} fechas con el nombre del archivo.`);
                }
                
                // Restablecer filtros y cargar listas din√°micas
                setCategoryFilter(currentCategoryFilter); 
                loadDynamicDatalists();
                filterDocuments(); 
                updateDocumentCount(FULL_DOCUMENT_LIST); 
            });
        }
        
        // **********************************************
        //           [ L√ìGICA DE MODAL, CRUD y UI ]
        // **********************************************
        
        // Funci√≥n de saneamiento de claves (necesaria para el guardado)
        function sanitizeKey(key) {
            // Elimina los caracteres prohibidos en las claves de Firebase
            return key.replace(/[\$\#\[\]\/\.]/g, '').trim(); 
        }
        
        window.updateLinkPreview = function(inputId, previewId) {
             const link = document.getElementById(inputId).value.trim();
            const previewDiv = document.getElementById(previewId);

            if (link.length > 5 && link.includes('http')) {
                previewDiv.innerHTML = `<a href="${link}" target="_blank" style="color: white; text-decoration: none;">VER ENLACE: ${link.substring(0, 40)}...</a>`;
                previewDiv.style.background = '#3498db';
                previewDiv.style.color = 'white';
                previewDiv.style.pointerEvents = 'auto';
            } else {
                 previewDiv.innerHTML = `Enlace URL introducido (sin miniatura).`;
                 previewDiv.style.background = '#f0f4f7';
                 previewDiv.style.color = '#7f8c8d';
                 previewDiv.style.pointerEvents = 'none';
            }
        }
        
        // FUNCI√ìN DE GUARDADO (ADAPTADA A LA NUEVA ESTRUCTURA)
        window.saveDocumentFromModal = function() {
            const pais = document.getElementById('doc-country').value.trim().toUpperCase();
            const tipo = document.getElementById('doc-type').value.trim().toUpperCase();
            const nombre = document.getElementById('doc-name').value.trim();
            const categoria = document.getElementById('doc-category').value; 
            const enlace = document.getElementById('doc-link').value.trim();
            
            const fechaCompleta = extractDateFromName('doc-name', 'doc-date-display'); 

            if (!pais || !tipo || !nombre || !categoria) {
                alert("‚ö†Ô∏è Por favor, rellena Pa√≠s, Tipo, Nombre y Categor√≠a del Documento.");
                return;
            }
            if (!fechaCompleta) {
                 alert("‚ö†Ô∏è No se pudo extraer la fecha completa (AAAA-MM-DD) del nombre del documento. Por favor, aseg√∫rate de que el formato sea correcto (Ej: YYYY-MM-DD o YYYY/MM/DD o AAAAMMDD).");
                 return;
            }

            // Construcci√≥n y saneamiento de la clave combinada
            const combinedKey = `${pais} ${tipo}`; 
            const sanitizedCombinedKey = sanitizeKey(combinedKey); 
            
            if (sanitizedCombinedKey === "") {
                 alert("‚ö†Ô∏è El Pa√≠s o Tipo de Documento resultaron vac√≠os o inv√°lidos despu√©s del saneamiento. Revise los datos de entrada.");
                 return;
            }
            
            const docData = {
                Pais: pais,
                TipoDocumento: tipo,
                NombreDocumento: nombre,
                Fecha: fechaCompleta, 
                Categoria: categoria, 
                Enlace: enlace || 'N/A',
                Timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            // La referencia apunta a la carpeta combinada, luego push() crea el ID √∫nico (doc_N)
            const newDocRef = database.ref(DOCS_REF + sanitizedCombinedKey).push(); 
            newDocRef.set(docData)
                .then(() => {
                    alert("‚úÖ Documento guardado correctamente!");
                    document.getElementById('document-modal').style.display = 'none';
                    document.getElementById('document-form').reset();
                    updateLinkPreview('doc-link', 'link-preview');
                    document.getElementById('doc-date-display').textContent = 'Fecha extra√≠da: Pendiente...';
                    loadAllDocuments(); 
                })
                .catch((error) => {
                    alert("‚ùå Error al guardar el documento: " + error.message);
                });
        }

        window.openEditModal = function(key) {
            // key ahora es la ruta completa (ej: ALEMANIA CI/doc_100)
            const doc = FULL_DOCUMENT_LIST.find(d => d.key === key);
            if (!doc) return alert("Error: Documento no encontrado.");
            
            const data = doc.data;
            
            document.getElementById('edit-doc-key').value = key;
            document.getElementById('edit-doc-country').value = data.Pais;
            document.getElementById('edit-doc-type').value = data.TipoDocumento;
            document.getElementById('edit-doc-name').value = data.NombreDocumento;
            document.getElementById('edit-doc-category').value = data.Categoria || ''; 
            document.getElementById('edit-doc-link').value = data.Enlace === 'N/A' ? '' : data.Enlace;
            
            extractDateFromName('edit-doc-name', 'edit-doc-date-display'); 
            updateLinkPreview('edit-doc-link', 'edit-link-preview');

            document.getElementById('edit-modal').style.display = 'flex';
        }

        window.updateDocument = async function() {
            // key es la ruta completa (ej: ALEMANIA CI/doc_100)
            const key = document.getElementById('edit-doc-key').value;
            const pais = document.getElementById('edit-doc-country').value.trim().toUpperCase();
            const tipo = document.getElementById('edit-doc-type').value.trim().toUpperCase();
            const nombre = document.getElementById('edit-doc-name').value.trim();
            const categoria = document.getElementById('edit-doc-category').value; 
            const enlace = document.getElementById('edit-doc-link').value.trim();

            const fechaCompleta = extractDateFromName('edit-doc-name', 'edit-doc-date-display');

            if (!pais || !tipo || !nombre || !categoria) {
                alert("‚ö†Ô∏è Por favor, rellena Pa√≠s, Tipo, Nombre y Categor√≠a del Documento.");
                return;
            }
            if (!fechaCompleta) {
                 alert("‚ö†Ô∏è No se pudo extraer la fecha completa (AAAA-MM-DD) del nombre del documento. Por favor, revisa el nombre.");
                 return;
            }
            
            const updatedData = {
                Pais: pais,
                TipoDocumento: tipo,
                NombreDocumento: nombre,
                Fecha: fechaCompleta, 
                Categoria: categoria, 
                Enlace: enlace || 'N/A',
                Timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            try {
                // Utiliza la key de ruta completa para la actualizaci√≥n
                await database.ref(DOCS_REF + key).update(updatedData); 
                alert("‚úÖ Documento actualizado correctamente!");
                document.getElementById('edit-modal').style.display = 'none';
                loadAllDocuments(); 
            } catch (error) {
                alert("‚ùå Error al actualizar el documento: " + error.message);
            }
        }

        window.deleteDocument = async function(key, name) {
            // key es la ruta completa (ej: ALEMANIA CI/doc_100)
            if (confirm(`¬øEst√°s seguro de que quieres eliminar DEFINITIVAMENTE el documento "${name}"? Esta acci√≥n no se puede deshacer.`)) {
                try {
                    // Utiliza la key de ruta completa para la eliminaci√≥n
                    await database.ref(DOCS_REF + key).remove();
                    loadAllDocuments(); 
                    alert(`‚úÖ Documento "${name}" eliminado.`);
                } catch (error) {
                     alert("‚ùå Error al eliminar el documento: " + error.message);
                }
            }
        }
        
        // **********************************************
        //               [ INICIALIZACI√ìN ]
        // **********************************************
        
        function enableDatalistDropdown(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('focus', function() {
                    this.dispatchEvent(new KeyboardEvent('keydown', { key: 'ArrowDown', keyCode: 40, bubbles: true }));
                });
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            
            populateSelectors();
            loadAllDocuments(); 
            
            enableDatalistDropdown('search-country');
            enableDatalistDropdown('search-type');
            
            // Eventos del Modal de A√±adir Documento
            document.getElementById('open-modal-btn').addEventListener('click', () => {
                 document.getElementById('document-modal').style.display = 'flex';
                 enableDatalistDropdown('doc-country');
                 enableDatalistDropdown('doc-type');
                 updateLinkPreview('doc-link', 'link-preview'); 
                 document.getElementById('document-form').reset(); 
                 document.getElementById('doc-date-display').textContent = 'Fecha extra√≠da: Pendiente...';
            });

            // Eventos de los modales para cerrar al hacer click fuera
            document.getElementById('edit-modal').addEventListener('click', (event) => {
                if (event.target === document.getElementById('edit-modal')) { 
                    document.getElementById('edit-modal').style.display = "none";
                }
            });
            document.getElementById('document-modal').addEventListener('click', (event) => {
                if (event.target === document.getElementById('document-modal')) { 
                    document.getElementById('document-modal').style.display = "none";
                }
            });
            
            // Eventos de B√∫squeda (Input en vivo)
            searchCountryInput.addEventListener('input', filterDocuments);
            searchTypeInput.addEventListener('input', filterDocuments);
            searchYearInput.addEventListener('input', filterDocuments);
            searchMonthSelect.addEventListener('change', filterDocuments);
            searchNamePartialInput.addEventListener('input', filterDocuments); 
            document.getElementById('clear-search-btn').addEventListener('click', clearSearch);
            
        });
        
        function populateSelectors() {
            const monthSelectors = [document.getElementById('search-month')];
            MONTHS.forEach((month, index) => {
                const value = (index + 1).toString().padStart(2, '0');
                monthSelectors.forEach((selector) => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = month;
                    selector.appendChild(option);
                });
            });
        }
    </script>
</body>
</html>