// ==============================================================================
// 1. CONFIGURACIÓN FINAL DE DRIVE (COMPLETA)
// ==============================================================================

// ID de la carpeta PADRE que contiene DOCUMENTOS, VEHÍCULOS, SELLOS, etc.
const PARENT_FOLDER_ID = '1S3ilMalBvs_F2Ay6krLXK-rbR5CJVA2m'; 

// Nombre exacto de la pestaña en tu Hoja de Cálculo
const SHEET_NAME = 'Inventario_Drive_Sync'; 


// ==============================================================================
// 2. FUNCIÓN PRINCIPAL: Inicia el escaneo de Drive
// ==============================================================================
function listarArchivosYActualizarHoja() {
    
    // --- Preparación de la Hoja de Cálculo ---
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    if (!sheet) {
        Logger.log('Error: No se encontró la hoja con el nombre ' + SHEET_NAME);
        return;
    }
    
    // Columnas de encabezado
    const HEADERS = ['PAIS', 'TIPO_DOCUMENTO', 'NOMBRE_DOCUMENTO', 'FECHA', 'CATEGORIA', 'ENLACE_DRIVE', 'ID_ARCHIVO_DRIVE'];
    sheet.getRange(1, 1, 1, HEADERS.length).setValues([HEADERS]);
    
    // Limpiar datos anteriores (de la fila 2 en adelante)
    if (sheet.getLastRow() > 1) {
        sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn()).clearContent();
    }
    
    const data = [];

    try {
        const parentFolder = DriveApp.getFolderById(PARENT_FOLDER_ID);
        const rootFolders = parentFolder.getFolders(); // Carpetas: DOCUMENTOS, VEHÍCULOS, SELLOS, etc.
        
        // Recorrer las carpetas de primer nivel (DOCUMENTOS, VEHÍCULOS, SELLOS...)
        while (rootFolders.hasNext()) {
            const rootFolder = rootFolders.next();
            const rootFolderName = rootFolder.getName().toUpperCase();
            
            // Empezar la recursión: la carpeta raíz define la Categoría Global.
            traverseFolder(rootFolder, rootFolderName); 
        }

    } catch(e) {
        Logger.log(`Error al procesar la carpeta raíz ${PARENT_FOLDER_ID}: ${e}`);
    }

    // 2. Escribir todos los datos recopilados
    if (data.length > 0) {
        sheet.getRange(2, 1, data.length, data[0].length).setValues(data);
    }
    
    Logger.log(`Proceso completado. ${data.length} documentos encontrados.`);
    
    // 3. Llamada al conector de Firebase (Función en API_Firebase.gs)
    // ESTO INICIA LA SUBIDA A LA BASE DE DATOS
    actualizarFirebaseDesdeSheets();
    
    // --- Función recursiva para recorrer la estructura ---
    function traverseFolder(folder, rootType, pais = null, tipo = null) {
        
        const subFolders = folder.getFolders();

        // Nivel 1: Carpetas de PAÍSES (Ej: ALEMANIA). Se busca en la primera subcarpeta de la raíz.
        if (pais === null && subFolders.hasNext()) {
            while (subFolders.hasNext()) {
                const countryFolder = subFolders.next();
                const newPais = countryFolder.getName().toUpperCase();
                traverseFolder(countryFolder, rootType, newPais, null);
            }
            return;
        }

        // Nivel 2: Carpetas de TIPO (Ej: PNC, CI). Se busca en la subcarpeta del País.
        if (pais !== null && tipo === null && subFolders.hasNext()) {
            while (subFolders.hasNext()) {
                const typeFolder = subFolders.next();
                const newTipo = typeFolder.getName().toUpperCase();
                traverseFolder(typeFolder, rootType, pais, newTipo);
            }
            return;
        }
        
        // Nivel 3: Archivos
        const files = folder.getFiles();
        while (files.hasNext()) {
            const file = files.next();
            
            // Si no encontramos un TIPO (archivos directos en la carpeta País), usamos el nombre de la carpeta País como TIPO por defecto
            const finalTipo = tipo === null ? folder.getName().toUpperCase() : tipo;
            
            const fileName = file.getName();
            const fileUrl = file.getUrl();
            const fileId = file.getId();
            const dateCreated = file.getDateCreated();
            
            // Formato de Fecha YYYY-MM
            const anio = dateCreated.getFullYear().toString();
            const mes = (dateCreated.getMonth() + 1).toString().padStart(2, '0');
            const fecha = `${anio}-${mes}`;

            // Deducción de CATEGORIA (se basa en la carpeta raíz y en el nombre del archivo)
            let categoria = rootType; 
            
            if (rootType === 'DOCUMENTOS') {
                if (fileName.toUpperCase().includes('REV')) {
                    categoria = 'ESCANER 2400';
                } else if (fileName.toUpperCase().includes('ANV')) {
                    categoria = 'ESCANER 600';
                } else {
                    categoria = 'FÍSICO'; 
                }
            } else if (rootType === 'VEHÍCULOS' || rootType === 'VEHICULOS') {
                 categoria = 'FÍSICO_VEHICULOS'; 
            }
            
            data.push([
                pais || rootType, 
                finalTipo,         
                fileName,     
                fecha,        
                categoria,    
                fileUrl,      
                fileId        
            ]);
        }
    } 
}
