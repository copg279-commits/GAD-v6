<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario de Documentos - GAD</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ESTILOS DE LA CABECERA SIMULADA (Ahora Panel de T√≠tulo) */
        .title-panel-blue {
            background-color: #3b82f6; /* Azul solicitado */
            display: flex;
            justify-content: space-between; /* Para separar el t√≠tulo y el logo */
            align-items: center;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
        }
        .title-panel-blue h1 {
            color: white;
            margin: 0;
            padding: 0;
            font-size: 1.8em;
            display: flex;
            align-items: center;
        }
        .title-panel-blue .header-logo-container {
            width: 80px; /* Tama√±o del logo ajustado */
            height: 80px;
        }
        .title-panel-blue .header-logo-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* ESTILOS DEL PIE DE P√ÅGINA */
        footer {
            background-color: #e0e0e0;
            text-align: center;
            padding: 20px;
            width: 100%;
            margin-top: auto;
        }
        footer p {
            margin: 5px 0;
            font-size: 1em;
            color: #333;
            font-weight: bold;
        }

        /* [ ESTILOS BASE Y PANELES - DISE√ëO INTEGRADO ] */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            color: #333;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        main {
            flex: 1;
            padding: 15px;
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .app-container {
            max-width: 1300px;
            width: 100%;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        .panel {
            background: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
        }
        h1, h2, h3 {
            color: #2c3e50;
            padding-bottom: 10px;
            margin-top: 0;
            font-weight: 700;
        }
        /* El H1 ahora est√° en el panel azul */
        h2 { font-size: 1.5em; }
        h3 { font-size: 1.2em; }

        /* Controles y Botones (Mantenidos) */
        button {
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            margin-right: 8px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: white;
        }
        button i { font-size: 1em; }
        .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-primary:hover { box-shadow: 0 4px 10px rgba(41, 128, 185, 0.4); }
        .btn-delete { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .btn-delete:hover { box-shadow: 0 4px 10px rgba(192, 57, 43, 0.4); }
        .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .btn-success:hover { box-shadow: 0 4px 10px rgba(39, 174, 96, 0.4); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .btn-warning:hover { box-shadow: 0 4px 10px rgba(230, 126, 34, 0.4); }

        /* Estilos de Botones de Modo de Inventario */
        .mode-selection-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            gap: 15px;
        }

        #mode-personas-btn { background: #3498db; }
        #mode-vehiculos-btn { background: #e67e22; }

        #mode-personas-btn, #mode-vehiculos-btn {
             opacity: 0.6; 
             transition: opacity 0.3s ease;
        }
        #mode-personas-btn.active, #mode-vehiculos-btn.active {
            background: #27ae60;
            box-shadow: 0 4px 10px rgba(39, 174, 96, 0.4);
            border: 2px solid white;
            opacity: 1; 
        }


        /* Estilos generales de inputs y selects (Mantenidos) */
        input[type="text"], input[type="number"], input[type="url"], select {
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 8px 12px;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-shadow: inset 0 1px 2px rgba(0,0,0,.075);
            font-size: 0.95em;
            width: 100%;
            box-sizing: border-box;
        }

        /* B√öSQUEDA Y CONTROLES - Estructura mejorada (Mantenidos) */
        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        /* Estilos de botones de categor√≠a (Mantenidos) */
        .filter-buttons button {
            margin-left: 8px;
        }
        .btn-cat-2400 { background: #e0f2f7; color: #0288d1; border: 1px solid #b3e5fc; }
        .btn-cat-600 { background: #e8f5e9; color: #388e3c; border: 1px solid #c8e6c9; }
        .btn-cat-fisico { background: #fff8e1; color: #fbc02d; border: 1px solid #ffe082; }
        .btn-cat-todos { background: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; }

        .btn-cat-2400.active { background: #03a9f4; color: white; box-shadow: 0 4px 10px rgba(3, 169, 244, 0.4); }
        .btn-cat-600.active { background: #4caf50; color: white; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4); }
        .btn-cat-fisico.active { background: #ffc107; color: white; box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4); }
        .btn-cat-todos.active { background: #f44336; color: white; box-shadow: 0 4px 10px rgba(244, 67, 54, 0.4); }

        /* Estilos para el campo obligatorio (Mantenidos) */
        .required-label {
            color: #e74c3c;
            font-weight: bold;
        }

        /* üö® [CORRECCI√ìN CSS] Layout del grid de b√∫squeda */
        .search-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* M√≥vil primero */
            gap: 15px;
            padding: 15px 0;
            align-items: flex-start; /* Alinea los elementos al inicio */
            border-top: 1px solid #e0e0e0;
            padding-top: 20px;
        }

        .search-controls label {
            font-size: 0.85em;
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
            display: block;
        }

        .search-controls .align-bottom {
            align-self: flex-end; /* Mantiene el bot√≥n alineado abajo */
        }
        
        /* Media query para el layout de 6 columnas en escritorio */
        @media (min-width: 1200px) {
            .search-controls {
                /* [Pa√≠s+Subtipo] [Nombre] [Tipo] [A√±o] [Mes] [Bot√≥n] */
                grid-template-columns: 1.5fr 1.5fr 1fr 0.7fr 0.7fr 150px; 
            }
        }

        /* LISTADO HORIZONTAL (TABLA) - Mantenidos */
        .results-container {
            overflow-x: auto;
            padding-bottom: 10px;
            max-width: 100%;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fdfdfd;
        }
        .results-header, .doc-row {
            grid-template-columns: 2fr 1.2fr 1fr 1fr 1fr 1.5fr 150px; 
            display: grid;
            gap: 15px;
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            min-width: 1000px;
        }
        .results-header {
            font-weight: bold;
            background: #e9f2f7;
            border-bottom: 2px solid #3498db;
            border-radius: 8px 8px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
            color: #2c3e50;
        }
        .doc-row:nth-child(even) {
            background: #f9f9f9;
        }
        .doc-row:hover {
            background: #eef4f9;
        }
        .doc-row div {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            align-self: center;
        }
        .doc-row div:nth-child(2) {
             white-space: normal; 
             word-break: break-word; 
        }

        .doc-actions {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
            min-width: 120px;
        }

        /* Estilo espec√≠fico para el icono de enlace (Mantenidos) */
        .link-icon-container {
            text-align: center;
        }
        .link-icon {
            color: #2ecc71;
            font-size: 1.2em;
            cursor: pointer;
            text-decoration: none;
            transition: color 0.2s;
            padding: 5px;
            display: inline-block;
        }
        .link-icon:hover {
            color: #27ae60;
        }
        .link-icon-disabled {
            color: #b0b0b0;
            cursor: default;
        }

        /* [ ESTILOS DEL MODAL MEJORADO - Mantenidos ] */
        .modal {
            position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background-color: #fefefe;
            padding: 35px;
            border-radius: 12px;
            width: 95%;
            max-width: 600px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.25);
            animation: fadeInScale 0.3s ease-out;
            position: relative;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modern-alert {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            background-color: #f0f4f7;
            border: 1px solid #dcdcdc;
            color: #555;
        }
        .modern-alert-error {
            background-color: #fef2f2;
            border-color: #f44336;
        }
        .link-preview {
            background-color: #f0f4f7;
            padding: 8px;
            border-radius: 5px;
            margin-top: 5px;
            font-size: 0.9em;
            color: #7f8c8d;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            pointer-events: none;
        }
        label {
             display: block;
             margin-top: 15px;
             margin-bottom: 5px;
             font-weight: bold;
             color: #2c3e50;
        }
        .category-fixed-input {
            background-color: #f5f5f5;
            color: #7f8c8d;
            cursor: not-allowed;
            font-weight: bold;
        }

    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>

<body>
    <main>
        <div class="app-container">

            <div class="title-panel-blue">
                <h1><i class="fas fa-archive"></i> Inventario de Documentos - GAD</h1>
                <div class="header-logo-container">
                    <img src="logogad.png" alt="Logo GAD">
                </div>
            </div>

            <div class="panel">
                <div class="search-header">
                    <h2>üîç B√∫squeda de Documentos (Unificada)</h2>

                    <div class="mode-selection-container">
                        <h4 style="color: #3498db;"><i class="fas fa-database"></i> Modo:</h4>
                        <button id="mode-personas-btn" class="btn-primary active" onclick="setInventoryMode('documentos 600 dpi')" style="width: 150px;"><i class="fas fa-user"></i> PERSONAS</button>
                        <button id="mode-vehiculos-btn" class="btn-warning" onclick="setInventoryMode('vehiculos 600 dpi')" style="width: 150px;"><i class="fas fa-car"></i> VEH√çCULOS</button>
                    </div>
                    <div class="filter-buttons">
                        <button id="filter-2400-btn" class="btn-cat-2400" onclick="setCategoryFilter('ESCANER 2400')">ESCANER 2400</button>
                        <button id="filter-600-btn" class="btn-cat-600" onclick="setCategoryFilter('ESCANER 600')">ESCANER 600</button>
                        <button id="filter-fisico-btn" class="btn-cat-fisico" onclick="setCategoryFilter('F√çSICO')">F√çSICO</button>
                        <button id="filter-todos-btn" class="btn-cat-todos active" onclick="setCategoryFilter('')">TODOS</button>
                    </div>
                </div>

                <div class="search-controls">

                    <div>
                        <label>PA√çS (<span class="required-label">OBLIGATORIO</span>):</label>
                        <input list="datalist-countries" type="text" id="search-country" placeholder="Selecciona o a√±ade un pa√≠s"
                                onchange="handleCountryChange(this.value); this.value = this.value.toUpperCase()" onfocus="this.value=''" required>
                        <datalist id="datalist-countries"></datalist>

                        <div id="state-region-container" style="display: none; margin-top: 10px;">
                            <label id="state-region-label">ESTADO/PROVINCIA/CIUDAD:</label>
                            <input list="datalist-states" type="text" id="search-state-region" placeholder="Ej: ALASKA, QUEBEC, BUENOS AIRES" onchange="this.value = this.value.toUpperCase()">
                            <datalist id="datalist-states"></datalist>
                        </div>
                    </div>

                    <div>
                        <label>BUSCAR POR NOMBRE:</label>
                        <input type="text" id="search-name-partial" placeholder="Nombre completo o parte">
                    </div>

                    <div>
                        <label>BUSCAR POR TIPO:</label>
                        <input list="datalist-types" type="text" id="search-type" placeholder="Ej: PNC, PSP" onchange="this.value = this.value.toUpperCase()">
                        <datalist id="datalist-types"></datalist>
                    </div>

                    <div>
                        <label>A√ëO:</label>
                        <input type="number" id="search-year" placeholder="A√±o (AAAA)" min="1900" max="3000">
                    </div>

                    <div>
                        <label>MES:</label>
                        <select id="search-month">
                            <option value="">TODOS</option>
                        </select>
                    </div>

                    <div class="align-bottom">
                        <button id="clear-search-btn" class="btn-delete" style="width: 100%;"><i class="fas fa-eraser"></i> Limpiar Filtros</button>
                    </div>
                </div>
                <h3 style="margin-top: 30px;">Resultados <span id="document-count" style="font-size: 0.9em; font-weight: normal; color: #3498db;">(Cargando conteo...)</span></h3>

                <div class="results-container">
                    <div id="results-header" class="results-header" style="display: none;">
                        <div>NOMBRE</div>
                        <div>PA√çS</div>
                        <div>TIPO</div>
                        <div>FECHA (AAAA-MM-DD)</div>
                        <div>CATEGOR√çA</div>
                        <div style="text-align: center;">ENLACE</div>
                        <div style="text-align: right;">ACCIONES</div>
                    </div>
                    <div id="search-results">
                        <div class="modern-alert">
                            <i class="fas fa-filter fa-2x"></i>
                            <h4 style="color: #3498db; margin-top: 10px;">B√∫squeda Restringida</h4>
                            <p>Por favor, introduce el **PA√çS** (<span class="required-label">OBLIGATORIO</span>) para iniciar la b√∫squeda en el inventario unificado.</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <footer>
        <p>GRUPO DE AN√ÅLISIS DOCUMENTAL</p>
        <p>POLIC√çA LOCAL DE ALICANTE</p>
        <p>¬© GAD - Todos los derechos reservados</p>
    </footer>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-edit"></i> Editar Documento</h2>
            <form id="edit-document-form">
                <input type="hidden" id="edit-doc-key">

                <label for="edit-doc-country"><i class="fas fa-globe"></i> Pa√≠s:</label>
                <input list="datalist-countries" type="text" id="edit-doc-country" placeholder="Ej: ESPA√ëA" required
                       onchange="this.value = this.value.toUpperCase(); updateModalCountrySpecificFields(this.value)">

                <div id="edit-state-region-container" style="display: none; margin-top: 10px;">
                    <label id="edit-state-region-label" for="edit-doc-subtipo"><i class="fas fa-map-marker-alt"></i> Estado/Provincia/Ciudad:</label>
                    <input list="datalist-states" type="text" id="edit-doc-subtipo" placeholder="Ej: ALASKA" onchange="this.value = this.value.toUpperCase()">
                </div>

                <label for="edit-doc-type"><i class="fas fa-tag"></i> Tipo de Documento:</label>
                <input list="datalist-types" type="text" id="edit-doc-type" placeholder="Ej: PSP" required onchange="this.value = this.value.toUpperCase()">

                <label for="edit-doc-name"><i class="fas fa-signature"></i> Nombre Documento:</label>
                <input type="text" id="edit-doc-name" placeholder="T√≠tulo o referencia del documento" required oninput="extractDateFromName('edit-doc-name', 'edit-doc-date-display')">
                <p id="edit-doc-date-display" style="font-size: 0.9em; color: #5dade2; margin-top: 5px;">Fecha extra√≠da: Pendiente...</p>
                <input type="hidden" id="edit-doc-fecha-hidden">

                <label for="edit-doc-category"><i class="fas fa-archive"></i> Categor√≠a (Fija):</label>
                <select id="edit-doc-category" required disabled class="category-fixed-input" title="La categor√≠a est√° fija a ESCANER 600 para estos nodos.">
                    <option value="ESCANER 600" selected>ESCANER 600</option>
                    <option value="F√çSICO">F√çSICO</option>
                    <option value="ESCANER 2400">ESCANER 2400</option>
                </select>

                <label for="edit-doc-link"><i class="fas fa-link"></i> Enlace (URL):</label>
                <input type="url" id="edit-doc-link" placeholder="https://..." oninput="updateLinkPreview('edit-doc-link', 'edit-link-preview')">
                <div id="edit-link-preview" class="link-preview">Enlace URL introducido (sin miniatura).</div>
            </form>

            <div style="margin-top: 30px; text-align: right;">
                <button class="btn-primary" onclick="updateDocument()"><i class="fas fa-save"></i> Guardar Cambios</button>
                <button class="btn-delete" onclick="document.getElementById('edit-modal').style.display='none'"><i class="fas fa-times"></i> Cancelar</button>
            </div>
        </div>
    </div>


    <script>
        // **********************************************
        //      ‚úÖ [ CONFIGURACI√ìN DE FIREBASE ]
        // **********************************************
        const firebaseConfig = {
            apiKey: "AIzaSyA6EDUJ2dG50DphB-dF6GLi3P2IlW8lDl4",
            authDomain: "gad-alicante-v3.firebaseapp.com",
            databaseURL: "https://gad-alicante-v3-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gad-alicante-v3",
            storageBucket: "gad-alicante-v3.firebasestorage.app",
            messagingSenderId: "906986258369",
            appId: "1:906986258369:web:21a7ea29a33b5f395e3940"
        };

        let app = null;
        let database = null;

        try {
            app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("‚úÖ Firebase inicializado correctamente.");
        } catch (error) {
            console.error("‚ùå ERROR CR√çTICO DE FIREBASE:", error.message);
            alert("‚ùå Error al inicializar Firebase. Revisa tus credenciales.");
        }

        const DOCS_REF = 'documentos 600 dpi/'; 
        const VEHICLES_REF = 'vehiculos 600 dpi/'; 

        const searchCountryInput = document.getElementById('search-country');
        const searchTypeInput = document.getElementById('search-type');
        const searchYearInput = document.getElementById('search-year');
        const searchMonthSelect = document.getElementById('search-month');
        const searchNamePartialInput = document.getElementById('search-name-partial');
        const searchStateRegionInput = document.getElementById('search-state-region'); 
        const stateRegionContainer = document.getElementById('state-region-container'); 

        const searchResultsDiv = document.getElementById('search-results');
        const resultsHeader = document.getElementById('results-header');
        const documentCountSpan = document.getElementById('document-count');

        let currentCategoryFilter = '';
        let currentInventoryMode = DOCS_REF;
        const FIXED_CATEGORY = 'ESCANER 600';

        const MONTHS = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        const FALLBACK_COUNTRIES = ["ESPA√ëA", "FRANCIA", "ALEMANIA", "USA", "CANADA", "ARGENTINA"];
        const FALLBACK_DOC_TYPES = ["PSP", "CI", "PNC", "PIC", "VEHICULOS", "GENERAL", "CERTIFICADOS"];
        
        // üö® [CORRECCI√ìN] Lista de TIPOS DE DOCUMENTO conocidos.
        // A√±ade aqu√≠ cualquier TIPO nuevo que uses (ej: "LICENCIA", "PERMISO")
        const KNOWN_DOC_TYPES = new Set(["PSP", "CI", "PNC", "PIC", "VEHICULOS", "GENERAL", "CERTIFICADOS", "DNI", "NIE", "PASAPORTE", "DEFENSA", "REV"]);

        let FULL_DOCUMENT_LIST = [];
        let ALL_DOCUMENTS = [];

        // Set din√°mico para pa√≠ses que *realmente* tienen subnodos en la BBDD (usado para rellenar Datalist-States)
        let COUNTRIES_WITH_SUBNODES_DYNAMIC = new Set();
        
        // Lista EST√ÅTICA de pa√≠ses que *deben mostrar* el campo de subnodo
        const STATIC_COUNTRIES_WITH_SUBNODES = new Set(['USA', 'CANADA', 'ARGENTINA', 'MEXICO']);

        // üö® [ELIMINADO] La lista 'KNOWN_SUBTYPES' se ha eliminado. Era la fuente del error.
        // El sistema ahora detecta TODOS los subtipos din√°micamente.

        // **********************************************
        //           [ L√ìGICA DE DATALISTS Y SUBTIPOS ]
        // **********************************************

        function populateDatalist(id, items) {
            const datalist = document.getElementById(id);
            if (!datalist) return;

            datalist.innerHTML = '';
            const validItems = items.filter(item => item);
            const uniqueItems = Array.from(new Set(validItems.map(item => item.toUpperCase()))).sort();

            uniqueItems.forEach(item => {
                if (item) {
                    const option = document.createElement('option');
                    option.value = item;
                    datalist.appendChild(option);
                }
            });
        }


        function loadAllDynamicDatalists(docList) {
            // 1. Pa√≠ses
            const existingCountries = new Set(docList.map(doc => doc.data.Pais).filter(p => p && p !== 'N/A' && p !== 'EEUU USA'));
            populateDatalist('datalist-countries', Array.from(existingCountries));

            // 2. Tipos
            const existingTypes = new Set(docList.map(doc => doc.data.TipoDocumento).filter(t => t && t !== 'N/A'));
            populateDatalist('datalist-types', Array.from(existingTypes));

            // 3. Estados (Subtipos)
            const states = new Set();
            docList.forEach(doc => {
                // üö® [CORRECCI√ìN] Solo a√±adir a 'states' si el pa√≠s es uno de los est√°ticos
                if (STATIC_COUNTRIES_WITH_SUBNODES.has(doc.data.Pais) && doc.data.SubtipoDocumento && doc.data.SubtipoDocumento !== 'N/A') {
                    states.add(doc.data.SubtipoDocumento);
                }
            });
            populateDatalist('datalist-states', Array.from(states));
        }

        function updateScopedDatalists(docList) {
            // 1. Tipos
            const existingTypes = new Set(docList.map(doc => doc.data.TipoDocumento).filter(t => t && t !== 'N/A'));
            populateDatalist('datalist-types', Array.from(existingTypes));

            // 2. Estados (Subtipos)
            const states = new Set();
            docList.forEach(doc => {
                 // üö® [CORRECCI√ìN] Solo a√±adir a 'states' si el pa√≠s es uno de los est√°ticos
                if(STATIC_COUNTRIES_WITH_SUBNODES.has(doc.data.Pais) && doc.data.SubtipoDocumento && doc.data.SubtipoDocumento !== 'N/A') {
                    states.add(doc.data.SubtipoDocumento);
                }
            });
            populateDatalist('datalist-states', Array.from(states));
        }


        window.handleCountryChange = function(countryValue) {
            const country = countryValue.trim().toUpperCase();

            let normalizedCountry = country;
            if (normalizedCountry === 'ESTADOS UNIDOS') normalizedCountry = 'USA';
            if (normalizedCountry === 'CANAD√Å') normalizedCountry = 'CANADA';

            const label = document.getElementById('state-region-label');

            // Comprobamos contra la lista EST√ÅTICA
            if (STATIC_COUNTRIES_WITH_SUBNODES.has(normalizedCountry)) {
                console.log(`Pa√≠s ${normalizedCountry} S√ç est√° en la lista EST√ÅTICA, mostrando campo.`);
                
                if (normalizedCountry === 'USA') {
                    label.textContent = 'ESTADO/REGI√ìN (Solo USA):';
                    searchStateRegionInput.placeholder = 'Ej: ALASKA, ILLINOIS';
                } else if (normalizedCountry === 'CANADA') {
                    label.textContent = 'PROVINCIA/TERRITORIO (Solo Canad√°):';
                    searchStateRegionInput.placeholder = 'Ej: QUEBEC, BRITISH COLUMBIA';
                } else if (normalizedCountry === 'ARGENTINA') {
                    label.textContent = 'PROVINCIA (Solo Argentina):';
                    searchStateRegionInput.placeholder = 'Ej: BUENOS AIRES, C√ìRDOBA';
                } else if (normalizedCountry === 'MEXICO') {
                    label.textContent = 'ESTADO (Solo M√©xico):';
                    searchStateRegionInput.placeholder = 'Ej: JALISCO, QUINTANA ROO';
                } else {
                    label.textContent = 'ESTADO/PROVINCIA/CIUDAD:';
                    searchStateRegionInput.placeholder = `Ej: Sub-regi√≥n`;
                }
                stateRegionContainer.style.display = 'block';
            } else {
                console.log(`Pa√≠s ${normalizedCountry} NO est√° en la lista EST√ÅTICA, ocultando campo.`);
                stateRegionContainer.style.display = 'none';
                searchStateRegionInput.value = '';
            }

            const modeDocs = FULL_DOCUMENT_LIST.filter(doc => {
                return doc.key && doc.key.startsWith(currentInventoryMode);
            });

            let docsForDatalists = modeDocs;
            if (normalizedCountry) {
                docsForDatalists = modeDocs.filter(doc => {
                    return doc.data && doc.data.Pais === normalizedCountry;
                });
            }
            
            updateScopedDatalists(docsForDatalists);
            filterDocuments();
        }

        // **********************************************
        //               [ GESTI√ìN DE MODOS ]
        // **********************************************

        window.setInventoryMode = function(mode) {
            const btnPersonas = document.getElementById('mode-personas-btn');
            const btnVehiculos = document.getElementById('mode-vehiculos-btn');
            btnPersonas.classList.remove('active');
            btnVehiculos.classList.remove('active');

            const modeBase = mode.endsWith('/') ? mode.slice(0, -1) : mode;
            currentInventoryMode = modeBase + '/'; 

            console.log("Cambiando modo a:", currentInventoryMode);

            if (modeBase === VEHICLES_REF.slice(0, -1)) {
                btnVehiculos.classList.add('active');
            } else {
                btnPersonas.classList.add('active');
            }

            const modeDocs = FULL_DOCUMENT_LIST.filter(doc => {
                return doc.key && doc.key.startsWith(currentInventoryMode);
            });

            loadAllDynamicDatalists(modeDocs);
            handleCountryChange(searchCountryInput.value);
        }


        // *****************************************************************
        // üö® FUNCI√ìN CLAVE DE LECTURA UNIFICADA Y L√ìGICA DE INFERENCIA üö®
        // *****************************************************************

        function loadAllDocuments() {
            if (!database) {
                populateDatalist('datalist-countries', FALLBACK_COUNTRIES);
                populateDatalist('datalist-types', FALLBACK_DOC_TYPES);
                searchResultsDiv.innerHTML = `<div class="modern-alert modern-alert-error"><i class="fas fa-exclamation-circle fa-2x"></i><h4 style="color: #e74c3c; margin-top: 10px;">Modo Desconectado</h4><p>No se pudo conectar a la base de datos.</p></div>`;
                updateDocumentCount([]);
                return;
            }

            documentCountSpan.textContent = `(Cargando todo el inventario: Documentos y Veh√≠culos... Por favor, espere.)`;
            FULL_DOCUMENT_LIST = [];
            COUNTRIES_WITH_SUBNODES_DYNAMIC.clear(); 

             const fetchAndProcessNode = (refPath) => {
                return database.ref(refPath).once('value').then(snapshot => {
                    const nestedData = snapshot.val();
                    const documents = [];

                    if (!nestedData) return documents;

                    // Itera sobre PAIS_TIPO (ej: 'ALBANIA_CI', 'USA_PNC', o 'CANADA_QUEBEC')
                    for (const combinedKey in nestedData) {
                        if (nestedData.hasOwnProperty(combinedKey)) {
                            const countryTypeData = nestedData[combinedKey];

                            let inferredCountryFromKey = 'N/A';
                            let inferredTypeFromKey = 'N/A';

                            const lastUnderscoreIndex = combinedKey.lastIndexOf('_');
                            if (lastUnderscoreIndex !== -1) {
                                inferredCountryFromKey = combinedKey.substring(0, lastUnderscoreIndex).toUpperCase();
                                inferredTypeFromKey = combinedKey.substring(lastUnderscoreIndex + 1).toUpperCase();
                            } else {
                                inferredCountryFromKey = combinedKey.toUpperCase();
                                inferredTypeFromKey = 'GENERAL';
                            }
                             
                            if (inferredCountryFromKey === 'ESTADOS UNIDOS') inferredCountryFromKey = 'USA';
                            if (inferredCountryFromKey === 'CANAD√Å') inferredCountryFromKey = 'CANADA';

                            let currentInferredType = inferredTypeFromKey;

                            for(const key in countryTypeData){
                                if (countryTypeData.hasOwnProperty(key)) {
                                    const value = countryTypeData[key]; 

                                    // ¬øEs un subnodo (Estado/Provincia)? (Ej: CANADA_PNC/QUEBEC)
                                     if (typeof value === 'object' && value !== null && key.toUpperCase() !== 'GENERAL' &&
                                         !value.hasOwnProperty('Timestamp') && !value.hasOwnProperty('NombreDocumento') && !value.hasOwnProperty('Enlace'))
                                     {
                                        const documentsInSubnode = value;
                                        const currentSubnode = key.toUpperCase();

                                        for (const docKey in documentsInSubnode) {
                                            if (documentsInSubnode.hasOwnProperty(docKey)) {
                                                const data = documentsInSubnode[docKey];
                                                if(typeof data === 'object' && data !== null){
                                                   const doc = processDocument(refPath, combinedKey, currentSubnode, docKey, data, inferredCountryFromKey, currentInferredType);
                                                   if (doc) documents.push(doc);
                                                } else {
                                                    console.warn(`Dato inv√°lido encontrado bajo subnodo ${currentSubnode} con clave ${docKey} en ${refPath}${combinedKey}`);
                                                }
                                            }
                                        }
                                    }
                                    // ¬øEs un documento?
                                    else if (typeof value === 'object' && value !== null &&
                                             (value.hasOwnProperty('Timestamp') || value.hasOwnProperty('NombreDocumento') || value.hasOwnProperty('Enlace')))
                                    {
                                        const data = value;
                                        const docKey = key;
                                        const doc = processDocument(refPath, combinedKey, null, docKey, data, inferredCountryFromKey, currentInferredType);
                                         if (doc) documents.push(doc);
                                    }
                                     // Caso especial: carpeta 'GENERAL'
                                    else if (key.toUpperCase() === 'GENERAL' && typeof value === 'object' && value !== null)
                                    {
                                        const documentsInGeneral = value;
                                         for (const docKey in documentsInGeneral) {
                                            if (documentsInGeneral.hasOwnProperty(docKey)) {
                                                const data = documentsInGeneral[docKey];
                                                 if(typeof data === 'object' && data !== null){
                                                    const doc = processDocument(refPath, combinedKey, null, docKey, data, inferredCountryFromKey, currentInferredType);
                                                     if (doc) documents.push(doc);
                                                } else {
                                                     console.warn(`Dato inv√°lido encontrado bajo GENERAL con clave ${docKey} en ${refPath}${combinedKey}`);
                                                 }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    return documents;
                });
            };


            /**
             * üö® [CORRECCI√ìN] Funci√≥n de procesamiento de documentos (v4 - La buena)
             */
            function processDocument(refPath, combinedKey, subnode, docKey, data, inferredCountry, inferredType) {
                 if (typeof data !== 'object' || data === null) { 
                     console.error(`Error procesando documento: 'data' no es un objeto v√°lido para la clave ${docKey} en ${refPath}${combinedKey}${subnode ? '/'+subnode : ''}`);
                     return null; 
                }

                const doc = {
                    key: refPath + combinedKey + (subnode ? `/${subnode}/` : '/') + docKey,
                    data: data,
                };

                // 1. Nombre
                let baseName = data.NombreArchivo || data.NombreDocumento || docKey;
                doc.data.NombreDocumento = baseName.replace(/\.(JPG|JPEG|PNG|PDF|DOCX|XLSX)$/i, '').replace(/_/g, ' ').trim();

                // 2. Pa√≠s
                let finalCountry = (data.Pais && data.Pais !== 'N/A' && data.Pais !== 'EEUU USA') ? data.Pais.toUpperCase() : inferredCountry;
                if (finalCountry === 'ESTADOS UNIDOS') finalCountry = 'USA';
                if (finalCountry === 'CANAD√Å') finalCountry = 'CANADA';
                doc.data.Pais = finalCountry;

                // 3. üö® L√ìGICA DE TIPO vs SUBTIPO (FINAL)
                let finalType = 'GENERAL';
                let finalSubtipo = 'N/A';

                // Prioridad 1: La estructura es PAIS_TIPO/SUBTIPO (ej: USA_PNC/ALASKA)
                if (subnode) {
                    finalSubtipo = subnode.toUpperCase(); // "ALASKA"
                    if (KNOWN_DOC_TYPES.has(inferredType)) {
                        finalType = inferredType; // "PNC"
                    } else {
                        // 'inferredType' no era un tipo, as√≠ que lo extraemos del nombre
                        finalType = extractTypeFromName(doc.data.NombreDocumento, finalCountry, finalSubtipo); // Pasa subtipo para limpiarlo
                    }
                } 
                // Prioridad 2: La estructura es PAIS_TIPO (ej: USA_PNC) o PAIS_SUBTIPO (ej: CANADA_BRITISH_COLUMBIA)
                else {
                    // Caso 2A: Es PAIS_TIPO (ej: "USA_PNC")
                    if (KNOWN_DOC_TYPES.has(inferredType)) {
                        finalType = inferredType; // "PNC"
                        
                        // Para PAIS_TIPO, el subtipo S√ìLO puede venir de los datos internos.
                        // (El usuario debe etiquetarlo manualmente la primera vez)
                        if (data.SubtipoDocumento && data.SubtipoDocumento !== 'N/A' && data.SubtipoDocumento !== 'General') {
                            finalSubtipo = data.SubtipoDocumento.toUpperCase();
                        }
                        // NO intentamos adivinarlo del nombre, eso era muy propenso a errores.
                    } 
                    
                    // Caso 2B: Es PAIS_SUBTIPO (ej: "CANADA_BRITISH_COLUMBIA")
                    // (Es un pa√≠s especial Y el 'inferredType' NO es un tipo de documento)
                    else if (STATIC_COUNTRIES_WITH_SUBNODES.has(finalCountry)) {
                        finalSubtipo = inferredType; // "BRITISH_COLUMBIA"
                        
                        // Como la carpeta no nos dio el tipo, lo extraemos del nombre
                        finalType = extractTypeFromName(doc.data.NombreDocumento, finalCountry, finalSubtipo);
                    } 
                    
                    // Caso 2C: Es PAIS_OTRACOSA (ej: "ALEMANIA_LICENCIA")
                    else {
                        finalType = inferredType; // "LICENCIA"
                        if (data.SubtipoDocumento && data.SubtipoDocumento !== 'N/A' && data.SubtipoDocumento !== 'General') {
                            finalSubtipo = data.SubtipoDocumento.toUpperCase();
                        }
                    }
                }

                doc.data.TipoDocumento = finalType.toUpperCase();
                doc.data.SubtipoDocumento = finalSubtipo.toUpperCase();
                
                // A√±adir al set din√°mico para rellenar Datalist-States
                 if (doc.data.SubtipoDocumento && doc.data.SubtipoDocumento !== 'N/A') {
                     COUNTRIES_WITH_SUBNODES_DYNAMIC.add(finalCountry);
                 }

                // 4. FECHA
                doc.data.Fecha = extractDateFromName('dummy-input', 'dummy-display', doc.data.NombreDocumento) || 'N/A';
                // 6. CATEGOR√çA
                doc.data.Categoria = FIXED_CATEGORY;
                // 7. Enlace
                doc.data.Enlace = data.Enlace || 'N/A';

                return doc;
            }

            Promise.all([
                fetchAndProcessNode(DOCS_REF),
                fetchAndProcessNode(VEHICLES_REF)
            ]).then(([docList, vehicleList]) => {
                FULL_DOCUMENT_LIST = [...docList, ...vehicleList].filter(doc => doc !== null);
                console.log(`‚úÖ Documentos cargados. Total: ${FULL_DOCUMENT_LIST.length}`);
                console.log("Pa√≠ses con subnodos detectados (para datalists):", Array.from(COUNTRIES_WITH_SUBNODES_DYNAMIC));

                setCategoryFilter('');
                setInventoryMode(DOCS_REF.slice(0, -1));

            }).catch(errorObject => {
                console.error("‚ùå Error al leer de Firebase:", errorObject.code, errorObject.message);
                populateDatalist('datalist-countries', FALLBACK_COUNTRIES);
                populateDatalist('datalist-types', FALLBACK_DOC_TYPES);
                document.getElementById('search-results').innerHTML = `
                    <div class="modern-alert modern-alert-error">
                        <i class="fas fa-exclamation-circle fa-2x"></i>
                        <h4 style="color: #e74c3c; margin-top: 10px;">Error de Conexi√≥n o Permisos</h4>
                        <p>No se pudo leer la base de datos (${errorObject.message}). Por favor, revisa las **Reglas de Seguridad** o el **Nombre del Nodo**.</p>
                    </div>
                 `;
                 updateDocumentCount([]);
            });
        }


        // **********************************************
        //               [ FUNCIONES DE L√ìGICA Y CRUD ]
        // **********************************************

        window.extractDateFromName = function(nameInputId, dateDisplayId, nameString = null) {
            const name = (nameString !== null ? nameString : document.getElementById(nameInputId).value.trim()).toUpperCase();
            const display = document.getElementById(dateDisplayId);
            const dateMatch = name.match(/(\d{4}[-/]\d{2}[-/]\d{2})|(\d{4}\d{2}\d{2})|(\d{4}(?:\s|-|\.|$))/);
            let normalizedDate = null;
            let displayValue = 'Pendiente...';

            if (dateMatch) {
                let dateStr = dateMatch[0];
                if (dateMatch[1]) { 
                    normalizedDate = dateMatch[1].replace(/(\d{4})\D(\d{2})\D(\d{2})/, '$1-$2-$3');
                    displayValue = `Fecha extra√≠da: ${normalizedDate}`;
                } else if (dateMatch[2]) { 
                    normalizedDate = dateMatch[2].substring(0, 4) + '-' + dateMatch[2].substring(4, 6) + '-' + dateMatch[2].substring(6, 8);
                    displayValue = `Fecha extra√≠da: ${normalizedDate}`;
                } else if (dateMatch[3]) { 
                    normalizedDate = dateMatch[3].substring(0, 4) + '-01-01';
                    displayValue = `Fecha extra√≠da (A√±o): ${normalizedDate.substring(0,4)}`;
                }
            }

            if (display && nameString === null) {
                display.textContent = displayValue;
                display.style.color = normalizedDate ? '#27ae60' : '#e74c3c';
            }
            if (nameInputId.includes('edit-doc') && nameString === null) {
                document.getElementById('edit-doc-fecha-hidden').value = normalizedDate || '';
            }
            return normalizedDate;
        }

        /**
         * üö® [CORRECCI√ìN] Funci√≥n para extraer el TIPO del nombre.
         * Ahora limpia el pa√≠s y el subtipo (si se pasa) ANTES de buscar el tipo.
         */
        window.extractTypeFromName = function(name, country, subtipo) {
            if (!name) return 'GENERAL';
            let cleanName = name.toUpperCase().trim();
            cleanName = cleanName.replace(/\.(JPG|JPEG|PNG|PDF|DOCX|XLSX)$/i, '').replace(/_/g, ' ').trim();

            const dateMatch = cleanName.match(/(\d{4}[-/]\d{2}[-/]\d{2})|(\d{4}\d{2}\d{2})|(\d{4}(?:\s|-|\.|$))/);
            let typePart = cleanName;

            // Si hay fecha, coger el texto de antes
            if (dateMatch && dateMatch.index > 0) {
                typePart = cleanName.substring(0, dateMatch.index).trim();
            }

            // Limpiar pa√≠s y subtipo (si se conoce) para no confundirlos con un tipo
            if (country) {
                 typePart = typePart.replace(country, '').trim();
            }
            if (subtipo && subtipo !== 'N/A') {
                 // Reemplaza el subtipo (ej "BRITISH COLUMBIA") por un espacio
                 const regex = new RegExp(`\\b${subtipo.replace('_', ' ')}\\b`, 'g');
                 typePart = typePart.replace(regex, '').trim();
            }

            // De lo que queda, buscar un TIPO conocido
            const words = typePart.split(/[\s_-]+/);
            for (const word of words) {
                if (KNOWN_DOC_TYPES.has(word)) {
                    return word; // Devuelve el primer TIPO conocido
                }
            }
            
            // Fallback: Devolver la primera palabra restante
            if (words.length > 0 && words[0] !== '') {
                return words[0]; 
            }
            
            return 'GENERAL';
        }

        // üö® [ELIMINADO] La funci√≥n 'extractSubtypeFromName' se ha eliminado.
        // No era fiable y causaba la regresi√≥n de Canad√°.
        // El subtipo AHORA se obtiene de:
        // 1. La carpeta (subnode)
        // 2. La carpeta (inferredType, si no es un TIPO)
        // 3. Los datos del documento (data.SubtipoDocumento)


        function updateDocumentCount(currentResults) {
            const totalDocs = FULL_DOCUMENT_LIST.length;
            let countText = '';
            const totalCategoryDocs = currentCategoryFilter
                ? FULL_DOCUMENT_LIST.filter(doc => doc.data && (doc.data.Categoria || FIXED_CATEGORY) === currentCategoryFilter).length
                : totalDocs;

            if (currentResults.length > 0) {
                const categoryInfo = currentCategoryFilter ? `(Cat: ${totalCategoryDocs})` : '';
                countText = `(${currentResults.length} de ${totalCategoryDocs} encontrados)`;
            } else if (totalDocs === 0) {
                 countText = `(0 documentos en el inventario)`;
            } else if (searchCountryInput.value.trim()) {
                countText = `(0 resultados. Total en Categor√≠a: ${totalCategoryDocs})`;
            } else {
                if (currentCategoryFilter) {
                    countText = `(Total Inventario: ${totalDocs} | Categor√≠a ${currentCategoryFilter}: ${totalCategoryDocs})`;
                } else {
                    countText = `(${totalDocs} documentos totales en el inventario unificado)`;
                }
            }
            documentCountSpan.textContent = countText;
        }

        window.setCategoryFilter = function(category) {
            currentCategoryFilter = category;
            document.querySelectorAll('.filter-buttons button').forEach(btn => btn.classList.remove('active'));

            if (category === 'ESCANER 2400') {
                document.getElementById('filter-2400-btn').classList.add('active');
            } else if (category === 'ESCANER 600') {
                document.getElementById('filter-600-btn').classList.add('active');
            } else if (category === 'F√çSICO') {
                document.getElementById('filter-fisico-btn').classList.add('active');
            } else {
                document.getElementById('filter-todos-btn').classList.add('active');
            }

            ALL_DOCUMENTS = FULL_DOCUMENT_LIST.filter(doc => {
                const docCategory = doc.data ? (doc.data.Categoria || FIXED_CATEGORY) : FIXED_CATEGORY;
                return !category || docCategory === category;
            });

            filterDocuments();
        }

       function renderDocRow(key, data) {
            if (!data) {
                console.error("Intentando renderizar fila sin datos v√°lidos para la clave:", key);
                return document.createElement('div');
            }

            const row = document.createElement('div');
            row.classList.add('doc-row');

            const linkUrl = data.Enlace && data.Enlace !== 'N/A' ? data.Enlace : '#';
            const linkTarget = data.Enlace && data.Enlace !== 'N/A' ? '_blank' : '';
            const linkIsAvailable = data.Enlace && data.Enlace !== 'N/A';

            const displayDate = data.Fecha && data.Fecha.length >= 7 ? data.Fecha : 'N/A';
            const displayCategory = data.Categoria || FIXED_CATEGORY;

            const linkIconHtml = linkIsAvailable
                ? `<a href="${linkUrl}" target="${linkTarget}" class="link-icon" title="Ver archivo"><i class="fas fa-eye"></i></a>`
                : `<i class="fas fa-eye link-icon-disabled" title="Enlace no disponible"></i>`;

            // L√≥gica de visualizaci√≥n de Pa√≠s/Subtipo (usa la lista EST√ÅTICA)
            let displayCountry = data.Pais || 'N/A';
            if (STATIC_COUNTRIES_WITH_SUBNODES.has(data.Pais) && data.SubtipoDocumento && data.SubtipoDocumento !== 'N/A') {
                displayCountry = `${data.SubtipoDocumento} (${data.Pais})`;
            }


            row.innerHTML = `
                <div>${data.NombreDocumento || 'S/N'}</div>
                <div>${displayCountry}</div>
                <div>${data.TipoDocumento || 'N/A'}</div>
                <div>${displayDate}</div>
                <div>${displayCategory}</div>
                <div class="link-icon-container">${linkIconHtml}</div>
                <div class="doc-actions">
                    <button class="btn-warning" onclick="openEditModal('${key}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-delete" onclick="deleteDocument('${key}', '${data.NombreDocumento || 'este documento'}')"><i class="fas fa-trash"></i></button>
                </div>
            `;
            return row;
        }

        function filterDocuments() {
            const countryQ = searchCountryInput.value.trim().toUpperCase();
            const typeQ = searchTypeInput.value.trim().toUpperCase();
            const yearQ = searchYearInput.value.trim();
            const monthQ = searchMonthSelect.value;
            const namePartialQ = searchNamePartialInput.value.trim().toUpperCase();
            const stateRegionQ = searchStateRegionInput.value.trim().toUpperCase();

            searchResultsDiv.innerHTML = '';
            resultsHeader.style.display = 'none';

            if (!countryQ) {
                searchResultsDiv.innerHTML = `
                    <div class="modern-alert">
                        <i class="fas fa-filter fa-2x"></i>
                        <h4 style="color: #3498db; margin-top: 10px;">B√∫squeda Restringida</h4>
                        <p>Por favor, introduce el **PA√çS** (<span class="required-label">OBLIGATORIO</span>) para iniciar la b√∫squeda en el inventario unificado.</p>
                    </div>
                `;
                updateDocumentCount([]);
                return;
            }

            let matchFound = false;

            const filtered = ALL_DOCUMENTS.filter(doc => {
                 if (!doc || !doc.data) return false;
                const data = doc.data;

                const docFecha = data.Fecha || '';
                const docYear = docFecha.substring(0, 4);
                const docMonth = docFecha.substring(5, 7);
                const docName = data.NombreDocumento ? data.NombreDocumento.toUpperCase() : '';
                const docType = data.TipoDocumento ? data.TipoDocumento.toUpperCase() : 'GENERAL';
                const docPais = data.Pais ? data.Pais.toUpperCase() : 'N/A';
                const docSubtipo = data.SubtipoDocumento ? data.SubtipoDocumento.toUpperCase() : 'N/A';

                // Filtro por MODO
                const isVehiculo = doc.key && doc.key.startsWith(VEHICLES_REF);
                if (currentInventoryMode === VEHICLES_REF) {
                    if (!isVehiculo) return false;
                } else if (currentInventoryMode === DOCS_REF) {
                    if (isVehiculo) return false;
                }

                // 1. FILTRO PA√çS
                let normalizedCountryQ = countryQ;
                if (normalizedCountryQ === 'ESTADOS UNIDOS') normalizedCountryQ = 'USA';
                if (normalizedCountryQ === 'CANAD√Å') normalizedCountryQ = 'CANADA';
                 if (docPais !== normalizedCountryQ) return false;

                // 2. FILTRO ESTADO/REGI√ìN (usa la lista EST√ÅTICA)
                if (STATIC_COUNTRIES_WITH_SUBNODES.has(normalizedCountryQ) && stateRegionQ) {
                    if (docSubtipo.indexOf(stateRegionQ) === -1) return false;
                }

                // 3. FILTROS OPCIONALES
                if (typeQ && docType.indexOf(typeQ) === -1) return false;
                if (yearQ && docYear.indexOf(yearQ) === -1) return false;
                if (monthQ && docMonth !== monthQ) return false;
                if (namePartialQ && docName.indexOf(namePartialQ) === -1) return false;

                return true;
            });


            if (filtered.length > 0) {
                resultsHeader.style.display = 'grid';
                filtered.sort((a, b) => {
                    const nameA = a.data && a.data.NombreDocumento ? a.data.NombreDocumento : '';
                    const nameB = b.data && b.data.NombreDocumento ? b.data.NombreDocumento : '';
                    return nameA.localeCompare(nameB);
                });
                filtered.forEach(doc => {
                    searchResultsDiv.appendChild(renderDocRow(doc.key, doc.data));
                });
                matchFound = true;
            }


            if (!matchFound) {
                 searchResultsDiv.innerHTML = `
                    <div class="modern-alert modern-alert-error">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <h4 style="color: #e67e22; margin-top: 10px;">Sin Resultados</h4>
                        <p>No se encontraron documentos que coincidan con los filtros aplicados en el modo activo.</p>
                    </div>
                 `;
            }
            updateDocumentCount(filtered);
        }

        function clearSearch() {
            searchCountryInput.value = '';
            searchTypeInput.value = '';
            searchYearInput.value = '';
            searchMonthSelect.value = '';
            searchNamePartialInput.value = '';
            searchStateRegionInput.value = '';
            handleCountryChange('');
            currentCategoryFilter = '';
            document.querySelectorAll('.filter-buttons button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter-todos-btn').classList.add('active');
            setCategoryFilter(currentCategoryFilter);
        }

        window.updateModalCountrySpecificFields = function(countryValue) {
            const country = countryValue.trim().toUpperCase();
            const editStateContainer = document.getElementById('edit-state-region-container');
            const editStateLabel = document.getElementById('edit-state-region-label');
            const editSubtipoInput = document.getElementById('edit-doc-subtipo');

            let normalizedCountry = country;
            if (normalizedCountry === 'ESTADOS UNIDOS') normalizedCountry = 'USA';
            if (normalizedCountry === 'CANAD√Å') normalizedCountry = 'CANADA';

            if (STATIC_COUNTRIES_WITH_SUBNODES.has(normalizedCountry)) {
                if (normalizedCountry === 'USA') {
                    editStateLabel.innerHTML = '<i class="fas fa-map-marker-alt"></i> Estado/Regi√≥n (Solo USA):';
                    editSubtipoInput.placeholder = 'Ej: ALASKA';
                } else if (normalizedCountry === 'CANADA') {
                    editStateLabel.innerHTML = '<i class="fas fa-map-marker-alt"></i> Provincia/Territorio (Solo Canad√°):';
                    editSubtipoInput.placeholder = 'Ej: QUEBEC';
                } else if (normalizedCountry === 'ARGENTINA') {
                    editStateLabel.innerHTML = '<i class="fas fa-map-marker-alt"></i> Provincia (Solo Argentina):';
                    editSubtipoInput.placeholder = 'Ej: BUENOS AIRES';
                } else if (normalizedCountry === 'MEXICO') {
                    editStateLabel.innerHTML = '<i class="fas fa-map-marker-alt"></i> Estado (Solo M√©xico):';
                    editSubtipoInput.placeholder = 'Ej: JALISCO';
                } else {
                    editStateLabel.innerHTML = '<i class="fas fa-map-marker-alt"></i> Estado/Provincia/Ciudad:';
                    editSubtipoInput.placeholder = 'Ej: Sub-regi√≥n';
                }
                editStateContainer.style.display = 'block';
            } else {
                editStateContainer.style.display = 'none';
                editSubtipoInput.value = '';
            }
        }

        window.openEditModal = function(fullKey) {
             if (!database) return alert("‚ùå No hay conexi√≥n a Firebase. No se puede editar.");

            const doc = FULL_DOCUMENT_LIST.find(d => d.key === fullKey);
            if (!doc || !doc.data) {
                console.error("Error: Documento no encontrado o sin datos para la clave:", fullKey);
                return alert("Error: Documento no encontrado o datos inv√°lidos.");
            }

            const data = doc.data;
            const editModal = document.getElementById('edit-modal');

            document.getElementById('edit-doc-key').value = fullKey;
            document.getElementById('edit-doc-country').value = data.Pais || '';
            document.getElementById('edit-doc-type').value = data.TipoDocumento || '';
            document.getElementById('edit-doc-name').value = data.NombreDocumento || '';
            document.getElementById('edit-doc-category').value = FIXED_CATEGORY;
            document.getElementById('edit-doc-link').value = data.Enlace === 'N/A' ? '' : (data.Enlace || '');

            extractDateFromName('edit-doc-name', 'edit-doc-date-display', data.NombreDocumento);
            updateLinkPreview('edit-doc-link', 'edit-link-preview');

            updateModalCountrySpecificFields(data.Pais || '');
            document.getElementById('edit-doc-subtipo').value = (data.SubtipoDocumento === 'N/A' || !data.SubtipoDocumento) ? '' : data.SubtipoDocumento;

            editModal.style.display = 'flex';
        }

        window.updateDocument = async function() {
            if (!database) {
                 alert("‚ùå No hay conexi√≥n a Firebase. No se puede actualizar el documento.");
                 return;
            }

            const fullKey = document.getElementById('edit-doc-key').value;
            let pais = document.getElementById('edit-doc-country').value.trim().toUpperCase();
            const tipo = document.getElementById('edit-doc-type').value.trim().toUpperCase();
            const nombre = document.getElementById('edit-doc-name').value.trim();
            const subtipo = document.getElementById('edit-doc-subtipo').value.trim().toUpperCase() || 'N/A';
            const categoria = FIXED_CATEGORY;
            const enlace = document.getElementById('edit-doc-link').value.trim();

            const fechaCompleta = extractDateFromName('edit-doc-name', 'edit-doc-date-display');

            if (!pais || !tipo || !nombre) {
                alert("‚ö†Ô∏è Por favor, rellena Pa√≠s, Tipo y Nombre del Documento.");
                return;
            }
            if (!fechaCompleta) {
                 alert("‚ö†Ô∏è No se pudo extraer la fecha del nombre. Por favor, revisa el nombre.");
                 return;
            }

            if (pais === 'ESTADOS UNIDOS') pais = 'USA';
            if (pais === 'CANAD√Å') pais = 'CANADA';

             if (!KNOWN_DOC_TYPES.has(tipo) && STATIC_COUNTRIES_WITH_SUBNODES.has(pais)) {
                 console.warn(`Aviso: "${tipo}" no es un TIPO de documento est√°ndar (PNC, CI...). Aseg√∫rate de que no sea un estado/provincia.`);
             }

            const updatedData = {
                Pais: pais,
                TipoDocumento: tipo,
                NombreDocumento: nombre,
                SubtipoDocumento: subtipo,
                Fecha: fechaCompleta,
                Categoria: categoria,
                Enlace: enlace || 'N/A',
                Timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            try {
                // üö® [CORRECCI√ìN] No podemos actualizar, porque la clave (key) depende de la estructura
                // Si el usuario cambia el pa√≠s o el tipo, la clave antigua es incorrecta.
                // La √∫nica forma segura es ELIMINAR la clave antigua y CREAR una nueva.
                // PERO, la estructura de la BBDD (PAIS_TIPO) no se puede cambiar desde aqu√≠.
                
                // Vamos a mantener la l√≥gica de UPDATE. El usuario NO DEBER√çA cambiar
                // la estructura de carpetas (Pa√≠s/Tipo) desde el modal de edici√≥n, solo los datos.
                // Si cambia el pa√≠s, el documento se quedar√° en la carpeta antigua pero con datos nuevos.
                // Esto es un problema de dise√±o de la BBDD, pero 'update' es la acci√≥n m√°s segura.
                
                await database.ref(fullKey).update(updatedData);
                alert("‚úÖ Documento actualizado correctamente!");
                document.getElementById('edit-modal').style.display = 'none';
                loadAllDocuments(); // Recarga todo para reflejar los cambios
            } catch (error) {
                alert("‚ùå Error al actualizar el documento: " + error.message);
            }
        }

        window.deleteDocument = async function(fullKey, name) {
            if (!database) {
                 alert("‚ùå No hay conexi√≥n a Firebase. No se puede eliminar el documento.");
                 return;
            }

            if (confirm(`¬øEst√°s seguro de que quieres eliminar DEFINITIVAMENTE el documento "${name}"? Esta acci√≥n no se puede deshacer.`)) {
                try {
                    await database.ref(fullKey).remove();
                    loadAllDocuments();
                    alert(`‚úÖ Documento "${name}" eliminado.`);
                } catch (error) {
                     alert("‚ùå Error al eliminar el documento: " + error.message);
                }
            }
        }

        // **********************************************
        //               [ INICIALIZACI√ìN ]
        // **********************************************

        function enableDatalistDropdown(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('focus', function() {
                    const datalist = document.getElementById(this.getAttribute('list'));
                    if (datalist && datalist.options.length > 0) {
                       this.dispatchEvent(new KeyboardEvent('keydown', { key: 'ArrowDown', keyCode: 40, bubbles: true }));
                    }
                });
            }
        }


        function populateSelectors() {
            const monthSelectors = [document.getElementById('search-month')];
            MONTHS.forEach((month, index) => {
                const value = (index + 1).toString().padStart(2, '0');
                monthSelectors.forEach((selector) => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = month;
                    selector.appendChild(option);
                });
            });
        }

        document.addEventListener("DOMContentLoaded", () => {

            populateSelectors();
            populateDatalist('datalist-types', FALLBACK_DOC_TYPES);
            loadAllDocuments();

            enableDatalistDropdown('search-country');
            enableDatalistDropdown('search-type');
            enableDatalistDropdown('search-state-region');

            document.getElementById('edit-modal').addEventListener('click', (event) => {
                if (event.target === document.getElementById('edit-modal')) {
                    document.getElementById('edit-modal').style.display = "none";
                }
            });

            searchTypeInput.addEventListener('input', filterDocuments);
            searchYearInput.addEventListener('input', filterDocuments);
            searchMonthSelect.addEventListener('change', filterDocuments);
            searchNamePartialInput.addEventListener('input', filterDocuments);
            searchStateRegionInput.addEventListener('input', filterDocuments);
            document.getElementById('clear-search-btn').addEventListener('click', clearSearch);

        });
    </script>
</body>
</html>