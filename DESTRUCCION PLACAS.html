<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Destrucción de Placas - GAD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        main {
            flex: 1;
            padding: 2rem;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
        }
        
        /* AJUSTE DEL LOGO */
        .gad-logo-header {
            width: 150px; 
            height: 150px; 
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: transparent; 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0; 
        }
        .gad-logo-header img {
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            display: block;
        }

        /* Estilos para los botones de navegación */
        .nav-buttons .button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); 
            gap: 8px; 
            width: 100%; 
        }
        .nav-buttons .back-button {
            display: flex; 
            justify-content: center;
            align-items: center;
            padding: 1rem 1.5rem; 
            font-size: 1rem; 
            font-weight: bold;
            color: white;
            border-radius: 0.5rem;
            text-align: center;
            transition: background-color 0.15s ease;
            text-decoration: none; 
            height: 55px; 
        }

        /* Colores específicos para los botones */
        .button-green { background-color: #22c55e; } 
        .button-green:hover { background-color: #16a34a; }
        
        .button-blue-light { background-color: #38bdf8; } 
        .button-blue-light:hover { background-color: #0ea5e9; }
        
        .button-yellow { background-color: #facc15; } 
        .button-yellow:hover { background-color: #eab308; }
        
        .button-gray { background-color: #4b5563; } 
        .button-gray:hover { background-color: #374151; }

        /* Estilos generales de la tabla y modales (sin cambios relevantes) */
        .table-row-even { background-color: #f9fafb; }
        .table-row-odd { background-color: #ffffff; }
        .sort-header { cursor: pointer; user-select: none; }
        .sort-icon { margin-left: 0.5rem; }
        .delete-icon { color: #ef4444; cursor: pointer; transition: color 0.15s; }
        .delete-icon:hover { color: #b91c1c; }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: none;
            justify-content: center; align-items: center; z-index: 1000; overflow-y: auto;
        }
        .modal-content {
            background-color: white; padding: 2rem; border-radius: 0.75rem;
            width: 90%; max-width: 600px; box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            margin: 2rem 0;
        }

        /* NUEVO: Estilo para inputs de edición en línea */
        .inline-edit-input {
            border: 1px solid #3b82f6; /* blue-500 */
            padding: 4px;
            border-radius: 4px;
            width: 100%;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
        }
    </style>
</head>
<body>

    <header class="bg-blue-600 w-full flex justify-center items-center py-6">
        <div class="gad-logo-header">
            <img src="logogad.png" alt="Logo GAD" class="block">
        </div>
    </header>

    <main>
        <div class="flex justify-between items-start mb-6"> 

            <h1 class="text-3xl font-extrabold text-gray-900">
                Registro de Destrucción de Placas 
                <span class="text-xl font-semibold text-red-600 ml-4">(Total: <span id="plateCounter">0</span>)</span>
            </h1>
            <div class="nav-buttons flex flex-col items-end space-y-2"> 

                <div class="button-grid">
                    <button id="openNewPlateModal" class="back-button button-green">
                        <i class="fas fa-plus-circle mr-2"></i> Nueva Placa
                    </button>
                    <button id="openAnuladasModal" class="back-button button-blue-light">
                        <i class="fas fa-trash-restore mr-2"></i> Placas Anuladas (<span id="anuladasCount">0</span>)
                    </button>
                </div>
                <div class="button-grid">
                    <a href="index.html" class="back-button button-yellow">Volver a Menú Principal</a>
                    <button onclick="history.back()" class="back-button button-gray">Atrás</button>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-xl mb-8 border border-gray-200">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Generación y Consulta Rápida</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 items-end">
                <div class="col-span-1">
                    <label for="lotNumber" class="block text-sm font-medium text-gray-700 mb-1">Próximo Lote a Generar</label>
                    <input type="text" id="lotNumber" readonly 
                            class="w-full border-gray-300 rounded-md shadow-sm p-2.5 text-base bg-gray-100 font-bold cursor-default">
                </div>
                
                <div class="col-span-1">
                    <button id="generateLotButton" disabled
                            class="w-full px-6 py-2.5 bg-red-600 text-white font-bold rounded-md shadow-lg transition duration-150 ease-in-out hover:bg-red-700 disabled:bg-red-300 disabled:cursor-not-allowed text-base">
                        Generar Lote <span id="selectedCount" class="font-normal"> (0)</span>
                    </button>
                </div>

                <div class="col-span-1">
                    <label for="searchPlate" class="block text-sm font-medium text-gray-700 mb-1">Buscar Placa</label>
                    <div class="relative">
                        <input type="text" id="searchPlate" placeholder="Ej: GY846WR" 
                               class="w-full border-2 border-blue-300 rounded-xl shadow-lg focus:border-blue-500 focus:ring-4 focus:ring-blue-100 px-3 py-2.5 text-base font-medium uppercase transition duration-200">
                        <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-blue-500"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow-xl mb-8 border border-gray-200">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Administración de Lotes Creados</h2>
            <div class="overflow-x-auto shadow-md rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider w-2/12">Lote</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider w-2/12">EUROCOP Nº</th> 
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider w-2/12">Total de Placas</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider w-3/12">FECHA DE DESTRUCCIÓN</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider w-3/12">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="lotAdminBody" class="divide-y divide-gray-200">
                        <tr><td colspan="5" class="text-center py-3 text-gray-500"><i class="fas fa-spinner fa-spin"></i> Cargando lotes...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="overflow-x-auto shadow-md rounded-lg border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">
                            <input type="checkbox" id="selectAllCheckbox" class="rounded text-red-600 border-gray-300">
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">#</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12 sort-header" data-sort-by="PAIS">
                            País <span class="sort-icon" id="sortIconPAIS"></span>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/12 sort-header" data-sort-by="PLACA">
                            Placa <span class="sort-icon" id="sortIconPLACA"></span>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/12">Estado / Lote</th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">Acción</th>
                    </tr>
                </thead>
                <tbody id="platesTableBody" class="divide-y divide-gray-200">
                    <tr id="loadingRow"><td colspan="6" class="text-center py-4 text-gray-500"><i class="fas fa-spinner fa-spin"></i> Cargando datos...</td></tr>
                </tbody>
            </table>
        </div>
        
    </main>

<footer class="mt-auto text-center py-6 bg-gray-200">
    <div class="flex flex-col items-center">
        <hr class="border-t border-gray-400 w-11/12 max-w-md mx-auto mb-4">
        <p class="font-bold">GRUPO DE ANÁLISIS DOCUMENTAL</p>
        <p class="font-bold">POLICÍA LOCAL DE ALICANTE</p>
        <p>&copy; GAD - Todos los derechos reservados</p>
    </div>
</footer>

    <div id="newPlateModal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Añadir Nueva Placa</h3>
            <div class="space-y-4">
                <div>
                    <label for="newPlateCountry" class="block text-sm font-medium text-gray-700">País</label>
                    <input type="text" id="newPlateCountry" list="countryDatalist" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2.5 focus:border-blue-500 uppercase" placeholder="Ej: FRANCIA" required>
                    <datalist id="countryDatalist"></datalist>
                </div>
                <div>
                    <label for="newPlateNumber" class="block text-sm font-medium text-gray-700">Número de Placa</label>
                    <input type="text" id="newPlateNumber" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2.5 focus:border-blue-500 uppercase" placeholder="Ej: WX123YZ" required>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="closeNewPlateModal" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition">Cancelar</button>
                    <button id="saveNewPlateButton" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition"><i class="fas fa-save"></i> Guardar Placa</button>
                </div>
            </div>
        </div>
    </div>

    <div id="consultLotModal" class="modal">
        <div class="modal-content">
            <h3 id="consultLotTitle" class="text-2xl font-bold mb-4 text-gray-800">Placas del Lote</h3>
            <div class="h-64 overflow-y-auto border border-gray-300 rounded-md p-4 bg-gray-50">
                <ul id="consultLotList" class="space-y-1 text-gray-700">
                    </ul>
            </div>
            <div class="flex justify-between mt-6">
                <button id="exportLotToExcelButton" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition"><i class="fas fa-file-excel"></i> Exportar a Excel</button>
                <button id="closeConsultLotModal" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="anuladasModal" class="modal">
        <div class="modal-content max-w-2xl">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Placas Anuladas para Restauración</h3>
            <div class="h-96 overflow-y-auto border border-gray-300 rounded-md p-4 bg-gray-50">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider w-4/12">País</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider w-4/12">Placa</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider w-2/12">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="anuladasListBody" class="divide-y divide-gray-200">
                        <tr><td colspan="3" class="text-center py-4 text-gray-500">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end mt-6">
                <button id="closeAnuladasModal" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition">Cerrar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getDatabase, ref, get, update, push, remove } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";

        // 1. CONFIGURACIÓN DE TU PROYECTO (¡DEBES REEMPLAZAR LOS VALORES DE TUS CLAVES!)
        const firebaseConfig = {
            apiKey: "TU_API_KEY_AQUI", // <-- REEMPLAZA ESTE VALOR CON TU CLAVE REAL
            authDomain: "gad-alicante-f0d56.firebaseapp.com",
            databaseURL: "https://gad-alicante-f0d56-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gad-alicante-f0d56",
            storageBucket: "gad-alicante-f0d56.appspot.com",
            messagingSenderId: "1098616110904",
            appId: "TU_APP_ID_AQUI" // <-- REEMPLAZA ESTE VALOR CON TU ID REAL
        };

        // 2. Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        let allPlatesData = []; 
        let anuladasData = []; 
        let uniqueLots = {}; 
        let currentSort = { column: 'PLACA', direction: 'asc' };
        let lotEurocopData = {}; 
        let currentPlatesInConsultedLot = [];
        let knownCountries = []; 

        // --- FUNCIONES PRINCIPALES DE CARGA Y PERSISTENCIA ---
        
        async function loadLotMetadata() {
            try {
                const dbRef = ref(database, 'lotes');
                const snapshot = await get(dbRef);
                lotEurocopData = {}; 

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    Object.entries(data).forEach(([lotNumber, metadata]) => {
                        if (metadata.eurocop) {
                            lotEurocopData[lotNumber] = metadata.eurocop;
                        }
                    });
                }
            } catch (error) {
                console.error("Error al cargar metadatos de lotes (EUROCOP):", error);
            }
        }
        
        async function saveEurocopValue(inputElement) {
            const lotNumber = inputElement.dataset.lotNumber; 
            const value = inputElement.value.trim();
            
            if (lotEurocopData[lotNumber] === value) {
                return;
            }
            
            lotEurocopData[lotNumber] = value;
            
            try {
                const lotRef = ref(database, `lotes/${lotNumber}`);
                await update(lotRef, { eurocop: value });
                
                inputElement.style.borderColor = 'green';
                setTimeout(() => {
                     inputElement.style.borderColor = '';
                }, 1000);
                
            } catch (error) {
                console.error(`Error al guardar EUROCOP para ${lotNumber}:`, error);
                alert(`Error al guardar EUROCOP. Revisa la consola.`);
                inputElement.style.borderColor = 'red';
            }
        }
        
        async function loadPlates() {
            const tableBody = document.getElementById('platesTableBody');
            tableBody.innerHTML = '<tr id="loadingRow"><td colspan="6" class="text-center py-4 text-gray-500"><i class="fas fa-spinner fa-spin"></i> Cargando datos...</td></tr>';
            document.getElementById('lotAdminBody').innerHTML = '<tr><td colspan="5" class="text-center py-3 text-gray-500"><i class="fas fa-spinner fa-spin"></i> Cargando lotes...</td></tr>'; 

            try {
                await loadLotMetadata(); 
                await loadAnuladas(); 
                
                const dbRef = ref(database, 'placas_destruccion');
                const snapshot = await get(dbRef);

                tableBody.innerHTML = ''; 
                allPlatesData = []; 
                uniqueLots = {}; 

                if (snapshot.exists()) {
                    const data = snapshot.val(); 
                    
                    allPlatesData = Object.entries(data).map(([key, value]) => {
                        if (value.LoteDestruccion && value.LoteDestruccion.trim() !== "") {
                            const lotName = value.LoteDestruccion;
                            if (!uniqueLots[lotName]) {
                                uniqueLots[lotName] = [];
                            }
                            uniqueLots[lotName].push(key);
                        }
                        return { id: key, ...value };
                    });

                    await getNextLotNumber();
                    document.getElementById('plateCounter').textContent = allPlatesData.length; 
                    
                    extractAndRenderCountries(); 
                    
                    renderPlates(allPlatesData);
                    loadLotAdministrationPanel(); 
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-orange-500">❌ Base de datos vacía. Asegúrate de importar el JSON en Firebase.</td></tr>';
                    document.getElementById('plateCounter').textContent = '0';
                    loadLotAdministrationPanel(); 
                }

            } catch (error) {
                console.error("🚨 ERROR CRÍTICO al cargar placas (SDK):", error);
                alert("❌ ERROR: No se pudo conectar a Firebase. Revisa si la configuración es correcta.");
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Error al cargar datos. Comprueba la Consola (F12).</td></tr>';
            }
        }

        // --- FUNCIONES SECUNDARIAS DE CARGA Y AUTOCONFIGURACIÓN ---

        function extractAndRenderCountries() {
            const uniqueCountriesSet = new Set();
            allPlatesData.forEach(placa => {
                if (placa.PAIS && placa.PAIS.trim() !== "") {
                    uniqueCountriesSet.add(placa.PAIS.trim().toUpperCase()); 
                }
            });

            knownCountries = Array.from(uniqueCountriesSet).sort();

            const datalist = document.getElementById('countryDatalist');
            datalist.innerHTML = ''; 

            knownCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                datalist.appendChild(option);
            });
        }
        
        async function loadAnuladas() {
            try {
                const dbRef = ref(database, 'placas_anuladas');
                const snapshot = await get(dbRef);
                anuladasData = []; 
                if (snapshot.exists()) {
                    const data = snapshot.val(); 
                    anuladasData = Object.entries(data).map(([key, value]) => ({ id: key, ...value }));
                }
                document.getElementById('anuladasCount').textContent = anuladasData.length;
            } catch (error) {
                console.error("Error al cargar placas anuladas:", error);
            }
        }
        
        async function getNextLotNumber() {
            try {
                let maxLotNumber = 0;
                
                allPlatesData.forEach(placa => {
                    if (placa.LoteDestruccion) {
                        const match = placa.LoteDestruccion.match(/LOTE (\d+)/i);
                        if (match) {
                            const currentLotNum = parseInt(match[1]);
                            if (currentLotNum > maxLotNumber) {
                                maxLotNumber = currentLotNum;
                            }
                        }
                    }
                });
                
                const nextLotNum = maxLotNumber + 1;
                const lotName = `LOTE ${nextLotNum}`;
                document.getElementById('lotNumber').value = lotName;
                return lotName;

            } catch (error) {
                console.error("Error al determinar el próximo número de lote:", error);
                document.getElementById('lotNumber').value = 'LOTE 1';
                return 'LOTE 1';
            }
        }
        
        function renderPlates(platesToRender) {
            const tableBody = document.getElementById('platesTableBody');
            tableBody.innerHTML = '';
            
            if (document.getElementById('searchPlate').value.trim() === "") {
                // 1. Criterio principal: Mover PENDIENTES al inicio y Loteados al final
                platesToRender.sort((a, b) => {
                    const isADestroyed = !!a.LoteDestruccion && a.LoteDestruccion.trim() !== "";
                    const isBDestroyed = !!b.LoteDestruccion && b.LoteDestruccion.trim() !== "";

                    // PENDIENTE (false) va antes que DESTRUIDO (true)
                    if (isADestroyed !== isBDestroyed) {
                        return isADestroyed ? 1 : -1; 
                    }

                    // 2. Criterio secundario: Ordenar por columna seleccionada (PAIS o PLACA)
                    const aVal = String(a[currentSort.column] || '').toUpperCase();
                    const bVal = String(b[currentSort.column] || '').toUpperCase();
                    
                    if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            let totalPlates = platesToRender.length; 
            
            if (platesToRender.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No se encontraron placas que coincidan con la búsqueda.</td></tr>';
            }

            platesToRender.forEach((placa, i) => {
                const key = placa.id;
                const isDestroyed = placa.LoteDestruccion && placa.LoteDestruccion.trim() !== "";
                const rowClass = i % 2 === 0 ? 'table-row-even' : 'table-row-odd';
                
                const row = document.createElement('tr');
                row.classList.add(rowClass, 'hover:bg-yellow-100', 'transition', 'duration-150');
                if (isDestroyed) {
                    row.classList.add('bg-green-100', 'hover:bg-green-200');
                }

                // CAMBIO CLAVE: Añadimos IDs únicos a las celdas y el icono de edición.
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <input type="checkbox" data-plate-id="${key}" ${isDestroyed ? 'disabled' : ''} class="plate-checkbox rounded text-red-600 border-gray-300">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${totalPlates - i}</td> 
                    <td id="pais-${key}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-bold">${placa.PAIS || ''}</td>
                    <td id="placa-${key}" class="px-6 py-4 whitespace-nowrap text-base font-bold text-red-600">${placa.PLACA || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${isDestroyed ? 'text-green-700' : 'text-gray-400'}">
                        ${isDestroyed ? `<i class="fas fa-check-circle"></i> ${placa.LoteDestruccion}` : 'PENDIENTE'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium flex justify-center items-center space-x-3">
                        ${isDestroyed ? '' : `<i class="fas fa-edit edit-icon text-blue-600 hover:text-blue-800 cursor-pointer" data-plate-id="${key}" title="Editar País/Placa"></i>`}
                        <i class="fas fa-times-circle delete-icon" data-plate-id="${key}" title="Anular placa y mover a sección 'Anuladas'"></i>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            document.querySelectorAll('.plate-checkbox').forEach(cb => {
                cb.addEventListener('change', updateLotButton);
            });
            document.querySelectorAll('.delete-icon').forEach(icon => {
                icon.addEventListener('click', handleAnularPlate); 
            });
            // NUEVO: Listener para el icono de edición
            document.querySelectorAll('.edit-icon').forEach(icon => {
                icon.addEventListener('click', handleEditPlate);
            });

            updateLotButton(); 
        }
        
        function loadLotAdministrationPanel() {
            const lotAdminBody = document.getElementById('lotAdminBody');
            lotAdminBody.innerHTML = '';
            
            const sortedLots = Object.keys(uniqueLots).sort((a, b) => {
                const numA = parseInt((a.match(/LOTE (\d+)/i) || [0, 0])[1]);
                const numB = parseInt((b.match(/LOTE (\d+)/i) || [0, 0])[1]);
                return numB - numA; 
            });

            if (sortedLots.length === 0) {
                lotAdminBody.innerHTML = '<tr><td colspan="5" class="text-center py-3 text-gray-500">Aún no se ha generado ningún lote.</td></tr>'; 
                return;
            }

            sortedLots.forEach((lotName, i) => {
                const plateCount = uniqueLots[lotName].length;
                const row = document.createElement('tr');
                row.classList.add(i % 2 === 0 ? 'bg-gray-50' : 'bg-white', 'hover:bg-red-50');
                
                const lotNumberOnly = lotName.replace(/\s*\([^)]*\)/, '');
                const dateMatch = lotName.match(/\((.*?)\)/);
                
                const eurocopValue = lotEurocopData[lotNumberOnly] || ''; 

                row.innerHTML = `
                    <td class="px-6 py-3 whitespace-nowrap text-sm font-semibold text-gray-900">${lotNumberOnly}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">
                        <input type="text" value="${eurocopValue}" data-lot-number="${lotNumberOnly}" placeholder="Nº EUROCOP"
                               class="eurocop-input w-full border border-gray-300 rounded-md p-1 text-xs" 
                               onchange="saveEurocopValue(this)">
                    </td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${plateCount}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${dateMatch ? dateMatch[1] : 'Desconocida'}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm font-medium flex items-center justify-between"> 
                        <button data-lot-name="${lotName}" class="consult-lot-btn text-blue-600 hover:text-blue-700 font-bold text-sm whitespace-nowrap">
                            <i class="fas fa-search-plus"></i> Consultar Lote
                        </button>
                        <button data-lot-name="${lotName}" class="undo-lot-admin-btn text-red-600 hover:text-red-900 font-bold text-sm whitespace-nowrap">
                            <i class="fas fa-undo"></i> Deshacer Lote 
                        </button>
                    </td>
                `;
                lotAdminBody.appendChild(row);
            });
            
            document.querySelectorAll('.undo-lot-admin-btn').forEach(button => {
                button.addEventListener('click', handleUndoLotAdmin);
            });
            document.querySelectorAll('.consult-lot-btn').forEach(button => {
                button.addEventListener('click', handleConsultLotButton);
            });
            window.saveEurocopValue = saveEurocopValue; 
        }

        // --- FUNCIONES DE EDICIÓN EN LÍNEA (NUEVAS) ---
        
        function handleEditPlate(event) {
            const plateId = event.currentTarget.dataset.plateId;
            const row = event.currentTarget.closest('tr');

            // Prevenir edición si ya hay otra fila editándose
            if (document.querySelector('tr[data-editing="true"]')) {
                alert("Por favor, guarda o cancela la edición de la fila actual primero.");
                return;
            }
            
            const plateData = allPlatesData.find(p => p.id === plateId);
            if (!plateData) return;
            
            const paisCell = document.getElementById(`pais-${plateId}`);
            const placaCell = document.getElementById(`placa-${plateId}`);
            const actionCell = row.querySelector('.flex.justify-center.items-center.space-x-3');

            // 1. SWITCH TO EDIT MODE
            row.dataset.editing = 'true';
            
            // 2. Reemplazar País con input + datalist
            paisCell.innerHTML = `
                <input type="text" id="edit-pais-${plateId}" list="countryDatalist" value="${plateData.PAIS || ''}" 
                       class="inline-edit-input uppercase text-sm font-bold text-gray-700">
            `;
            
            // 3. Reemplazar Placa con input
            placaCell.innerHTML = `
                <input type="text" id="edit-placa-${plateId}" value="${plateData.PLACA || ''}" 
                       class="inline-edit-input uppercase text-base font-bold text-red-700">
            `;
            
            // 4. Cambiar iconos (Edit -> Save, Delete -> Cancel)
            actionCell.innerHTML = `
                <i class="fas fa-save save-edit-icon text-green-600 hover:text-green-800 cursor-pointer" data-plate-id="${plateId}" title="Guardar cambios"></i>
                <i class="fas fa-times cancel-edit-icon text-gray-500 hover:text-gray-700 cursor-pointer" data-plate-id="${plateId}" title="Cancelar edición"></i>
            `;
            
            // 5. Establecer nuevos listeners
            actionCell.querySelector('.save-edit-icon').addEventListener('click', handleSaveEdit);
            actionCell.querySelector('.cancel-edit-icon').addEventListener('click', handleCancelEdit);
            
            // Foco en el primer campo
            document.getElementById(`edit-pais-${plateId}`).focus();
        }

        async function handleSaveEdit(event) {
            const plateId = event.currentTarget.dataset.plateId;
            const newCountry = document.getElementById(`edit-pais-${plateId}`).value.trim().toUpperCase();
            const newPlate = document.getElementById(`edit-placa-${plateId}`).value.trim().toUpperCase();
            
            const plateData = allPlatesData.find(p => p.id === plateId);
            
            if (!newCountry || !newPlate) {
                alert("El País y la Placa no pueden estar vacíos.");
                return;
            }
            
            // 1. Verificar si los datos son iguales (sin cambios)
            if (newCountry === plateData.PAIS && newPlate === plateData.PLACA) {
                loadPlates(); // Revertir a display mode
                return;
            }
            
            // 2. Verificar duplicidad de placa
            const isDuplicate = allPlatesData.some(p => 
                p.id !== plateId && p.PLACA && p.PLACA.toUpperCase() === newPlate && p.LoteDestruccion.trim() === "" // Solo chequear placas PENDIENTES
            );

            if (isDuplicate) {
                alert(`Error: La placa "${newPlate}" ya existe en la base de datos (y está pendiente de destrucción).`);
                return;
            }
            
            if (!confirm(`¿Confirmas la modificación de la placa ${plateData.PLACA} a ${newPlate} (${newCountry})?`)) {
                return;
            }
            
            try {
                const plateRef = ref(database, `placas_destruccion/${plateId}`);
                await update(plateRef, {
                    PAIS: newCountry,
                    PLACA: newPlate
                });
                
                loadPlates(); // Recargar todos los datos para reflejar los cambios y salir del modo edición.
                
            } catch (error) {
                console.error("Error al guardar edición de placa:", error);
                alert("Ocurrió un error al guardar los cambios. Revisa la consola.");
            }
        }

        function handleCancelEdit() {
            // Simplemente forzar una recarga para revertir la fila al estado de visualización original.
            loadPlates(); 
        }

        // --- FUNCIONES DE ANULACIÓN Y RESTAURACIÓN (EXISTENTES) ---

        function renderAnuladasModal() {
            const listBody = document.getElementById('anuladasListBody');
            listBody.innerHTML = '';

            if (anuladasData.length === 0) {
                listBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">No hay placas anuladas.</td></tr>';
                return;
            }

            anuladasData.forEach((placa, i) => {
                const row = document.createElement('tr');
                row.classList.add(i % 2 === 0 ? 'bg-gray-50' : 'bg-white', 'hover:bg-yellow-50');
                
                row.innerHTML = `
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 font-bold">${placa.PAIS || ''}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-base font-bold text-red-600">${placa.PLACA || ''}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-center text-sm font-medium">
                        <button data-plate-id="${placa.id}" 
                                data-plate-pais="${placa.PAIS}"
                                data-plate-number="${placa.PLACA}"
                                class="restore-plate-btn text-green-600 hover:text-green-800 font-semibold transition">
                            <i class="fas fa-reply"></i> Restaurar
                        </button>
                    </td>
                `;
                listBody.appendChild(row);
            });

            document.querySelectorAll('.restore-plate-btn').forEach(button => {
                button.addEventListener('click', handleRestaurarPlate);
            });
        }

        async function handleAnularPlate(event) {
            const plateId = event.currentTarget.dataset.plateId;
            const plateData = allPlatesData.find(p => p.id === plateId);
            const plateNumber = plateData ? plateData.PLACA : 'Desconocida';
            
            if (!confirm(`¿Estás seguro de que quieres ANULAR la placa ${plateNumber}? Se moverá a la sección 'Anuladas'.`)) {
                return;
            }
            
            const newPlateData = {
                PAIS: plateData.PAIS,
                PLACA: plateData.PLACA,
                FechaAnulacion: new Date().toISOString()
            };

            try {
                await push(ref(database, 'placas_anuladas'), newPlateData);
                await remove(ref(database, `placas_destruccion/${plateId}`));
                
                alert(`Placa ${plateNumber} ANULADA y movida a la papelera.`);
                
                loadPlates(); 
            } catch (error) {
                console.error("Error al anular placa:", error);
                alert("Ocurrió un error al anular la placa. Revisa la consola.");
            }
        }

        async function handleRestaurarPlate(event) {
            const button = event.currentTarget;
            const plateId = button.dataset.plateId;
            const plateNumber = button.dataset.plateNumber;
            const platePais = button.dataset.platePais;

            if (!confirm(`¿Estás seguro de que quieres RESTAURAR la placa ${plateNumber} a la lista principal?`)) {
                return;
            }

            const restoredPlateData = {
                PAIS: platePais,
                PLACA: plateNumber,
                LoteDestruccion: "" 
            };
            
            try {
                await push(ref(database, 'placas_destruccion'), restoredPlateData);
                await remove(ref(database, `placas_anuladas/${plateId}`));
                
                alert(`Placa ${plateNumber} RESTAURADA y ahora está PENDIENTE.`);
                
                document.getElementById('anuladasModal').style.display = 'none';
                loadPlates(); 
            } catch (error) {
                console.error("Error al restaurar placa:", error);
                alert("Ocurrió un error al restaurar la placa. Revisa la consola.");
            }
        }
        
        // --- Otras Funciones (generateLot, handleUndoLotAdmin, etc.) ---
        
        function handleSort(event) {
            const newColumn = event.currentTarget.dataset.sortBy;
            let newDirection = 'asc';

            if (currentSort.column === newColumn) {
                newDirection = currentSort.direction === 'asc' ? 'desc' : 'asc';
            }

            currentSort = { column: newColumn, direction: newDirection };

            document.getElementById('sortIconPAIS').innerHTML = '';
            document.getElementById('sortIconPLACA').innerHTML = '';

            const iconId = `sortIcon${newColumn}`;
            document.getElementById(iconId).innerHTML = newDirection === 'asc' ? '<i class="fas fa-sort-up"></i>' : '<i class="fas fa-sort-down"></i>';
            
            renderPlates(allPlatesData);
        }
        
        function handleSearch(event) {
            const searchTerm = event.target.value.toUpperCase().trim();
            
            if (searchTerm.length < 1) {
                renderPlates(allPlatesData); 
                return;
            }
            
            const filteredPlates = allPlatesData.filter(p => p.PLACA && p.PLACA.toUpperCase().includes(searchTerm));
            renderPlates(filteredPlates);
        }

        function updateLotButton() {
            const selected = document.querySelectorAll('.plate-checkbox:checked');
            const button = document.getElementById('generateLotButton');
            
            document.getElementById('selectedCount').textContent = ` (${selected.length})`;
            
            button.disabled = selected.length === 0;
        }
        
        function toggleSelectAll(event) {
            const isChecked = event.target.checked;
            document.querySelectorAll('.plate-checkbox:not(:disabled)').forEach(cb => {
                cb.checked = isChecked;
            });
            updateLotButton();
        }

        async function generateLot() {
            const lotNumber = document.getElementById('lotNumber').value.trim();
            const selectedPlates = document.querySelectorAll('.plate-checkbox:checked');
            
            if (lotNumber === "" || selectedPlates.length === 0) return;
            
            if (!confirm(`¿Confirmas que quieres marcar ${selectedPlates.length} placas con el lote: ${lotNumber}? Esta acción es irreversible.`)) return;

            const updates = {};
            const lotMark = `${lotNumber} (${new Date().toLocaleDateString('es-ES')})`;

            selectedPlates.forEach(checkbox => {
                const plateId = checkbox.dataset.plateId;
                updates[`placas_destruccion/${plateId}/LoteDestruccion`] = lotMark;
            });

            try {
                await update(ref(database), updates);
                alert(`¡Lote ${lotNumber} generado con éxito para ${selectedPlates.length} placas!`);
                
                document.getElementById('searchPlate').value = "";
                document.getElementById('selectAllCheckbox').checked = false;
                loadPlates(); 

            } catch (error) {
                console.error("Error al actualizar placas (SDK):", error);
                alert("Ocurrió un error al guardar el lote. Revisa la consola.");
            }
        }

        async function handleUndoLotAdmin(event) {
            const lotName = event.currentTarget.dataset.lotName;
            const plateIds = uniqueLots[lotName];
            
            if (!plateIds || plateIds.length === 0) return;

            if (!confirm(`ADVERTENCIA: ¿Estás seguro de que quieres DESHACER el lote completo "${lotName}"? Se desmarcarán ${plateIds.length} placas y volverán a estado PENDIENTE.`)) {
                return;
            }

            const updates = {};
            plateIds.forEach(plateId => {
                updates[`placas_destruccion/${plateId}/LoteDestruccion`] = "";
            });

            try {
                await update(ref(database), updates);
                alert(`Lote "${lotName}" deshecho con éxito. Las placas han vuelto a estado PENDIENTE.`);
                loadPlates(); 
            } catch (error) {
                console.error("Error al deshacer lote (SDK):", error);
                alert("Ocurrió un error al deshacer el lote. Revisa la consola.");
            }
        }

        async function saveNewPlate() {
            const countryInput = document.getElementById('newPlateCountry');
            const plateInput = document.getElementById('newPlateNumber');
            
            // Aseguramos que el País se guarde en MAYÚSCULAS para consistencia.
            const country = countryInput.value.trim().toUpperCase(); 
            const plate = plateInput.value.trim().toUpperCase();

            if (country === "" || plate === "") {
                alert("Por favor, rellena el País y el Número de Placa.");
                return;
            }

            const exists = allPlatesData.some(p => p.PLACA && p.PLACA.toUpperCase() === plate);
            if (exists) {
                alert(`Error: La placa "${plate}" ya existe en la base de datos.`);
                return;
            }

            const newPlateData = {
                PAIS: country,
                PLACA: plate,
                LoteDestruccion: "" 
            };

            try {
                await push(ref(database, 'placas_destruccion'), newPlateData);
                alert(`Placa "${plate}" de ${country} añadida con éxito.`);
                
                countryInput.value = '';
                plateInput.value = '';
                document.getElementById('newPlateModal').style.display = 'none';

                loadPlates(); // Recargar datos, lo que actualizará automáticamente el datalist de países.
            } catch (error) {
                console.error("Error al añadir nueva placa (SDK):", error);
                alert("Ocurrió un error al guardar la nueva placa. Revisa la consola.");
            }
        }
        
        function handleConsultLotButton(event) {
            const lotName = event.currentTarget.dataset.lotName;
            const plateIds = uniqueLots[lotName];
            
            const modalTitle = document.getElementById('consultLotTitle');
            const plateListUl = document.getElementById('consultLotList');
            plateListUl.innerHTML = '';
            
            modalTitle.textContent = `Placas en ${lotName.replace(/\s*\([^)]*\)/, '')}`;
            
            currentPlatesInConsultedLot = [];

            if (plateIds && plateIds.length > 0) {
                const platesInLot = allPlatesData.filter(p => plateIds.includes(p.id));
                currentPlatesInConsultedLot = platesInLot; 
                
                platesInLot.forEach(placa => {
                    const li = document.createElement('li');
                    li.classList.add('flex', 'justify-between', 'py-1', 'border-b', 'border-gray-200');
                    li.innerHTML = `
                        <span class="font-bold text-red-700">${placa.PLACA}</span>
                        <span class="text-gray-500 font-bold">${placa.PAIS}</span> 
                    `;
                    plateListUl.appendChild(li);
                });
            } else {
                plateListUl.innerHTML = '<li class="text-center py-4 text-gray-500">No se encontraron placas en este lote.</td></tr>';
            }
            
            document.getElementById('exportLotToExcelButton').onclick = () => {
                exportLotToExcel(lotName, currentPlatesInConsultedLot);
            };

            document.getElementById('consultLotModal').style.display = 'flex';
        }
        
        function exportLotToExcel(lotName, platesInLot) {
            if (platesInLot.length === 0) {
                alert("No hay placas en este lote para exportar.");
                return;
            }

            const cleanLotName = lotName.replace(/\s*\([^)]*\)/, '').replace(/[^\w\s]/gi, '');
            const filename = `${cleanLotName}_Placas.csv`;
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 

            csvContent += "PLACA,PAIS,LOTE DESTRUCCION\r\n";

            platesInLot.forEach(placa => {
                const placaNumber = placa.PLACA || '';
                const pais = placa.PAIS || '';
                const lote = cleanLotName || '';
                
                const row = [placaNumber, pais, lote].map(field => `"${field.toString().replace(/"/g, '""')}"`).join(",");
                csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- LÓGICA DE MODALES (EXISTENTE) ---
        function setupModalListeners() {
            // Modal Nueva Placa
            const newPlateModal = document.getElementById('newPlateModal');
            document.getElementById('openNewPlateModal').addEventListener('click', () => {
                // Limpiar el input del país al abrir
                document.getElementById('newPlateCountry').value = '';
                newPlateModal.style.display = 'flex';
            });
            document.getElementById('closeNewPlateModal').addEventListener('click', () => {
                newPlateModal.style.display = 'none';
            });
            document.getElementById('saveNewPlateButton').addEventListener('click', saveNewPlate);
            
            // Modal Consultar Lote
            const consultLotModal = document.getElementById('consultLotModal');
             document.getElementById('closeConsultLotModal').addEventListener('click', () => {
                consultLotModal.style.display = 'none';
            });

            // Modal Anuladas
            const anuladasModal = document.getElementById('anuladasModal');
            document.getElementById('openAnuladasModal').addEventListener('click', () => {
                renderAnuladasModal(); 
                anuladasModal.style.display = 'flex';
            });
            document.getElementById('closeAnuladasModal').addEventListener('click', () => {
                anuladasModal.style.display = 'none';
            });

            // Cerrar modales al hacer clic fuera
            window.addEventListener('click', (event) => {
                if (event.target === newPlateModal) {
                    newPlateModal.style.display = 'none';
                }
                if (event.target === consultLotModal) {
                    consultLotModal.style.display = 'none';
                }
                if (event.target === anuladasModal) {
                    anuladasModal.style.display = 'none';
                }
            });
        }

        // --- INICIALIZACIÓN (EXISTENTE) ---

        document.addEventListener('DOMContentLoaded', () => {
            loadPlates();
            setupModalListeners(); 

            document.getElementById('generateLotButton').addEventListener('click', generateLot);
            document.getElementById('searchPlate').addEventListener('input', handleSearch); 
            document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);
            
            document.querySelectorAll('.sort-header').forEach(header => {
                header.addEventListener('click', handleSort);
            });
            
            document.getElementById(`sortIcon${currentSort.column}`).innerHTML = '<i class="fas fa-sort-up"></i>';
        });
    </script>
</body>
</html>