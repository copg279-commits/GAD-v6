<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel GAD Alicante - Ayuda Pa√≠ses</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>

    <style>
        :root { --blue-main: #1a73e8; --blue-dark: #0d47a1; --success: #28a745; --danger: #d93025; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); padding: 20px; color: #333; margin: 0; }
        .container { max-width: 1200px; margin: 20px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); position: relative; }
        .help-btn { position: absolute; top: 20px; right: 20px; background: #5f6368; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-weight: bold; z-index: 100; }
        .db-panel { background: #e8f0fe; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #c2d7fa; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .db-panel input { padding: 8px; border: 1px solid #ccc; border-radius: 5px; flex-grow: 1; min-width: 200px; }
        .btn-db { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn-save { background: var(--success); color: white; }
        .btn-load { background: var(--blue-main); color: white; }
        .setup-grid { display: grid; grid-template-columns: 280px 1fr; gap: 20px; margin-bottom: 20px; }
        .ag-list input { width: 95%; padding: 8px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 5px; display: block; }
        textarea { width: 100%; height: 120px; border: 1px solid #ccc; border-radius: 8px; padding: 10px; font-family: monospace; font-size: 11px; }
        button#process-btn { width: 100%; padding: 15px; background: var(--blue-main); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-bottom: 20px; }
        .results { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; border: 1px solid #d1d9e0; overflow: hidden; display: flex; flex-direction: column; }
        .card-header { background: var(--blue-main); color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .card-body { padding: 15px; flex-grow: 1; }
        .task-segment { padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9em; border-left: 5px solid #ccc; cursor: pointer; }
        .seg-others { background: #f0f4ff; border-left-color: var(--blue-main); }
        .seg-france { background: #fff9e6; border-left-color: #ffb300; }
        .folder-list { display: none; margin-top: 10px; padding: 8px; background: #fff; border: 1px solid #eee; border-radius: 5px; max-height: 250px; overflow-y: auto; }
        .folder-item { display: flex; align-items: center; gap: 8px; padding: 4px 0; border-bottom: 1px solid #f9f9f9; font-size: 0.85em; }
        .folder-item.done { text-decoration: line-through; opacity: 0.4; background: #e8f5e9; }
        .status-area { background: #f1f3f4; border-top: 1px solid #eee; padding: 10px; display: flex; flex-direction: column; gap: 5px; }
        .status-line { display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 0.85em; cursor: pointer; }
        .card.done-all { opacity: 0.6; filter: grayscale(1); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 25px; border-radius: 12px; width: 80%; max-width: 500px; position: relative; }
    </style>
</head>
<body>

<div class="container">
    <button class="help-btn" onclick="document.getElementById('helpModal').style.display='block'">?</button>
    <h1>GAD Alicante - Ayuda Pa√≠ses</h1>

    <div class="db-panel">
        <strong>üìÅ Nodo: Ayuda Pa√≠ses</strong>
        <input type="text" id="saveName" placeholder="Nombre (Ej: 2025 semestre 2)">
        <button class="btn-db btn-save" onclick="guardarReparto()">Guardar Reparto</button>
        <div style="border-left: 1px solid #c2d7fa; height: 30px; margin: 0 10px;"></div>
        <select id="historyList" style="padding: 8px; border-radius: 5px;" onchange="cargarReparto()"></select>
    </div>

    <div class="setup-grid">
        <div class="ag-list">
            <input type="text" value="Agente 1" class="ag-name"><input type="text" value="Agente 2" class="ag-name">
            <input type="text" value="Agente 3" class="ag-name"><input type="text" value="Agente 4" class="ag-name">
            <input type="text" value="Agente 5" class="ag-name">
        </div>
        <textarea id="dataInput" placeholder="Pega aqu√≠ los datos de PowerShell..."></textarea>
    </div>

    <button id="process-btn" onclick="procesar(true)">Generar Reparto Sin Duplicados</button>
    <div id="results" class="results"></div>
</div>

<div id="helpModal" class="modal">
    <div class="modal-content">
        <span style="float:right; cursor:pointer; font-size:24px;" onclick="document.getElementById('helpModal').style.display='none'">&times;</span>
        <h2>Ayuda PowerShell</h2>
        <p>1. Entra en la carpeta de los expedientes.</p>
        <p>2. Ejecuta el comando:</p>
        <code>Get-ChildItem -Recurse -File | Select-Object -ExpandProperty FullName | clip</code>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA6EDUJ2dG50DphB-dF6GLi3P2IlW8lDz4",
        authDomain: "gad-alicante-v3.firebaseapp.com",
        databaseURL: "https://gad-alicante-v3-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "gad-alicante-v3",
        storageBucket: "gad-alicante-v3.firebasestorage.app",
        messagingSenderId: "906986258369",
        appId: "1:906986258369:web:21a7ea29a33b5f395e3940"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentData = null;
    let inicializado = false;
    let lastChecked = null;

    db.ref('repartos').on('value', (snapshot) => {
        const select = document.getElementById('historyList');
        const prev = select.value;
        select.innerHTML = '<option value="">Consultar anteriores...</option>';
        let claves = [];
        snapshot.forEach((child) => {
            claves.push(child.key);
            let opt = document.createElement('option');
            opt.value = child.key; opt.text = child.key;
            select.appendChild(opt);
        });
        if (!inicializado && claves.length > 0) {
            claves.sort();
            const ultimo = claves[claves.length - 1];
            select.value = ultimo;
            cargarReparto(); inicializado = true;
        } else { select.value = prev; }
    });

    function corregir(t) { return t.replace(/ESPA\?A/gi, "ESPA√ëA").replace(/cauci\?n/gi, "cauci√≥n").replace(/gesti\?n/gi, "gesti√≥n").replace(/expedici\?n/gi, "expedici√≥n"); }
    
    function extraerInfo(ruta) {
        const limpia = corregir(ruta);
        const partes = limpia.split('\\');
        let pais = "Otros", matricula = "S/M";
        for(let i=0; i < partes.length; i++) {
            if(partes[i].includes("SEMESTRE") || partes[i].includes("EXPEDIENTES")) {
                pais = partes[i+2] || "Otros";
                const folderMat = partes[i+3] || "";
                if(folderMat) matricula = folderMat.replace(pais, "").trim().split(/[ -]/)[0] || "S/M";
                break;
            }
        }
        return { pais, matricula };
    }

    function agruparMatriculas(lineas) {
        let map = {};
        lineas.forEach(l => {
            const inf = extraerInfo(l);
            const key = `${inf.pais}|${inf.matricula}`;
            if (!map[key]) map[key] = { ...inf, archCount: 0, checked: false };
            map[key].archCount++;
        });
        return Object.values(map);
    }

    function procesar(esNuevo, datosCargados = null) {
        if(esNuevo) {
            const raw = document.getElementById('dataInput').value.trim();
            if(!raw) return;
            const lineas = raw.split('\n').filter(l => l.trim() !== "");
            const agentes = Array.from(document.querySelectorAll('.ag-name')).map(i => i.value);
            
            // FILTRO ANTI-DUPLICADOS ANTES DE REPARTIR
            const frUnicos = agruparMatriculas(lineas.filter(l => extraerInfo(l).pais.toUpperCase().includes("FRANCIA")));
            const otUnicos = agruparMatriculas(lineas.filter(l => !extraerInfo(l).pais.toUpperCase().includes("FRANCIA")));

            const dividir = (arr, n) => {
                let res = Array.from({length: n}, () => []);
                arr.forEach((item, idx) => res[idx % n].push(item));
                return res;
            };

            currentData = { 
                agentes, 
                bloqueOtros: dividir(otUnicos, 5), 
                bloqueFrancia: dividir(frUnicos, 5),
                statusOtros: [false,false,false,false,false],
                statusFrancia: [false,false,false,false,false],
                statusTodo: [false,false,false,false,false]
            };
        } else { currentData = datosCargados; }
        renderizar();
    }

    function renderizar() {
        const resDiv = document.getElementById('results');
        resDiv.innerHTML = "";
        if(!currentData) return;
        currentData.agentes.forEach((name, i) => {
            const mOt = currentData.bloqueOtros[i] || [];
            const mFr = currentData.bloqueFrancia[i] || [];
            const total = [...mOt, ...mFr].reduce((acc, curr) => acc + (parseInt(curr.archCount) || 1), 0);
            
            const card = document.createElement('div');
            card.className = 'card' + (currentData.statusTodo && currentData.statusTodo[i] ? ' done-all' : '');
            card.id = `card-${i}`;
            card.innerHTML = `
                <div class="card-header"><span>${name}</span><span>${total} arch. totales</span></div>
                <div class="card-body">
                    ${renderBloque(mOt, i, 'ot', 'üåé OTROS')}
                    ${renderBloque(mFr, i, 'fr', 'üá´üá∑ FRANCIA')}
                </div>
                <div class="status-area">
                    <label class="status-line"><input type="checkbox" id="chk-ot-${i}" ${currentData.statusOtros && currentData.statusOtros[i] ? 'checked' : ''} onchange="toggleGrupoPersistente(${i}, 'ot', this.checked)"> Realizado OTROS</label>
                    <label class="status-line"><input type="checkbox" id="chk-fr-${i}" ${currentData.statusFrancia && currentData.statusFrancia[i] ? 'checked' : ''} onchange="toggleGrupoPersistente(${i}, 'fr', this.checked)"> Realizado FRANCIA</label>
                    <label class="status-line" style="color:var(--blue-dark); border-top:1px solid #ddd; padding-top:5px; margin-top:5px;"><input type="checkbox" id="chk-todo-${i}" ${currentData.statusTodo && currentData.statusTodo[i] ? 'checked' : ''} onchange="saveGeneralStatus(${i}, 'statusTodo', this.checked)"> Realizado TODO</label>
                </div>
            `;
            resDiv.appendChild(card);
        });
    }

    function renderBloque(lista, agIdx, tipo, titulo) {
        if(!lista || !lista.length) return "";
        const first = lista[0], last = lista[lista.length-1];
        return `
            <div class="task-segment seg-${tipo==='ot'?'others':'france'}" onclick="toggleFolders('${tipo}', ${agIdx}, event)">
                <strong>${titulo}:</strong><br>
                <span style="font-size:0.85em;">Desde: ${first.matricula} <br> Hasta: ${last.matricula}</span>
                <div class="folder-list" id="list-${tipo}-${agIdx}">
                    ${lista.map((f, idx) => `
                        <div class="folder-item ${f.checked?'done':''}" id="item-${tipo}-${agIdx}-${idx}">
                            <input type="checkbox" ${f.checked?'checked':''} onchange="updateCarpetaPersistente(${agIdx}, '${tipo}', ${idx}, this.checked)" onclick="eventoShift(event, this, ${agIdx}, '${tipo}', ${idx})">
                            <span>${f.matricula}</span>
                        </div>`).join('')}
                </div>
            </div>`;
    }

    function toggleFolders(t, i, e) {
        if(e.target.tagName === 'INPUT') return;
        const el = document.getElementById(`list-${t}-${i}`);
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    // ACTUALIZACI√ìN DIRECTA EN DOM Y FIREBASE (SIN CERRAR MEN√ö)
    function updateCarpetaPersistente(agIdx, tipo, fIdx, val) {
        const bloque = tipo === 'ot' ? 'bloqueOtros' : 'bloqueFrancia';
        const saveName = document.getElementById('saveName').value;
        currentData[bloque][agIdx][fIdx].checked = val;
        
        // Efecto visual instant√°neo sin refrescar pantalla
        const item = document.getElementById(`item-${tipo}-${agIdx}-${fIdx}`);
        item.classList.toggle('done', val);
        
        db.ref(`repartos/${saveName}/${bloque}/${agIdx}/${fIdx}`).update({checked: val});
    }

    function toggleGrupoPersistente(agIdx, tipo, val) {
        const bloque = tipo === 'ot' ? 'bloqueOtros' : 'bloqueFrancia';
        const saveName = document.getElementById('saveName').value;
        currentData[bloque][agIdx].forEach((item, idx) => {
            item.checked = val;
            const dom = document.getElementById(`item-${tipo}-${agIdx}-${idx}`);
            if(dom) {
                dom.classList.toggle('done', val);
                dom.querySelector('input').checked = val;
            }
            db.ref(`repartos/${saveName}/${bloque}/${agIdx}/${idx}`).update({checked: val});
        });
        saveGeneralStatus(agIdx, tipo === 'ot' ? 'statusOtros' : 'statusFrancia', val, false);
    }

    function saveGeneralStatus(idx, campo, val, reRender = true) {
        const saveName = document.getElementById('saveName').value;
        if(!currentData[campo]) currentData[campo] = [false,false,false,false,false];
        currentData[campo][idx] = val;
        db.ref(`repartos/${saveName}/${campo}/${idx}`).set(val);
        if(reRender) renderizar();
    }

    function eventoShift(e, current, agIdx, tipo, fIdx) {
        e.stopPropagation();
        if (e.shiftKey && lastChecked && lastChecked.agIdx === agIdx && lastChecked.tipo === tipo) {
            let start = Math.min(fIdx, lastChecked.fIdx), end = Math.max(fIdx, lastChecked.fIdx);
            for (let i = start; i <= end; i++) {
                updateCarpetaPersistente(agIdx, tipo, i, current.checked);
                const input = document.querySelector(`#item-${tipo}-${agIdx}-${i} input`);
                if(input) input.checked = current.checked;
            }
        }
        lastChecked = { agIdx, tipo, fIdx };
    }

    function cargarReparto() {
        const n = document.getElementById('historyList').value;
        if(!n) return;
        db.ref('repartos/' + n).once('value').then(s => { 
            if(s.exists()){ procesar(false, s.val()); document.getElementById('saveName').value = n; }
        });
    }

    function guardarReparto() {
        const n = document.getElementById('saveName').value.trim();
        if(!n || !currentData) return alert("Faltan datos.");
        db.ref('repartos/' + n).set(currentData).then(() => alert("Guardado con √©xito en Ayuda Pa√≠ses."));
    }
</script>
</body>
</html>