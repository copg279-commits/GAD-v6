<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menú Principal de Archivos HTML - GAD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Estilos personalizados del index.html original */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .main-content-wrapper {
            display: flex; flex-direction: column; align-items: center; flex-grow: 1; width: 100%; padding: 0px; box-sizing: border-box;
        }
        .menu-card {
            background-color: white; padding: 0.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); width: 100%; display: flex; flex-direction: column; flex-grow: 1;
        }
        /* CORRECCIÓN: CENTRADO DE TITULO */
        .title-container {
            text-align: center;
        }
        h1 { margin: 0; font-size: 1.8rem; line-height: 1.2; padding: 0.5rem 0; }
        @media (min-width: 640px) {
            .menu-card { padding: 1rem; }
            h1 { margin: 1rem 0; font-size: 3rem; }
        }
        .construccion-logo { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); height: 75%; width: auto; opacity: 0.8; }
        @media (max-width: 639px) {
            .construccion-logo { height: 40%; right: 5px; opacity: 0.7; top: unset; transform: unset; bottom: 5px; }
            .btn-con-logo { padding-right: 2.5rem; padding-bottom: 2rem; }
        }
        
        /* Estilos para modales */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.1); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .modal { background-color: #282844; padding: 25px; border-radius: 10px; text-align: center; color: #e9e9f0; width: 90%; max-width: 400px; position: relative; }
        .modal .modal-header-logo { height: 54px; width: 54px; border-radius: 50%; overflow: hidden; border: 3px solid #667eea; margin: 0 auto 15px; }
        .modal .modal-header-logo img { width: 100%; height: 100%; object-fit: contain; }
        .modal h2 { font-size: 1.5rem; font-weight: 600; }
        .modal p { font-size: 0.9rem; color: #ccc; }
        .modal input, .modal select, .modal textarea { padding: 12px; font-size: 1em; border-radius: 8px; border: 1px solid #555; background-color: #1a1a2e; color: #e9e9f0; width: 100%; box-sizing: border-box; margin-bottom: 15px; }
        .modal button { padding: 10px 20px; font-size: 1.1em; border-radius: 5px; border: none; background-image: linear-gradient(135deg, #667eea, #764ba2); color: #e9e9f0; cursor: pointer; margin-top: 10px; width: 100%; }
        .modal-body { display: flex; flex-direction: column; gap: 15px; }
        .modal .error-message { color: #dc3545; }
        .modal .success-message { color: #28a745; }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 1.5em; cursor: pointer; color: #ccc; }
        
        /* Contenedores de controles */
        .controls-container { display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-top: 1.5rem; width: 100%; }
        .admin-controls { display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap; }
        .counters-row { 
            display: flex; justify-content: center; align-items: flex-end; gap: 0.5rem; flex-wrap: wrap; 
        }
        /* MODIFICACIÓN: Ajuste de estilos para los contadores */
        .counter-item { 
            display: flex; flex-direction: column; align-items: center; 
            background-color: #d1d5db; padding: 5px 8px; border-radius: 0.375rem; 
            font-weight: 500; color: #1f2937; text-align: center; min-width: 6rem; 
            height: 80px; justify-content: space-between;
        }
        .counter-label { font-size: 0.75rem; white-space: nowrap; }
        .counter-value { font-size: 1rem; font-weight: 700; }
        .btn-logout, .btn-admin { padding: 0.25rem 0.75rem; font-size: 0.875rem; border: none; border-radius: 0.375rem; color: white; cursor: pointer; transition: background-color 0.3s; white-space: nowrap; }
        .btn-logout { background-color: #ef4444; }
        .btn-logout:hover { background-color: #dc2626; }
        #show-manage-users-modal { background-color: #1d4ed8; }
        #show-manage-users-modal:hover { background-color: #1e40af; }
        #show-full-log-modal { background-color: #059669; } /* Nuevo color para el Log Global */
        #show-full-log-modal:hover { background-color: #047857; }

        /* --- ESTILOS MEJORADOS PARA BOTÓN DE EDICIÓN --- */
        #show-edit-menu-modal { background-color: #f59e0b; /* Amarillo por defecto */ }
        #show-edit-menu-modal:hover { background-color: #d97706; }
        #show-edit-menu-modal.active { background-color: #16a34a; /* Verde para indicar "Finalizar" */ }
        #show-edit-menu-modal.active:hover { background-color: #15803d; }
        
        /* BOTÓN AÑADIR NUEVA FUNCIÓN AHORA ES VIOLETA */
        #add-new-button { background-color: #8B5CF6; color: #fff; }
        #add-new-button:hover { background-color: #7C3AED; }

        /* Estilos para arrastrar y soltar */
        .drop-area { border: 2px dashed #667eea; border-radius: 8px; padding: 10px; text-align: center; color: #667eea; }
        .drop-area.hover { background-color: #3e3e58; }

        /* Estilos pie de página */
        footer { text-align: center; width: 100%; padding: 1rem 0; }
        
        /* Estilos modal gestión de usuarios */
        .modal-body hr { border-color: #4b5563; }
        #user-list-container { margin-top: 15px; max-height: 200px; overflow-y: auto; width: 100%; }
        #user-list-to-delete li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #444; color: #e9e9f0; }
        #user-list-to-delete li:last-child { border-bottom: none; }
        #user-list-to-delete .btn-group { display: flex; gap: 5px; }
        #user-list-to-delete button { background-color: #dc3545; color: #fff; padding: 5px 10px; font-size: 0.8rem; border-radius: 5px; cursor: pointer; width: auto; margin-top: 0; }
        #user-list-to-delete .reset-btn { background-color: #1a73e8; }

        /* --- NUEVOS ESTILOS PARA EDICIÓN Y ANIDACIÓN --- */
        .menu-button-container { position: relative; }
        .edit-icon { position: absolute; top: 5px; right: 5px; width: 25px; height: 25px; background-color: rgba(0, 0, 0, 0.6); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; font-size: 12px; }
        .delete-icon { position: absolute; top: 5px; right: 35px; width: 25px; height: 25px; background-color: rgba(220, 53, 69, 0.8); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; font-size: 12px; }
        .back-icon { position: absolute; top: 5px; right: 65px; width: 25px; height: 25px; background-color: rgba(255, 193, 7, 0.8); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; font-size: 12px; }
        .edit-icon:hover { background-color: rgba(0, 0, 0, 0.8); }
        .delete-icon:hover { background-color: rgba(220, 53, 69, 1); }
        .back-icon:hover { background-color: rgba(255, 193, 7, 1); }
        .add-button-container { display: none; margin-top: 0.75rem; }
        .dragging { opacity: 0.5; border: 2px dashed #667eea; }
        
        /* ESTILOS DE ARRASTRAR Y SOLTAR */
        .drag-over-container { border: 2px dashed #667eea; }
        .drag-over-parent { box-shadow: 0 0 10px 2px #667eea; }

        .nested-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .color-circle-container {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        .color-circle {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }
        .color-circle:hover {
            transform: scale(1.1);
        }
        .color-circle.active {
            border-color: #fff;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.7);
        }

        /* Nuevo estilo para el icono de edición del título */
        .editable-title {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        .editable-title-icon {
            margin-left: 10px;
            cursor: pointer;
            color: #4b5563;
            font-size: 1.2rem;
            transition: color 0.2s;
        }
        .editable-title-icon:hover {
            color: #282844;
        }

        /* Estilos para el modal de edición de título */
        #edit-title-modal .modal {
            max-width: 500px;
        }
        #edit-title-modal .modal-body {
            gap: 10px;
        }

        .yellow-button {
            background-color: #facc15;
            color: #333;
            font-weight: bold;
        }

        .yellow-button:hover {
            background-color: #eab308;
        }
        
        /* Contenedor de botones de navegación */
        .navigation-buttons-row {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 1rem 0;
            margin-top: 0.75rem;
            gap: 0.75rem;
        }
        .navigation-button {
            padding: 0.5rem 0.5rem;
            font-size: 1rem;
            flex-grow: 0;
        }
        
        /* Estilos específicos para la tabla del Log Global */
        #full-log-modal .modal table {
            color: #e9e9f0;
            text-align: left;
        }
        #full-log-modal .modal table tbody tr:nth-child(even) { background-color: #1a1a2e; }
        #full-log-modal .modal table tbody tr:hover { background-color: #3e3e58; }
        
    </style>
</head>
<body class="bg-gray-100">

<header class="bg-blue-800 w-full flex justify-center items-center py-2">
    <div class="w-40 h-40 rounded-full overflow-hidden shadow-lg">
        <img src="logogad.png" alt="Logo GAD" class="w-full h-full object-cover block">
    </div>
</header>

<div class="main-content-wrapper px-4 sm:px-8 lg:px-12">
    <div class="menu-card">
        <div class="title-container">
            <h1 id="main-title" class="text-3xl sm:text-4xl font-extrabold text-gray-800 editable-title">
                <span id="main-title-text"></span>
                <span id="edit-title-icon" class="editable-title-icon" style="display: none;">
                    <i class="fas fa-edit"></i>
                </span>
            </h1>
        </div>
        
        <div id="drag-drop-zone-main-menu" class="border-2 border-dashed border-transparent p-2 rounded-lg transition-colors duration-300">
            <div id="main-menu-grid" class="grid grid-cols-2 gap-3 mt-2"></div>
        </div>
        
        <div id="navigation-buttons-container" style="display: none;" class="navigation-buttons-row"></div>

        <div id="secondary-menu-container" class="mt-3"></div>

        <div id="add-button-container" class="add-button-container">
            <button id="add-new-button" class="w-full flex items-center justify-center p-4 lg:p-6 text-white font-bold rounded-lg shadow-md transition-all duration-300 ease-in-out text-lg lg:text-xl">
                <i class="fas fa-plus mr-2"></i> Añadir Botón
            </button>
        </div>

        <div class="controls-container">
            <div id="counters-row" class="counters-row" style="display: none;"></div>
            <div class="admin-controls">
                <button id="show-edit-menu-modal" style="display: none;" class="btn-admin">Editar Menú</button>
                <button id="show-manage-users-modal" style="display: none;" class="btn-admin">Gestionar Usuarios</button>
                <button id="show-full-log-modal" style="display: none;" class="btn-admin">Registro Global de Visitas</button>
            </div>
            <button id="btn-logout" class="btn-logout">Cerrar Sesión</button>
        </div>
    </div>
</div>

<footer class="mt-auto text-center py-6 bg-gray-200">
    <div class="flex flex-col items-center">
        <hr class="border-t border-gray-400 w-11/12 max-w-md mx-auto mb-4">
        <p class="font-bold">GRUPO DE ANÁLISIS DOCUMENTAL</p>
        <p class="font-bold">POLICÍA LOCAL DE ALICANTE</p>
        <p>&copy; GAD - Todos los derechos reservados</p>
    </div>
</footer>

<div id="pin-modal-login" class="modal-overlay">
</div>

<div id="pin-modal-change" class="modal-overlay" style="display: none;">
</div>

<div id="manage-users-modal" class="modal-overlay" style="display: none;">
</div>

<div id="edit-button-modal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <span class="modal-close" id="close-edit-button-modal">&times;</span>
        <h2>Editar Botón</h2>
        <div class="modal-body">
            <input type="hidden" id="edit-button-id">
            <input type="text" id="edit-button-text" placeholder="Texto del botón" />
            <div id="edit-link-fields">
                <input type="text" id="edit-button-href" placeholder="Enlace (ej: vehiculos.html)" />
                <textarea id="edit-button-html-code" rows="5" placeholder="Código HTML"></textarea>
            </div>
            <div class="flex flex-col gap-4 mt-4">
                <p>Elige el tamaño del botón:</p>
                <div class="flex gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="edit-button-size" value="normal" checked class="mr-2"> Normal
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="edit-button-size" value="full-width" class="mr-2"> Largo
                    </label>
                </div>
            </div>
            <div class="color-options-container">
                <p>Elige un color:</p>
                <div class="color-circle-container">
                    <div class="color-circle active" style="background-color: #1e40af;" data-color="#1e40af"></div>
                    <div class="color-circle" style="background-color: #16a34a;" data-color="#16a34a"></div>
                    <div class="color-circle" style="background-color: #f59e0b;" data-color="#f59e0b"></div>
                    <div class="color-circle" style="background-color: #dc3545;" data-color="#dc3545"></div>
                    <div class="color-circle" style="background-color: #667eea;" data-color="#667eea"></div>
                </div>
            </div>
        </div>
        <button id="save-button-changes">Guardar Cambios</button>
        <p id="edit-button-message" class="success-message" style="margin-top: 15px;"></p>
    </div>
</div>

<div id="add-button-modal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <span class="modal-close" id="close-add-button-modal">&times;</span>
        <h2>Añadir Nuevo Botón</h2>
        <div class="modal-body">
            <input type="text" id="new-button-text" placeholder="Texto del nuevo botón" />
            <div class="flex gap-4 items-center">
                <label class="flex items-center">
                    <input type="radio" name="button-type" value="link" checked class="mr-2"> Enlace
                </label>
                <label class="flex items-center">
                    <input type="radio" name="button-type" value="menu" class="mr-2"> Menú
                </label>
            </div>
            <div class="flex flex-col gap-4 mt-4">
                <p>Elige el tamaño del botón:</p>
                <div class="flex gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="button-size" value="normal" checked class="mr-2"> Normal
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="button-size" value="full-width" class="mr-2"> Largo
                    </label>
                </div>
            </div>
            <div id="new-link-fields" class="mt-4">
                <textarea id="new-button-html-code" rows="5" class="drop-area" placeholder="Pega aquí tu código HTML o arrastra un archivo .html"></textarea>
            </div>
        </div>
        <button id="save-new-button">Guardar Botón</button>
        <p id="add-button-message" style="margin-top: 15px;"></p>
    </div>
</div>

<div id="edit-title-modal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <span class="modal-close" id="close-edit-title-modal">&times;</span>
        <h2>Editar Título</h2>
        <div class="modal-body">
            <input type="text" id="edit-title-input" placeholder="Nuevo título del menú" />
        </div>
        <button id="save-title-changes">Guardar Título</button>
        <p id="edit-title-message" class="success-message" style="margin-top: 15px;"></p>
    </div>
</div>

<div id="full-log-modal" class="modal-overlay" style="display: none;">
    </div>

<script>
    const firebaseConfig = {
      databaseURL: "https://gad-alicante-v3-default-rtdb.europe-west1.firebasedatabase.app",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    const BUTTONS_NODE = 'menuButtons';
    const TITLE_NODE = 'pageTitle';
    const ADMIN_USER_KEY = '-O_moQVi8kLzEDjrvb-M';
    
    // Selectores del DOM
    const mainMenuGrid = document.getElementById('main-menu-grid');
    const secondaryMenuContainer = document.getElementById('secondary-menu-container');
    const navigationButtonsContainer = document.getElementById('navigation-buttons-container');
    const dragDropZoneMainMenu = document.getElementById('drag-drop-zone-main-menu');
    const mainContent = document.querySelector('.main-content-wrapper');
    const btnLogout = document.getElementById('btn-logout');
    const controlsContainer = document.querySelector('.controls-container');
    const countersRow = document.getElementById('counters-row');
    const manageUsersModal = document.getElementById('manage-users-modal');

    // Selectores Admin
    const showManageUsersModalBtn = document.getElementById('show-manage-users-modal');
    const showEditMenuBtn = document.getElementById('show-edit-menu-modal');
    const showFullLogModalBtn = document.getElementById('show-full-log-modal');
    const addButtonContainer = document.getElementById('add-button-container');
    const addNewButtonBtn = document.getElementById('add-new-button');
    const editTitleIcon = document.getElementById('edit-title-icon');
    const mainTitleText = document.getElementById('main-title-text');

    // Selectores Modales
    const pinModalLogin = document.getElementById('pin-modal-login');
    const editButtonModal = document.getElementById('edit-button-modal');
    const addButtonModal = document.getElementById('add-button-modal');
    const editTitleModal = document.getElementById('edit-title-modal');
    const fullLogModal = document.getElementById('full-log-modal');
    const newButtonHtmlCodeTextarea = document.getElementById('new-button-html-code');
    const newLinkFields = document.getElementById('new-link-fields');
    
    let currentUser = null;
    let isEditMode = false;
    let menuButtonsData = {};
    let draggedItem = null;
    let currentMenuPath = [];

    // --- FUNCIÓN PARA OBTENER LA IP PÚBLICA ---
    async function getClientIP() {
        try {
            // Usar un servicio externo para obtener la IP pública
            const response = await fetch('https://api64.ipify.org?format=json');
            const data = await response.json();
            return data.ip || 'IP no disponible';
        } catch (error) {
            console.error("Error al obtener la IP:", error);
            return 'IP no disponible';
        }
    }

    // --- LÓGICA DE DRAG & DROP PARA EL CÓDIGO HTML ---
    newButtonHtmlCodeTextarea.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        e.target.classList.add('hover');
    });

    newButtonHtmlCodeTextarea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        e.target.classList.remove('hover');
    });

    newButtonHtmlCodeTextarea.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        e.target.classList.remove('hover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (file.name.endsWith('.html')) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    newButtonHtmlCodeTextarea.value = event.target.result;
                };
                reader.readAsText(file);
            } else {
                alert('Por favor, arrastra un archivo con extensión .html');
            }
        }
    });

    // --- LÓGICA DE MENÚ DINÁMICO ---
    function renderMenuButtons() {
        mainMenuGrid.innerHTML = '';
        secondaryMenuContainer.innerHTML = '';
        navigationButtonsContainer.innerHTML = '';
        navigationButtonsContainer.style.display = 'none';

        if (!menuButtonsData) return;
        
        const currentMenuId = currentMenuPath.length > 0 ? currentMenuPath[currentMenuPath.length - 1] : null;
        
        const buttonsToRender = Object.entries(menuButtonsData).filter(([key, buttonData]) => {
            if (currentMenuId === null) {
                return !buttonData.parent;
            } else {
                return buttonData.parent === currentMenuId;
            }
        }).sort(([, a], [, b]) => a.order - b.order);

        // Renderizar el título del menú actual
        renderCurrentTitle();

        buttonsToRender.forEach(([key, buttonData]) => {
            const container = createButtonElement(key, buttonData);
            if (buttonData.type === 'secondary' && currentMenuPath.length === 0) {
                secondaryMenuContainer.appendChild(container);
            } else {
                mainMenuGrid.appendChild(container);
            }
        });

        // Renderizar los botones de navegación si es un submenú
        if (currentMenuPath.length > 0) {
            navigationButtonsContainer.style.display = 'flex';
            
            const mainButton = document.createElement('button');
            mainButton.textContent = 'Menú Principal';
            mainButton.className = 'flex items-center justify-center font-bold rounded-lg shadow-md transition-all duration-300 ease-in-out yellow-button navigation-button w-40';
            mainButton.onclick = () => {
                currentMenuPath = [];
                renderMenuButtons();
            };
            navigationButtonsContainer.appendChild(mainButton);

            const backButton = document.createElement('button');
            backButton.textContent = 'Atrás';
            backButton.className = 'flex items-center justify-center font-bold rounded-lg shadow-md transition-all duration-300 ease-in-out yellow-button navigation-button w-40';
            backButton.onclick = () => {
                currentMenuPath.pop();
                renderMenuButtons();
            };
            navigationButtonsContainer.appendChild(backButton);
        }
    }
    
    function createButtonElement(key, buttonData) {
        const container = document.createElement('div');
        container.className = 'menu-button-container';
        
        // Aplicar la clase para el tamaño largo al contenedor del botón
        if (buttonData.size === 'full-width') {
            container.classList.add('col-span-2');
        }

        container.dataset.id = key;

        const link = document.createElement('a');
        link.className = `flex items-center justify-center p-4 lg:p-6 text-white font-bold rounded-lg shadow-md transition-all duration-300 ease-in-out text-lg lg:text-xl relative w-full`;
        
        link.style.backgroundColor = buttonData.color;
        link.innerHTML = `<span class="text-center">${buttonData.text}</span>`;
        
        if (buttonData.type === 'parent') {
            link.href = 'javascript:void(0);';
            link.addEventListener('click', () => {
                if (!isEditMode) {
                    currentMenuPath.push(key);
                    renderMenuButtons();
                }
            });
        } else if (buttonData.htmlCode) {
            link.href = 'javascript:void(0);';
            link.addEventListener('click', () => {
                if (!isEditMode) {
                    const blob = new Blob([buttonData.htmlCode], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    window.open(url, '_blank');
                }
            });
        } else if (buttonData.href) {
            link.href = isEditMode ? 'javascript:void(0);' : buttonData.href;
            if (!isEditMode) link.target = "_blank";
        }

        if (buttonData.logo) {
            link.classList.add('btn-con-logo');
            link.innerHTML += `<img src="${buttonData.logo}" alt="Logo" class="construccion-logo">`;
        }
        
        container.appendChild(link);

        if (isEditMode) {
            container.draggable = true;
            addDragAndDropHandlers(container);
            
            const editIcon = document.createElement('div');
            editIcon.className = 'edit-icon';
            editIcon.innerHTML = '<i class="fas fa-pencil-alt"></i>';
            editIcon.onclick = (e) => { e.stopPropagation(); showEditModal(key, buttonData.text, buttonData.color, buttonData.href, buttonData.htmlCode, buttonData.type, buttonData.size); };
            container.appendChild(editIcon);

            const deleteIcon = document.createElement('div');
            deleteIcon.className = 'delete-icon';
            deleteIcon.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteIcon.onclick = (e) => { e.stopPropagation(); deleteButton(key, buttonData.text, buttonData.parent); };
            container.appendChild(deleteIcon);
            
            if (buttonData.parent) {
                const backIcon = document.createElement('div');
                backIcon.className = 'back-icon';
                backIcon.innerHTML = '<i class="fas fa-reply"></i>';
                backIcon.onclick = (e) => { e.stopPropagation(); moveButtonToMainMenu(key); };
                container.appendChild(backIcon);
            }
        }
        
        return container;
    }

    function renderCurrentTitle() {
        const currentMenuId = currentMenuPath.length > 0 ? currentMenuPath[currentMenuPath.length - 1] : null;
        let titleRef = db.ref(TITLE_NODE);
        let defaultTitle = 'Menú Herramientas GAD';

        if (currentMenuId) {
            titleRef = db.ref(BUTTONS_NODE + '/' + currentMenuId + '/menuTitle');
            const parentData = menuButtonsData[currentMenuId];
            defaultTitle = parentData?.text || 'Submenú';
        }
        
        titleRef.once('value', (snapshot) => {
            const title = snapshot.val();
            mainTitleText.textContent = title || defaultTitle;
            editTitleIcon.dataset.ref = titleRef.toString();
        });
    }
    
    db.ref().on('value', (snapshot) => {
        const data = snapshot.val();
        menuButtonsData = data?.menuButtons || {};
        renderMenuButtons();
    });

    function deleteButton(buttonId, buttonText, parentId) {
        if (confirm(`¿Estás seguro de que quieres eliminar el botón "${buttonText}"? Esta acción no se puede rehacer.`)) {
            const updates = {};
            if (parentId) {
                const parentChildren = Object.values(menuButtonsData).filter(btn => btn.parent === parentId);
                if (parentChildren.length === 1) { 
                    updates[`/${BUTTONS_NODE}/${parentId}/children`] = null;
                }
            }
            updates[`/${BUTTONS_NODE}/${buttonId}`] = null;

            db.ref().update(updates)
                .then(() => {
                    alert('El botón ha sido eliminado con éxito.');
                })
                .catch(error => {
                    alert('Error al eliminar el botón: ' + error.message);
                });
        }
    }
    
    async function moveButtonToMainMenu(buttonId) {
        const updates = {};
        const snapshot = await db.ref(BUTTONS_NODE).once('value');
        const allButtons = snapshot.val() || {};
        
        const topLevelButtons = Object.values(allButtons).filter(btn => !btn.parent);
        const newOrder = topLevelButtons.length + 1;
        
        updates[`/${BUTTONS_NODE}/${buttonId}/parent`] = null;
        updates[`/${BUTTONS_NODE}/${buttonId}/order`] = newOrder;

        db.ref().update(updates)
            .then(() => {
                alert('El botón ha sido movido al menú principal.');
                renderMenuButtons();
            })
            .catch(error => {
                alert('Error al mover el botón: ' + error.message);
            });
    }

    // --- LÓGICA DE DRAG & DROP EN MENÚ PRINCIPAL ---
    function addDragAndDropHandlers(item) {
        item.addEventListener('dragstart', (e) => {
            draggedItem = item;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', item.dataset.id);
            setTimeout(() => item.classList.add('dragging'), 0);
        });

        item.addEventListener('dragend', () => {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
            }
            document.querySelectorAll('.drag-over-container, .drag-over-parent').forEach(el => el.classList.remove('drag-over-container', 'drag-over-parent'));
        });
        
        // Manejar el dragover para los botones de tipo 'parent'
        item.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const targetData = menuButtonsData[item.dataset.id];
            if (draggedItem && draggedItem.dataset.id !== item.dataset.id && targetData.type === 'parent' && isEditMode) {
                item.classList.add('drag-over-parent');
            }
        });
        
        item.addEventListener('dragleave', (e) => {
            item.classList.remove('drag-over-parent');
        });
        
        item.addEventListener('drop', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            item.classList.remove('drag-over-parent');
            
            if (draggedItem) {
                const draggedId = draggedItem.dataset.id;
                const targetId = item.dataset.id;
                const targetData = menuButtonsData[targetId];

                if (draggedId !== targetId && targetData.type === 'parent' && isEditMode) {
                    // Mover un botón dentro de otro (anidación)
                    const updates = {};
                    
                    // Quitar del padre anterior si existe
                    const draggedData = menuButtonsData[draggedId];
                    if (draggedData.parent) {
                        const oldParentChildren = Object.values(menuButtonsData).filter(btn => btn.parent === draggedData.parent && btn.id !== draggedId);
                        if (oldParentChildren.length === 0) {
                            updates[`/${BUTTONS_NODE}/${draggedData.parent}/children`] = null;
                        }
                    }
                    
                    // Asignar nuevo padre
                    updates[`/${BUTTONS_NODE}/${draggedId}/parent`] = targetId;

                    // Asignar nuevo orden dentro del menú
                    const childrenRef = db.ref(BUTTONS_NODE).orderByChild('parent').equalTo(targetId);
                    const snapshot = await childrenRef.once('value');
                    const newOrder = snapshot.exists() ? Object.values(snapshot.val()).length + 1 : 1;
                    updates[`/${BUTTONS_NODE}/${draggedId}/order`] = newOrder;

                    db.ref().update(updates)
                        .then(() => {
                            renderMenuButtons();
                            draggedItem = null;
                        });
                } else if (isEditMode) {
                    // Reordenar dentro del mismo nivel (lógica original)
                    const parentContainer = item.parentElement;
                    const afterElement = getDragAfterElement(parentContainer, e.clientY);
                    if (afterElement == null) { parentContainer.appendChild(draggedItem); } 
                    else { parentContainer.insertBefore(draggedItem, afterElement); }
                    updateButtonOrder();
                }
            }
        });
    }

    dragDropZoneMainMenu.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragDropZoneMainMenu.classList.add('drag-over-container');
    });

    dragDropZoneMainMenu.addEventListener('dragleave', (e) => {
        if (!dragDropZoneMainMenu.contains(e.relatedTarget)) {
            dragDropZoneMainMenu.classList.remove('drag-over-container');
        }
    });

    dragDropZoneMainMenu.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragDropZoneMainMenu.classList.remove('drag-over-container');
        if (draggedItem) {
            const afterElement = getDragAfterElement(mainMenuGrid, e.clientY);
            if (afterElement == null) {
                mainMenuGrid.appendChild(draggedItem);
            } else {
                mainMenuGrid.insertBefore(draggedItem, afterElement);
            }
            updateButtonOrder();
        }
    });

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.menu-button-container:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } 
            else { return closest; }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function updateButtonOrder() {
        const updates = {};
        const elements = document.querySelectorAll('#main-menu-grid .menu-button-container, #secondary-menu-container .menu-button-container');
        elements.forEach((btn, index) => {
            updates[`/${BUTTONS_NODE}/${btn.dataset.id}/order`] = index + 1;
        });
        db.ref().update(updates);
    }

    // --- LÓGICA DE AUTENTICACIÓN Y SESIÓN ---
    async function loginSuccess(userId, user) {
        currentUser = userId;
        sessionStorage.setItem('loggedInUser', userId);
        pinModalLogin.style.display = 'none';
        mainContent.style.display = 'flex';

        const isAdmin = userId === ADMIN_USER_KEY;
        showManageUsersModalBtn.style.display = isAdmin ? 'block' : 'none';
        showEditMenuBtn.style.display = isAdmin ? 'block' : 'none';
        showFullLogModalBtn.style.display = isAdmin ? 'block' : 'none';
        editTitleIcon.style.display = isAdmin ? 'inline-block' : 'none';
        countersRow.style.display = isAdmin ? 'flex' : 'none';
        controlsContainer.style.display = 'flex';

        // 1. Actualizar el contador de accesos
        db.ref('usuarios/' + userId + '/accesos').transaction((currentValue) => (currentValue || 0) + 1);
        
        // 2. Obtener IP y actualizar la marca de tiempo del último acceso
        const now = Date.now();
        const userIP = await getClientIP();

        db.ref('usuarios/' + userId).update({ 
            ultimoAcceso: now
        });

        // 3. Registrar el acceso individual en el log CON IP
        db.ref('visitLog').push().set({
            userId: userId,
            userName: user.nombre, 
            timestamp: now,
            ip: userIP
        });
    }

    btnLogout.addEventListener('click', () => {
        currentUser = null;
        if (isEditMode) { isEditMode = false; toggleEditModeUI(); }
        sessionStorage.removeItem('loggedInUser');
        mainContent.style.display = 'none';
        controlsContainer.style.display = 'none';
        pinModalLogin.style.display = 'flex';
    });
    function checkLoginStatus() {
        const loggedInUser = sessionStorage.getItem('loggedInUser');
        if (loggedInUser) { 
            // Si está logueado, re-obtener el nombre de usuario para el `loginSuccess`
            db.ref('usuarios/' + loggedInUser).once('value').then(snapshot => {
                const user = snapshot.val();
                if(user) loginSuccess(loggedInUser, user);
                else {
                    // Si el usuario ya no existe o hay un error, forzar logout
                    sessionStorage.removeItem('loggedInUser');
                    checkLoginStatus(); 
                }
            });
        } 
        else {
            mainContent.style.display = 'none';
            controlsContainer.style.display = 'none';
            pinModalLogin.style.display = 'flex';
        }
    }
    
    // --- LÓGICA DE MODALES DE EDICIÓN ---
    function toggleEditModeUI() {
        isEditMode = !isEditMode;
        showEditMenuBtn.classList.toggle('active', isEditMode);
        showEditMenuBtn.textContent = isEditMode ? 'Finalizar Edición' : 'Editar Menú';
        addButtonContainer.style.display = isEditMode ? 'block' : 'none';
        editTitleIcon.style.display = isEditMode && currentUser === ADMIN_USER_KEY ? 'inline-block' : 'none';
        renderMenuButtons();
    }
    showEditMenuBtn.addEventListener('click', () => { toggleEditModeUI(); });
    
    function showEditModal(buttonId, text, color, href, htmlCode, type, size) {
        document.getElementById('edit-button-id').value = buttonId;
        document.getElementById('edit-button-text').value = text;
        
        const editLinkFields = document.getElementById('edit-link-fields');
        const hrefField = document.getElementById('edit-button-href');
        const htmlCodeField = document.getElementById('edit-button-html-code');

        if (type === 'link' || type === 'main') {
            editLinkFields.style.display = 'block';
            hrefField.value = href || '';
            htmlCodeField.value = htmlCode || '';
        } else {
            editLinkFields.style.display = 'none';
        }

        // Seleccionar el tamaño del botón
        const editButtonSizeRadios = document.querySelectorAll('input[name="edit-button-size"]');
        editButtonSizeRadios.forEach(radio => {
            radio.checked = radio.value === size;
        });

        document.querySelectorAll('.color-circle').forEach(circle => {
            circle.classList.remove('active');
            if (circle.dataset.color === color) {
                circle.classList.add('active');
            }
        });

        document.getElementById('edit-button-message').textContent = '';
        editButtonModal.style.display = 'flex';
    }

    document.getElementById('save-button-changes').addEventListener('click', () => {
        const buttonId = document.getElementById('edit-button-id').value;
        const newText = document.getElementById('edit-button-text').value.trim();
        const newColor = document.querySelector('.color-circle.active')?.dataset.color || '#1e40af';
        const newHref = document.getElementById('edit-button-href').value.trim();
        const newHtmlCode = document.getElementById('edit-button-html-code').value.trim();
        const newSize = document.querySelector('input[name="edit-button-size"]:checked').value;
        
        if (!newText) { alert('El texto no puede estar vacío.'); return; }
        
        const updates = { text: newText, color: newColor, size: newSize };
        
        // Mantener el tipo actual del botón
        const buttonType = menuButtonsData[buttonId].type;
        if (buttonType === 'link' || buttonType === 'main') {
            updates.href = newHref;
            updates.htmlCode = newHtmlCode;
        }

        db.ref(BUTTONS_NODE + '/' + buttonId).update(updates)
            .then(() => {
                document.getElementById('edit-button-message').textContent = '¡Guardado con éxito!';
                setTimeout(() => { editButtonModal.style.display = 'none'; }, 1500);
            });
    });

    document.querySelector('#edit-button-modal .modal-body').addEventListener('click', (e) => {
        if (e.target.classList.contains('color-circle')) {
            document.querySelectorAll('.color-circle').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
        }
    });

    addNewButtonBtn.addEventListener('click', () => {
        document.getElementById('new-button-text').value = '';
        document.getElementById('new-button-html-code').value = '';
        document.getElementById('add-button-message').textContent = '';
        newLinkFields.style.display = 'block'; // Mostrar por defecto el campo de HTML
        document.querySelector('input[name="button-type"][value="link"]').checked = true;
        document.querySelector('input[name="button-size"][value="normal"]').checked = true;
        addButtonModal.style.display = 'flex';
    });

    document.querySelectorAll('input[name="button-type"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            if (e.target.value === 'link') {
                newLinkFields.style.display = 'block';
            } else {
                newLinkFields.style.display = 'none';
            }
        });
    });
    
    document.getElementById('save-new-button').addEventListener('click', async () => {
        const text = document.getElementById('new-button-text').value.trim();
        const buttonType = document.querySelector('input[name="button-type"]:checked').value;
        const buttonSize = document.querySelector('input[name="button-size"]:checked').value;
        const messageEl = document.getElementById('add-button-message');
        
        if (!text) {
            messageEl.textContent = 'El texto es obligatorio.';
            messageEl.style.color = '#dc3545';
            return;
        }

        let newButtonData = { text };
        
        if (buttonType === 'link') {
            const htmlCode = document.getElementById('new-button-html-code').value.trim();
            if (!htmlCode) {
                messageEl.textContent = 'El código HTML es obligatorio para un enlace.';
                messageEl.style.color = '#dc3545';
                return;
            }
            newButtonData.htmlCode = htmlCode;
            newButtonData.type = "main";
            newButtonData.color = "#16a34a"; // Verde por defecto para enlaces
        } else {
            newButtonData.type = "parent";
            newButtonData.color = "#1e40af"; // Azul por defecto para menús
        }

        newButtonData.size = buttonSize; // Guardar el tamaño del botón
        
        const parentId = currentMenuPath.length > 0 ? currentMenuPath[currentMenuPath.length - 1] : null;
        const dbRef = db.ref(BUTTONS_NODE).orderByChild('parent').equalTo(parentId);
        const snapshot = await dbRef.once('value');
        const newOrder = snapshot.exists() ? Object.values(snapshot.val()).length + 1 : 1;
        newButtonData.order = newOrder;

        if (parentId) {
            newButtonData.parent = parentId;
        }

        db.ref(BUTTONS_NODE).push(newButtonData)
            .then(() => {
                messageEl.textContent = 'Botón añadido. ¡Sal del modo edición para usarlo!';
                messageEl.style.color = '#28a745';
                setTimeout(() => addButtonModal.style.display = 'none', 2000);
            })
            .catch(() => { messageEl.textContent = 'Error al guardar.'; messageEl.style.color = '#dc3545'; });
    });

    // Lógica para el modal de edición de título
    editTitleIcon.addEventListener('click', () => {
        const currentTitle = mainTitleText.textContent;
        document.getElementById('edit-title-input').value = currentTitle;
        document.getElementById('edit-title-message').textContent = '';
        editTitleModal.style.display = 'flex';
    });

    document.getElementById('save-title-changes').addEventListener('click', () => {
        const newTitle = document.getElementById('edit-title-input').value.trim();
        const titleRef = editTitleIcon.dataset.ref;
        if (newTitle) {
            db.refFromURL(titleRef).set(newTitle)
                .then(() => {
                    document.getElementById('edit-title-message').textContent = 'Título guardado con éxito.';
                    setTimeout(() => editTitleModal.style.display = 'none', 1500);
                })
                .catch(() => {
                    document.getElementById('edit-title-message').textContent = 'Error al guardar el título.';
                });
        }
    });

    // Event listeners para los botones de cerrar modales
    document.getElementById('close-edit-button-modal').onclick = () => editButtonModal.style.display = 'none';
    document.getElementById('close-add-button-modal').onclick = () => addButtonModal.style.display = 'none';
    document.getElementById('close-edit-title-modal').onclick = () => editTitleModal.style.display = 'none';

    // *** LÓGICA DE ABRIR MODAL DE GESTIÓN DE USUARIOS ***
    showManageUsersModalBtn.addEventListener('click', () => {
        manageUsersModal.style.display = 'flex';
    });
    
    // --- CARGA INICIAL Y RELLENO DE MODALES ---
    window.addEventListener('DOMContentLoaded', () => {
        // Rellena el contenido de los modales que no se han tocado
        pinModalLogin.innerHTML = `<div class="modal"><div class="modal-header-logo"><img src="logogad.png" alt="Logo de GAD"/></div><h2>Acceso</h2><p>Selecciona tu usuario e introduce tu PIN</p><div class="modal-body"><select id="user-selector"></select><input type="password" id="pin-input-login" placeholder="Introduce tu PIN" maxlength="4" inputmode="numeric"/></div><button id="pin-submit-login">Acceder</button><button id="show-change-pin-modal" style="background:none;border:none;color:#667eea;margin-top:10px;font-weight:600;">Modificar PIN</button><p id="pin-error-login" class="error-message" style="display:none;"></p></div>`;
        document.getElementById('pin-modal-change').innerHTML = `<div class="modal"><span class="modal-close" id="close-change-modal">&times;</span><h2>Cambiar PIN</h2><div class="modal-body"><input type="password" id="current-pin" placeholder="PIN actual" maxlength="4"/><input type="password" id="new-pin-1" placeholder="Nuevo PIN" maxlength="4"/><input type="password" id="new-pin-2" placeholder="Repite el nuevo PIN" maxlength="4"/></div><button id="pin-submit-change">Guardar nuevo PIN</button><p id="pin-message-change" style="margin-top:15px;"></p></div>`;
        document.getElementById('manage-users-modal').innerHTML = `<div class="modal"><span class="modal-close" id="close-manage-users-modal">&times;</span><h2>Gestionar Usuarios</h2><div class="modal-body"><h3>Añadir Nuevo Usuario</h3><input type="text" id="new-user-name" placeholder="Nombre del usuario"/><input type="password" id="new-user-pin" placeholder="PIN de 4 dígitos" maxlength="4"/><button id="add-user-button">Añadir Usuario</button><p id="add-user-message" style="margin-top:15px;"></p><hr class="border-t border-gray-400 w-full my-4"><h3 style="margin-bottom:10px;">Eliminar/Resetear Visitas</h3><div id="user-list-container"><ul id="user-list-to-delete"></ul></div></div></div>`;
        
        // MODIFICACIÓN: Inyección de HTML con el menú de gestión en el modal de log global
        document.getElementById('full-log-modal').innerHTML = `
            <div class="modal" style="max-width: 800px; height: 90vh;">
                <span class="modal-close" id="close-full-log-modal">&times;</span>
                <h2 style="margin-bottom: 5px;">Registro Completo de Visitas (Global)</h2>
                <div id="full-log-controls" style="padding: 15px; border-bottom: 1px solid #444; margin-bottom: 15px; background-color: #1a1a2e; border-radius: 5px;">
                    <h3 style="color:#667eea; margin-bottom: 10px;">Gestión de Visitas (Solo Admin)</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button id="reset-all-user-visits" class="btn-admin" style="background-color: #dc3545; width: 100%;">
                            <i class="fas fa-undo-alt"></i> Resetear *TODOS* los Contadores de Usuarios
                        </button>
                        <button id="clear-global-log" class="btn-admin" style="background-color: #f59e0b; width: 100%;">
                            <i class="fas fa-trash-alt"></i> Borrar Registro Global de Visitas (visitLog)
                        </button>
                        <hr style="border-color: #4b5563; margin: 10px 0;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <select id="user-selector-reset" style="flex-grow: 1; padding: 10px; font-size: 1em; border-radius: 5px; border: 1px solid #555; background-color: #282844; color: #e9e9f0;"></select>
                            <button id="reset-user-visits-button" class="btn-admin" style="background-color: #1a73e8; width: 180px;">
                                Resetear Usuario
                            </button>
                        </div>
                    </div>
                </div>
                <div id="full-log-container" style="max-height: calc(100% - 220px); overflow-y: auto; padding-top: 5px;">
                    </div>
            </div>`;
        
        originalModalLogic();
        checkLoginStatus();
        
        // --- Eventos del Modal de Log Global ---
        document.getElementById('close-full-log-modal').onclick = () => {
            fullLogModal.style.display = 'none';
        };
        showFullLogModalBtn.addEventListener('click', () => {
            renderFullGlobalLog();
            fullLogModal.style.display = 'flex';
        });

        // Carga de usuarios para el selector de reseteo en el modal de log global
        db.ref('usuarios').once('value').then(snapshot => {
            const users = snapshot.val();
            const userSelectorReset = document.getElementById('user-selector-reset');
            if (userSelectorReset) {
                userSelectorReset.innerHTML = '<option value="">-- Selecciona Usuario --</option>';
                if (users) {
                    Object.entries(users).sort(([,a],[,b]) => a.nombre.localeCompare(b.nombre)).forEach(([key, user]) => {
                        const option = document.createElement('option');
                        option.value = key; option.textContent = user.nombre;
                        userSelectorReset.appendChild(option);
                    });
                }
            }
        });

        // Event Listeners para la NUEVA gestión en el modal de log global
        document.getElementById('reset-all-user-visits').addEventListener('click', resetAllUserVisits);
        document.getElementById('clear-global-log').addEventListener('click', clearGlobalVisitLog);
        document.getElementById('reset-user-visits-button').addEventListener('click', () => {
            const userId = document.getElementById('user-selector-reset').value;
            if (userId) {
                // Llama a la función global para resetear un usuario individual
                resetUserVisits(userId);
            } else {
                alert('Por favor, selecciona un usuario.');
            }
        });
        // ---------------------------------------------------
    });

    // Función de reseteo individual, extraída para ser global y usada en ambos modales
    async function resetUserVisits(userId) {
        if (!confirm('¿Estás seguro de que quieres resetear las visitas de este usuario?')) {
            return;
        }
        try {
            await db.ref('usuarios/' + userId).update({ accesos: 0 });
            alert('Contador de visitas reseteado con éxito.');
            // Forzar recarga de usuarios para actualizar la UI del contador
            db.ref('usuarios').once('value').then(snap => renderAdminCounters(snap.val()));
        } catch (error) {
            alert('Error al resetear el contador.');
            console.error("Error resetting user visits:", error);
        }
    }
    
    // NUEVAS FUNCIONES DE RESETEO GLOBAL (Para la gestión en el modal de Log Global)
    async function resetAllUserVisits() {
        if (!confirm('ADVERTENCIA: ¿Estás seguro de que quieres RESETEAR los contadores de visitas (accesos: 0) de *TODOS* los usuarios?')) {
            return;
        }
        try {
            const usersRef = db.ref('usuarios');
            const snapshot = await usersRef.once('value');
            const updates = {};
            
            snapshot.forEach(childSnapshot => {
                updates[childSnapshot.key + '/accesos'] = 0;
            });
            
            await usersRef.update(updates);
            alert('Contadores de visitas de todos los usuarios reseteados a 0 con éxito.');
            // Forzar recarga de usuarios para actualizar la UI del contador
            db.ref('usuarios').once('value').then(snap => renderAdminCounters(snap.val()));
        } catch (error) {
            alert('Error al resetear todos los contadores: ' + error.message);
            console.error("Error resetting all user visits:", error);
        }
    }

    async function clearGlobalVisitLog() {
        if (!confirm('ADVERTENCIA: ¿Estás seguro de que quieres BORRAR permanentemente el *REGISTRO GLOBAL DE VISITAS* (la lista de accesos con fecha, hora e IP)?')) {
            return;
        }
        try {
            await db.ref('visitLog').remove();
            alert('Registro global de visitas borrado con éxito.');
            renderFullGlobalLog(); // Recargar el log global vacío
        } catch (error) {
            alert('Error al borrar el registro global: ' + error.message);
            console.error("Error clearing global log:", error);
        }
    }

    function originalModalLogic() {
        const userSelector = document.getElementById('user-selector');
        const pinInputLogin = document.getElementById('pin-input-login');
        // Referencias a los elementos del modal de cambio de PIN (accesibles después de DOMContentLoaded)
        const showChangePinModalBtn = document.getElementById('show-change-pin-modal');
        const pinModalChange = document.getElementById('pin-modal-change');
        const closeChangeModalBtn = document.getElementById('close-change-modal');
        const pinSubmitChangeBtn = document.getElementById('pin-submit-change');
        const currentPinInput = document.getElementById('current-pin');
        const newPin1Input = document.getElementById('new-pin-1');
        const newPin2Input = document.getElementById('new-pin-2');
        const pinMessageChange = document.getElementById('pin-message-change');


        // Nuevo: Mueve el foco al PIN al seleccionar usuario
        userSelector.addEventListener('change', () => {
            if (userSelector.value) {
                pinInputLogin.focus();
            }
        });

        // Nuevo: Inicia sesión automáticamente al introducir 4 dígitos
        pinInputLogin.addEventListener('input', () => {
            if (pinInputLogin.value.length === 4) {
                document.getElementById('pin-submit-login').click();
            }
        });

        document.getElementById('pin-submit-login').addEventListener('click', async () => {
            const userId = userSelector.value;
            const pin = pinInputLogin.value;
            if (!userId) { document.getElementById('pin-error-login').textContent = 'Por favor, selecciona un usuario.'; document.getElementById('pin-error-login').style.display = 'block'; return; }
            if (pin.length !== 4 || isNaN(pin)) { document.getElementById('pin-error-login').textContent = 'El PIN debe ser un número de 4 dígitos.'; document.getElementById('pin-error-login').style.display = 'block'; return; }
            
            const snapshot = await db.ref('usuarios/' + userId).once('value');
            const user = snapshot.val();
            // MODIFICACIÓN: Pasar el objeto 'user' a loginSuccess
            if (user && user.pin === pin) { 
                document.getElementById('pin-error-login').style.display = 'none';
                loginSuccess(userId, user); 
            } 
            else { document.getElementById('pin-error-login').textContent = 'PIN incorrecto.'; document.getElementById('pin-error-login').style.display = 'block'; }
        });
        document.getElementById('pin-input-login').addEventListener('keypress', (e) => { if (e.key === 'Enter') document.getElementById('pin-submit-login').click(); });
        
        function loadUsers() {
            db.ref('usuarios').on('value', (snapshot) => {
                const users = snapshot.val();
                userSelector.innerHTML = '<option value="">-- Selecciona tu usuario --</option>';
                if (users) {
                    const sortedUsers = Object.entries(users).sort(([,a],[,b]) => a.nombre.localeCompare(b.nombre));
                    
                    let totalVisits = 0;
                    const userList = document.getElementById('user-list-to-delete');
                    userList.innerHTML = '';
                    
                    sortedUsers.forEach(([key, user]) => {
                        const visits = user.accesos || 0;
                        totalVisits += visits;
                        const option = document.createElement('option');
                        option.value = key; option.textContent = user.nombre;
                        userSelector.appendChild(option);

                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>${user.nombre}</span>
                            <div class="btn-group">
                                <span style="font-size:0.8em;color:#e9e9f0;margin-right:10px;">Visitas: ${user.accesos || 0}</span>
                                <button class="reset-btn" data-user-id="${key}">Reset</button>
                                <button data-user-id="${key}">Eliminar</button>
                            </div>
                        `;
                        userList.appendChild(li);
                    });
                    
                    if (currentUser === ADMIN_USER_KEY && users) {
                        renderAdminCounters(users);
                    }
                }
            });
        }
        
        // MODIFICACIÓN: Función para renderizar TODOS los usuarios con sus visitas (Punto 1 y 2)
        function renderAdminCounters(users) {
            
            // Ordenar todos los usuarios por nombre para un listado coherente
            let sortedUsers = Object.entries(users)
                .map(([key, user]) => ({
                    key,
                    ...user
                }))
                .sort((a, b) => a.nombre.localeCompare(b.nombre)); // Ordenar por nombre

            const countersHtml = [];
            // YA NO SE MUESTRA SOLO slice(0, 4)

            sortedUsers.forEach(user => {
                const visits = user.accesos || 0;
                
                const lastAccessTimestamp = user.ultimoAcceso;
                let lastAccessText = 'Nunca';
                if (lastAccessTimestamp) {
                    const date = new Date(lastAccessTimestamp);
                    lastAccessText = date.toLocaleString('es-ES', { 
                        day: '2-digit', month: '2-digit', year: 'numeric', 
                        hour: '2-digit', minute: '2-digit' 
                    });
                }

                // NUEVO HTML para mostrar visitas debajo (Punto 2)
                countersHtml.push(`
                    <div class="counter-item" style="height: auto; justify-content: space-between; padding: 5px; min-height: 80px; width: 100px;">
                        <div class="counter-label" style="font-weight: 700; color: #1f2937; font-size: 0.85rem; width: 100%;">${user.nombre}</div>
                        <div class="counter-value" style="font-size: 1.1rem; font-weight: 700;">Visitas: ${visits}</div>
                        <div style="font-size:0.65rem; color:#4b5563; margin-top:5px; text-align: center; width: 100%;">Último acceso: ${lastAccessText}</div>
                        <button 
                            onclick="openUserVisitHistory('${user.key}', '${user.nombre}')" 
                            style="padding: 2px 5px; font-size: 0.7rem; background-color: #667eea; color: white; border-radius: 3px; cursor: pointer; border: none; width: 100%; margin-top: 3px;">
                            Ver Historial
                        </button>
                    </div>
                `);
            });

            // Contador total de visitas
            const totalVisitsCount = Object.values(users).reduce((acc, user) => acc + (user.accesos || 0), 0);

            const totalCounterHtml = `
                <div class="counter-item" style="background-color: #3b82f6; color: white; height: 80px; justify-content: space-around;">
                    <div class="counter-label" style="font-size: 0.85rem; font-weight: 700;">TOTAL VISITAS</div>
                    <div class="counter-value" style="font-size: 1.2rem;">${totalVisitsCount}</div>
                    <div style="font-size:0.65rem; color: #bfdbfe; margin-top:2px;">(De ${Object.keys(users).length} usuarios)</div>
                </div>
            `;
            
            // Mostrar el total y todos los usuarios
            countersRow.innerHTML = totalCounterHtml + countersHtml.join('');
        }

        // ***************************************************************
        // *** LÓGICA DE MODIFICAR PIN ***
        // ***************************************************************

        // 1. Evento para abrir el modal de cambio de PIN
        if (showChangePinModalBtn) {
            showChangePinModalBtn.addEventListener('click', () => {
                const userId = userSelector.value;
                if (!userId) {
                    document.getElementById('pin-error-login').textContent = 'Selecciona tu usuario primero.';
                    document.getElementById('pin-error-login').style.display = 'block';
                    return;
                }
                
                // Limpiar campos y mostrar modal
                currentPinInput.value = '';
                newPin1Input.value = '';
                newPin2Input.value = '';
                pinMessageChange.textContent = '';
                pinMessageChange.style.color = '';

                document.getElementById('pin-error-login').style.display = 'none'; // Oculta error del login
                pinModalLogin.style.display = 'none'; // Cierra el modal de login
                pinModalChange.style.display = 'flex'; // Abre el modal de cambio
                setTimeout(() => currentPinInput.focus(), 100);
            });
        }
        
        // 2. Evento para cerrar el modal de cambio de PIN
        if (closeChangeModalBtn) {
            closeChangeModalBtn.addEventListener('click', () => {
                pinModalChange.style.display = 'none';
            });
        }

        // 3. Evento para guardar el nuevo PIN
        if (pinSubmitChangeBtn) {
            pinSubmitChangeBtn.addEventListener('click', async () => {
                const userId = userSelector.value;
                const currentPin = currentPinInput.value.trim();
                const newPin1 = newPin1Input.value.trim();
                const newPin2 = newPin2Input.value.trim();

                // Validaciones de formato
                const pinRegex = /^\d{4}$/; // 4 dígitos numéricos
                if (!pinRegex.test(currentPin) || !pinRegex.test(newPin1) || !pinRegex.test(newPin2)) {
                    pinMessageChange.textContent = 'Todos los PIN deben ser números de 4 dígitos.';
                    pinMessageChange.style.color = '#dc3545';
                    return;
                }
                
                // Validaciones de coincidencia
                if (newPin1 !== newPin2) {
                    pinMessageChange.textContent = 'Los nuevos PIN no coinciden.';
                    pinMessageChange.style.color = '#dc3545';
                    return;
                }
                if (currentPin === newPin1) {
                    pinMessageChange.textContent = 'El nuevo PIN debe ser diferente al actual.';
                    pinMessageChange.style.color = '#dc3545';
                    return;
                }

                pinSubmitChangeBtn.disabled = true;

                // 2. Verificar PIN actual en Firebase
                const userRef = db.ref('usuarios/' + userId);
                try {
                    const snapshot = await userRef.once('value');
                    const user = snapshot.val();

                    if (user && user.pin === currentPin) {
                        // 3. Guardar nuevo PIN
                        await userRef.update({ pin: newPin1 });
                        
                        pinMessageChange.textContent = 'PIN cambiado con éxito. Vuelve a iniciar sesión.';
                        pinMessageChange.style.color = '#28a745';
                        
                        // Cierre de sesión y modal después de un breve mensaje
                        setTimeout(() => {
                            pinModalChange.style.display = 'none';
                            if (btnLogout) btnLogout.click(); // Forzar cierre de sesión
                        }, 2000);

                    } else {
                        pinMessageChange.textContent = 'PIN actual incorrecto.';
                        pinMessageChange.style.color = '#dc3545';
                    }
                } catch (error) {
                    pinMessageChange.textContent = 'Error al verificar/guardar el PIN.';
                    pinMessageChange.style.color = '#dc3545';
                    console.error("Change PIN error:", error);
                } finally {
                    pinSubmitChangeBtn.disabled = false;
                }
            });
        }
        
        // ***************************************************************
        // *** FIN LÓGICA DE MODIFICAR PIN ***
        // ***************************************************************
        
        // *** LÓGICA DE GESTIÓN DE USUARIOS (Añadir y Eliminar) ***
        
        // Cierra el modal de gestión de usuarios
        document.getElementById('close-manage-users-modal').addEventListener('click', () => {
            manageUsersModal.style.display = 'none';
        });

        // Event listener para añadir un nuevo usuario
        document.getElementById('add-user-button').addEventListener('click', addUser);
        
        async function addUser() {
            const userName = document.getElementById('new-user-name').value.trim();
            const userPin = document.getElementById('new-user-pin').value.trim();
            const messageEl = document.getElementById('add-user-message');

            if (!userName || !userPin) {
                messageEl.textContent = 'El nombre y el PIN son obligatorios.';
                messageEl.style.color = '#dc3545';
                return;
            }

            if (userPin.length !== 4 || isNaN(userPin)) {
                messageEl.textContent = 'El PIN debe ser un número de 4 dígitos.';
                messageEl.style.color = '#dc3545';
                return;
            }

            // Comprobar si el nombre de usuario ya existe
            const usersRef = db.ref('usuarios');
            const snapshot = await usersRef.orderByChild('nombre').equalTo(userName).once('value');
            if (snapshot.exists()) {
                messageEl.textContent = 'Ese nombre de usuario ya existe.';
                messageEl.style.color = '#dc3545';
                return;
            }

            const newUser = {
                nombre: userName,
                pin: userPin,
                accesos: 0
            };

            usersRef.push(newUser)
                .then(() => {
                    messageEl.textContent = 'Usuario añadido con éxito.';
                    messageEl.style.color = '#28a745';
                    document.getElementById('new-user-name').value = '';
                    document.getElementById('new-user-pin').value = '';
                })
                .catch(error => {
                    messageEl.textContent = 'Error al añadir el usuario.';
                    messageEl.style.color = '#dc3545';
                    console.error("Error adding user:", error);
                });
        }
        
        // Event listener para los botones de la lista de usuarios (Eliminar y Resetear)
        document.getElementById('user-list-to-delete').addEventListener('click', (e) => {
            const target = e.target;
            const userId = target.getAttribute('data-user-id');
            
            if (!userId) return;

            if (target.textContent === 'Reset') {
                resetUserVisits(userId);
            } else if (target.textContent === 'Eliminar') {
                deleteUser(userId);
            }
        });
        
        function deleteUser(userId) {
            if (!confirm('¿Estás seguro de que quieres ELIMINAR este usuario? Esta acción no se puede deshacer.')) {
                return;
            }
            db.ref('usuarios/' + userId).remove()
                .then(() => {
                    alert('Usuario eliminado con éxito.');
                })
                .catch(error => {
                    alert('Error al eliminar el usuario.');
                    console.error("Error deleting user:", error);
                });
        }
        
        // *******************************************************************
        
        // *** LÓGICA: HISTORIAL DE VISITAS POR USUARIO EN NUEVA VENTANA (Mantenida) ***
        
        // Función para abrir la nueva ventana con el historial de visitas del usuario
        window.openUserVisitHistory = async function(userId, userName) {
            const dbRef = db.ref('visitLog').orderByChild('userId').equalTo(userId);
            const snapshot = await dbRef.once('value');
            const logData = snapshot.val();
            
            let htmlContent = '';
            
            if (!logData) {
                htmlContent = `<h2 style="color: #dc3545;">Sin registros de visitas para ${userName}</h2>`;
            } else {
                const logEntries = Object.entries(logData)
                    .map(([key, entry]) => ({ id: key, ...entry }))
                    .sort((a, b) => b.timestamp - a.timestamp); // Ordenar por más reciente primero
                
                let tableRows = '';
                logEntries.forEach(entry => {
                    const date = new Date(entry.timestamp);
                    const dateTimeText = date.toLocaleString('es-ES', { 
                        day: '2-digit', month: '2-digit', year: 'numeric', 
                        hour: '2-digit', minute: '2-digit', second: '2-digit' 
                    });
                    
                    // Mostrar la IP, que ya está almacenada
                    const ipAddress = entry.ip || 'No registrada'; 
                    
                    tableRows += `
                        <tr>
                            <td>${dateTimeText}</td>
                            <td>${ipAddress}</td>
                        </tr>
                    `;
                });
                
                htmlContent = `
                    <h2 style="font-size: 1.8rem; margin-bottom: 20px; color: #667eea;">Historial de Visitas de: ${userName}</h2>
                    <p style="font-size: 1.1rem; color: #ccc; margin-bottom: 15px;">Total de accesos: ${logEntries.length}</p>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="padding: 10px; text-align: left; background-color: #1a1a2e; color: #fff; width: 60%; border: 1px solid #444;">Fecha y Hora</th>
                                <th style="padding: 10px; text-align: left; background-color: #1a1a2e; color: #fff; width: 40%; border: 1px solid #444;">Dirección IP</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                `;
            }
            
            // Abrir una nueva ventana y escribir el contenido
            const newWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            if (newWindow) {
                newWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="es">
                    <head>
                        <title>Historial de Visitas - ${userName}</title>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <style>
                            body { font-family: sans-serif; background-color: #282844; color: #e9e9f0; padding: 20px; }
                            table { border: 1px solid #444; }
                            th, td { border: 1px solid #444; padding: 10px; }
                            tbody tr:nth-child(even) { background-color: #1a1a2e; }
                            tbody tr:hover { background-color: #3e3e58; }
                        </style>
                    </head>
                    <body>
                        ${htmlContent}
                    </body>
                    </html>
                `);
                newWindow.document.close();
            } else {
                alert("El navegador bloqueó la apertura de una nueva ventana. Por favor, revisa la configuración de pop-ups.");
            }
        }
        // *************************************************

        loadUsers();
    }
    
    // *** LÓGICA: REGISTRO GLOBAL DE VISITAS (Botón de "Registro Global de Visitas") ***
    async function renderFullGlobalLog() {
        const fullLogContainer = document.getElementById('full-log-container');
        fullLogContainer.innerHTML = '<p class="text-center" style="color:#ccc;">Cargando datos...</p>';
        try {
            const snapshot = await db.ref('visitLog').once('value');
            const logData = snapshot.val();
            
            if (!logData) {
                fullLogContainer.innerHTML = `<h3 style="color: #ccc; text-align: center;">No hay registros de visitas globales.</h3>`;
                return;
            }

            // Mapear y ordenar los datos por timestamp descendente
            const logEntries = Object.entries(logData)
                .map(([key, entry]) => ({ id: key, ...entry }))
                .sort((a, b) => b.timestamp - a.timestamp); // Más reciente primero

            let tableRows = '';
            logEntries.forEach(entry => {
                const date = new Date(entry.timestamp);
                const dateTimeText = date.toLocaleString('es-ES', { 
                    day: '2-digit', month: '2-digit', year: 'numeric', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit' 
                });
                
                const ipAddress = entry.ip || 'No registrada'; 
                
                tableRows += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #444; font-weight: 600;">${entry.userName || 'Usuario desconocido'}</td>
                        <td style="padding: 10px; border: 1px solid #444;">${dateTimeText}</td>
                        <td style="padding: 10px; border: 1px solid #444;">${ipAddress}</td>
                    </tr>
                `;
            });

            // Generar la tabla HTML
            let html = `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr>
                            <th style="padding: 10px; text-align: left; background-color: #1a1a2e; color: #fff; width: 30%; border: 1px solid #444;">Usuario</th>
                            <th style="padding: 10px; text-align: left; background-color: #1a1a2e; color: #fff; width: 45%; border: 1px solid #444;">Fecha y Hora</th>
                            <th style="padding: 10px; text-align: left; background-color: #1a1a2e; color: #fff; width: 25%; border: 1px solid #444;">Dirección IP</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;

            fullLogContainer.innerHTML = html;
        } catch (error) {
            fullLogContainer.innerHTML = `<p style="color: #dc3545; text-align: center;">Error al cargar el registro: ${error.message}</p>`;
        }
    }
    // *******************************************************************
</script>

</body>
</html>